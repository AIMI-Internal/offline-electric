<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="AIMI Engineering Team" />
  <meta name="dcterms.date" content="2025-12-25" />
  <title>ElectricSQL Local-First Sync Strategy</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {  background-color: #f8f8f8; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ef2929; } /* Alert */
    code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #204a87; } /* Attribute */
    code span.bn { color: #0000cf; } /* BaseN */
    code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4e9a06; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #8f5902; font-style: italic; } /* Comment */
    code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
    code span.dt { color: #204a87; } /* DataType */
    code span.dv { color: #0000cf; } /* DecVal */
    code span.er { color: #a40000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #0000cf; } /* Float */
    code span.fu { color: #204a87; font-weight: bold; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
    code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
    code span.ot { color: #8f5902; } /* Other */
    code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
    code span.sc { color: #ce5c00; font-weight: bold; } /* SpecialChar */
    code span.ss { color: #4e9a06; } /* SpecialString */
    code span.st { color: #4e9a06; } /* String */
    code span.va { color: #000000; } /* Variable */
    code span.vs { color: #4e9a06; } /* VerbatimString */
    code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="" />
  <style>
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 900px; margin: 40px auto; padding: 20px; line-height: 1.6; }
  h1 { color: #1a365d; border-bottom: 2px solid #3182ce; padding-bottom: 10px; }
  h2 { color: #2c5282; margin-top: 40px; }
  h3 { color: #2b6cb0; }
  pre { background: #1a202c; color: #e2e8f0; padding: 16px; border-radius: 8px; overflow-x: auto; }
  code { background: #edf2f7; padding: 2px 6px; border-radius: 4px; }
  pre code { background: transparent; padding: 0; }
  table { border-collapse: collapse; width: 100%; margin: 20px 0; }
  th, td { border: 1px solid #e2e8f0; padding: 10px; text-align: left; }
  th { background: #3182ce; color: white; }
  tr:nth-child(even) { background: #f7fafc; }
  blockquote { border-left: 4px solid #3182ce; margin: 20px 0; padding: 10px 20px; background: #ebf8ff; }
  #TOC { background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 40px; }
  #TOC ul { list-style-type: none; padding-left: 20px; }
  @media print { body { max-width: none; margin: 0; } }
  </style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">ElectricSQL Local-First Sync Strategy</h1>
<p class="subtitle">Complete Technical Report for app_barcode Module</p>
<p class="author">AIMI Engineering Team</p>
<p class="date">2025-12-25</p>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#executive-summary" id="toc-executive-summary">Executive
Summary</a>
<ul>
<li><a href="#electricsql-local-first-sync-untuk-app_barcode"
id="toc-electricsql-local-first-sync-untuk-app_barcode">ElectricSQL
Local-First Sync untuk app_barcode</a></li>
<li><a href="#problem-statement" id="toc-problem-statement">1. Problem
Statement</a>
<ul>
<li><a href="#current-pain-points" id="toc-current-pain-points">Current
Pain Points</a></li>
<li><a href="#business-impact" id="toc-business-impact">Business
Impact</a></li>
</ul></li>
<li><a href="#proposed-solution" id="toc-proposed-solution">2. Proposed
Solution</a>
<ul>
<li><a href="#electricsql-local-first-architecture"
id="toc-electricsql-local-first-architecture">ElectricSQL Local-First
Architecture</a></li>
</ul></li>
<li><a href="#why-electricsql" id="toc-why-electricsql">3. Why
ElectricSQL?</a>
<ul>
<li><a href="#comparison-matrix" id="toc-comparison-matrix">Comparison
Matrix</a></li>
<li><a href="#key-advantage-crdt" id="toc-key-advantage-crdt">Key
Advantage: CRDT</a></li>
</ul></li>
<li><a href="#high-level-architecture"
id="toc-high-level-architecture">4. High-Level Architecture</a></li>
<li><a href="#scope-of-implementation"
id="toc-scope-of-implementation">5. Scope of Implementation</a>
<ul>
<li><a href="#in-scope-phase-1" id="toc-in-scope-phase-1">In Scope
(Phase 1)</a></li>
<li><a href="#out-of-scope-phase-1" id="toc-out-of-scope-phase-1">Out of
Scope (Phase 1)</a></li>
</ul></li>
<li><a href="#success-metrics" id="toc-success-metrics">6. Success
Metrics</a>
<ul>
<li><a href="#technical-kpis" id="toc-technical-kpis">Technical
KPIs</a></li>
<li><a href="#business-kpis" id="toc-business-kpis">Business
KPIs</a></li>
</ul></li>
<li><a href="#risk-summary" id="toc-risk-summary">7. Risk
Summary</a></li>
<li><a href="#timeline-estimate" id="toc-timeline-estimate">8. Timeline
Estimate</a></li>
<li><a href="#recommendation" id="toc-recommendation">9.
Recommendation</a></li>
<li><a href="#next-steps" id="toc-next-steps">10. Next Steps</a></li>
</ul></li>
<li><a href="#system-architecture" id="toc-system-architecture">System
Architecture</a>
<ul>
<li><a href="#electricsql-local-first-sync"
id="toc-electricsql-local-first-sync">ElectricSQL Local-First
Sync</a></li>
<li><a href="#architecture-overview" id="toc-architecture-overview">1.
Architecture Overview</a>
<ul>
<li><a href="#high-level-system-design"
id="toc-high-level-system-design">1.1 High-Level System Design</a></li>
</ul></li>
<li><a href="#component-details" id="toc-component-details">2. Component
Details</a>
<ul>
<li><a href="#electric-sync-engine" id="toc-electric-sync-engine">2.1
Electric Sync Engine</a></li>
<li><a href="#client-architecture" id="toc-client-architecture">2.2
Client Architecture</a></li>
</ul></li>
<li><a href="#data-flow-diagrams" id="toc-data-flow-diagrams">3. Data
Flow Diagrams</a>
<ul>
<li><a href="#initial-sync-flow" id="toc-initial-sync-flow">3.1 Initial
Sync Flow</a></li>
<li><a href="#real-time-sync-flow" id="toc-real-time-sync-flow">3.2
Real-time Sync Flow</a></li>
<li><a href="#offline-online-sync-flow"
id="toc-offline-online-sync-flow">3.3 Offline → Online Sync
Flow</a></li>
</ul></li>
<li><a href="#shape-definitions" id="toc-shape-definitions">4. Shape
Definitions</a>
<ul>
<li><a href="#shape-strategy-per-multi-tenant"
id="toc-shape-strategy-per-multi-tenant">4.1 Shape Strategy per
Multi-Tenant</a></li>
<li><a href="#shape-subscription-lifecycle"
id="toc-shape-subscription-lifecycle">4.2 Shape Subscription
Lifecycle</a></li>
</ul></li>
<li><a href="#deployment-architecture"
id="toc-deployment-architecture">5. Deployment Architecture</a>
<ul>
<li><a href="#infrastructure-stack" id="toc-infrastructure-stack">5.1
Infrastructure Stack</a></li>
<li><a href="#docker-compose-development"
id="toc-docker-compose-development">5.2 Docker Compose
(Development)</a></li>
</ul></li>
<li><a href="#network-architecture" id="toc-network-architecture">6.
Network Architecture</a>
<ul>
<li><a href="#network-topology" id="toc-network-topology">6.1 Network
Topology</a></li>
</ul></li>
<li><a href="#monitoring-architecture"
id="toc-monitoring-architecture">7. Monitoring Architecture</a></li>
</ul></li>
<li><a href="#sync-algorithm" id="toc-sync-algorithm">Sync Algorithm</a>
<ul>
<li><a href="#electricsql-crdt-based-synchronization"
id="toc-electricsql-crdt-based-synchronization">ElectricSQL CRDT-Based
Synchronization</a></li>
<li><a href="#core-principles" id="toc-core-principles">1. Core
Principles</a></li>
<li><a href="#crdt-types-used" id="toc-crdt-types-used">2. CRDT Types
Used</a>
<ul>
<li><a href="#crdt-merge-example" id="toc-crdt-merge-example">CRDT Merge
Example</a></li>
</ul></li>
<li><a href="#sync-phases" id="toc-sync-phases">3. Sync Phases</a></li>
<li><a href="#batching-strategy" id="toc-batching-strategy">4. Batching
Strategy</a>
<ul>
<li><a href="#chunked-download" id="toc-chunked-download">Chunked
Download</a></li>
</ul></li>
<li><a href="#offline-queue" id="toc-offline-queue">5. Offline Queue</a>
<ul>
<li><a href="#queue-processing" id="toc-queue-processing">Queue
Processing</a></li>
</ul></li>
<li><a href="#conflict-resolution-rules"
id="toc-conflict-resolution-rules">6. Conflict Resolution Rules</a>
<ul>
<li><a href="#business-rule-barcode-pairing-conflict"
id="toc-business-rule-barcode-pairing-conflict">Business Rule: Barcode
Pairing Conflict</a></li>
</ul></li>
<li><a href="#integrity-check" id="toc-integrity-check">7. Integrity
Check</a></li>
<li><a href="#complexity-analysis" id="toc-complexity-analysis">8.
Complexity Analysis</a></li>
</ul></li>
<li><a href="#api-routing-design" id="toc-api-routing-design">API
Routing Design</a>
<ul>
<li><a href="#electricsql-fastapi-integration"
id="toc-electricsql-fastapi-integration">ElectricSQL + FastAPI
Integration</a></li>
<li><a href="#api-architecture-overview"
id="toc-api-architecture-overview">1. API Architecture Overview</a></li>
<li><a href="#endpoint-categories" id="toc-endpoint-categories">2.
Endpoint Categories</a>
<ul>
<li><a href="#authentication-endpoints"
id="toc-authentication-endpoints">2.1 Authentication Endpoints</a></li>
<li><a href="#electric-sync-endpoints"
id="toc-electric-sync-endpoints">2.2 Electric Sync Endpoints</a></li>
<li><a href="#business-logic-endpoints"
id="toc-business-logic-endpoints">2.3 Business Logic Endpoints</a></li>
<li><a href="#sync-status-endpoints" id="toc-sync-status-endpoints">2.4
Sync Status Endpoints</a></li>
</ul></li>
<li><a href="#shape-definitions-1" id="toc-shape-definitions-1">3. Shape
Definitions</a>
<ul>
<li><a href="#shape-vendor_master" id="toc-shape-vendor_master">3.1
Shape: vendor_master</a></li>
<li><a href="#shape-batch_data" id="toc-shape-batch_data">3.2 Shape:
batch_data</a></li>
<li><a href="#shape-pairing_logs" id="toc-shape-pairing_logs">3.3 Shape:
pairing_logs</a></li>
</ul></li>
<li><a href="#requestresponse-flow" id="toc-requestresponse-flow">4.
Request/Response Flow</a>
<ul>
<li><a href="#initial-sync-flow-1" id="toc-initial-sync-flow-1">4.1
Initial Sync Flow</a></li>
<li><a href="#barcode-scan-flow-online"
id="toc-barcode-scan-flow-online">4.2 Barcode Scan Flow
(Online)</a></li>
<li><a href="#offline-online-sync-flow-1"
id="toc-offline-online-sync-flow-1">4.3 Offline → Online Sync
Flow</a></li>
</ul></li>
<li><a href="#authentication-authorization"
id="toc-authentication-authorization">5. Authentication &amp;
Authorization</a>
<ul>
<li><a href="#jwt-token-structure" id="toc-jwt-token-structure">5.1 JWT
Token Structure</a></li>
<li><a href="#permission-model" id="toc-permission-model">5.2 Permission
Model</a></li>
<li><a href="#row-level-security" id="toc-row-level-security">5.3
Row-Level Security</a></li>
</ul></li>
<li><a href="#error-handling" id="toc-error-handling">6. Error
Handling</a>
<ul>
<li><a href="#error-response-format" id="toc-error-response-format">6.1
Error Response Format</a></li>
<li><a href="#error-codes" id="toc-error-codes">6.2 Error Codes</a></li>
</ul></li>
<li><a href="#rate-limiting" id="toc-rate-limiting">7. Rate
Limiting</a></li>
<li><a href="#websocket-protocol" id="toc-websocket-protocol">8.
WebSocket Protocol</a>
<ul>
<li><a href="#connection" id="toc-connection">8.1 Connection</a></li>
<li><a href="#message-types" id="toc-message-types">8.2 Message
Types</a></li>
</ul></li>
</ul></li>
<li><a href="#security-analysis" id="toc-security-analysis">Security
Analysis</a>
<ul>
<li><a href="#electricsql-local-first-security"
id="toc-electricsql-local-first-security">ElectricSQL Local-First
Security</a></li>
<li><a href="#security-overview" id="toc-security-overview">1. Security
Overview</a></li>
<li><a href="#threat-model" id="toc-threat-model">2. Threat Model</a>
<ul>
<li><a href="#stride-analysis" id="toc-stride-analysis">2.1 STRIDE
Analysis</a></li>
<li><a href="#attack-vectors" id="toc-attack-vectors">2.2 Attack
Vectors</a></li>
</ul></li>
<li><a href="#authentication-design" id="toc-authentication-design">3.
Authentication Design</a>
<ul>
<li><a href="#jwt-token-flow" id="toc-jwt-token-flow">3.1 JWT Token
Flow</a></li>
<li><a href="#jwt-payload" id="toc-jwt-payload">3.2 JWT Payload</a></li>
</ul></li>
<li><a href="#authorization-design" id="toc-authorization-design">4.
Authorization Design</a>
<ul>
<li><a href="#row-level-security-postgresql"
id="toc-row-level-security-postgresql">4.1 Row-Level Security
(PostgreSQL)</a></li>
<li><a href="#electric-shape-authorization"
id="toc-electric-shape-authorization">4.2 Electric Shape
Authorization</a></li>
</ul></li>
<li><a href="#data-encryption" id="toc-data-encryption">5. Data
Encryption</a>
<ul>
<li><a href="#encryption-at-rest" id="toc-encryption-at-rest">5.1
Encryption at Rest</a></li>
<li><a href="#encryption-in-transit" id="toc-encryption-in-transit">5.2
Encryption in Transit</a></li>
<li><a href="#field-level-encryption-optional"
id="toc-field-level-encryption-optional">5.3 Field-Level Encryption
(Optional)</a></li>
</ul></li>
<li><a href="#security-controls-matrix"
id="toc-security-controls-matrix">6. Security Controls Matrix</a></li>
<li><a href="#incident-response" id="toc-incident-response">7. Incident
Response</a>
<ul>
<li><a href="#security-incident-types"
id="toc-security-incident-types">7.1 Security Incident Types</a></li>
<li><a href="#remote-wipe-capability"
id="toc-remote-wipe-capability">7.2 Remote Wipe Capability</a></li>
</ul></li>
<li><a href="#compliance-considerations"
id="toc-compliance-considerations">8. Compliance Considerations</a></li>
<li><a href="#security-checklist" id="toc-security-checklist">9.
Security Checklist</a>
<ul>
<li><a href="#pre-production"
id="toc-pre-production">Pre-Production</a></li>
<li><a href="#ongoing" id="toc-ongoing">Ongoing</a></li>
</ul></li>
</ul></li>
<li><a href="#sla-reliability-design"
id="toc-sla-reliability-design">SLA &amp; Reliability Design</a>
<ul>
<li><a href="#uptime-architecture" id="toc-uptime-architecture">99.99%
Uptime Architecture</a></li>
<li><a href="#sla-targets" id="toc-sla-targets">1. SLA Targets</a></li>
<li><a href="#how-local-first-achieves-99.99"
id="toc-how-local-first-achieves-99.99">2. How Local-First Achieves
99.99%</a></li>
<li><a href="#failure-mode-analysis" id="toc-failure-mode-analysis">3.
Failure Mode Analysis</a>
<ul>
<li><a href="#failure-scenarios-mitigations"
id="toc-failure-scenarios-mitigations">3.1 Failure Scenarios &amp;
Mitigations</a></li>
<li><a href="#rtorpo-targets" id="toc-rtorpo-targets">3.2 RTO/RPO
Targets</a></li>
</ul></li>
<li><a href="#high-availability-architecture"
id="toc-high-availability-architecture">4. High Availability
Architecture</a>
<ul>
<li><a href="#server-side-ha" id="toc-server-side-ha">4.1 Server-Side
HA</a></li>
<li><a href="#client-side-resilience"
id="toc-client-side-resilience">4.2 Client-Side Resilience</a></li>
</ul></li>
<li><a href="#monitoring-alerting" id="toc-monitoring-alerting">5.
Monitoring &amp; Alerting</a>
<ul>
<li><a href="#health-metrics" id="toc-health-metrics">5.1 Health
Metrics</a></li>
<li><a href="#alerting-matrix" id="toc-alerting-matrix">5.2 Alerting
Matrix</a></li>
</ul></li>
<li><a href="#disaster-recovery" id="toc-disaster-recovery">6. Disaster
Recovery</a>
<ul>
<li><a href="#dr-strategy" id="toc-dr-strategy">6.1 DR Strategy</a></li>
<li><a href="#backup-strategy" id="toc-backup-strategy">6.2 Backup
Strategy</a></li>
</ul></li>
<li><a href="#capacity-planning" id="toc-capacity-planning">7. Capacity
Planning</a>
<ul>
<li><a href="#load-estimates" id="toc-load-estimates">7.1 Load
Estimates</a></li>
<li><a href="#infrastructure-sizing" id="toc-infrastructure-sizing">7.2
Infrastructure Sizing</a></li>
</ul></li>
<li><a href="#sla-dashboard-metrics" id="toc-sla-dashboard-metrics">8.
SLA Dashboard Metrics</a></li>
<li><a href="#reliability-checklist" id="toc-reliability-checklist">9.
Reliability Checklist</a>
<ul>
<li><a href="#pre-production-1"
id="toc-pre-production-1">Pre-Production</a></li>
<li><a href="#ongoing-1" id="toc-ongoing-1">Ongoing</a></li>
</ul></li>
</ul></li>
<li><a href="#blindspots-risk-analysis"
id="toc-blindspots-risk-analysis">Blindspots &amp; Risk Analysis</a>
<ul>
<li><a href="#edge-cases-risks-and-mitigation-strategies"
id="toc-edge-cases-risks-and-mitigation-strategies">Edge Cases, Risks,
and Mitigation Strategies</a></li>
<li><a href="#risk-overview" id="toc-risk-overview">1. Risk
Overview</a></li>
<li><a href="#technical-blindspots" id="toc-technical-blindspots">2.
Technical Blindspots</a>
<ul>
<li><a href="#clock-drift-issue" id="toc-clock-drift-issue">2.1 Clock
Drift Issue</a></li>
<li><a href="#storage-exhaustion" id="toc-storage-exhaustion">2.2
Storage Exhaustion</a></li>
<li><a href="#schema-migration" id="toc-schema-migration">2.3 Schema
Migration</a></li>
<li><a href="#conflict-flood" id="toc-conflict-flood">2.4 Conflict
Flood</a></li>
</ul></li>
<li><a href="#business-logic-blindspots"
id="toc-business-logic-blindspots">3. Business Logic Blindspots</a>
<ul>
<li><a href="#double-pairing-prevention"
id="toc-double-pairing-prevention">3.1 Double Pairing
Prevention</a></li>
<li><a href="#deleted-data-resurrection"
id="toc-deleted-data-resurrection">3.2 Deleted Data
Resurrection</a></li>
<li><a href="#stale-read-issues" id="toc-stale-read-issues">3.3 Stale
Read Issues</a></li>
</ul></li>
<li><a href="#operational-blindspots" id="toc-operational-blindspots">4.
Operational Blindspots</a>
<ul>
<li><a href="#long-offline-period" id="toc-long-offline-period">4.1 Long
Offline Period</a></li>
<li><a href="#electric-service-memory-leak"
id="toc-electric-service-memory-leak">4.2 Electric Service Memory
Leak</a></li>
</ul></li>
<li><a href="#user-experience-blindspots"
id="toc-user-experience-blindspots">5. User Experience Blindspots</a>
<ul>
<li><a href="#sync-progress-ux" id="toc-sync-progress-ux">5.1 Sync
Progress UX</a></li>
<li><a href="#conflict-notification" id="toc-conflict-notification">5.2
Conflict Notification</a></li>
</ul></li>
<li><a href="#risk-mitigation-summary"
id="toc-risk-mitigation-summary">6. Risk Mitigation Summary</a></li>
<li><a href="#recommended-pre-launch-checklist"
id="toc-recommended-pre-launch-checklist">7. Recommended Pre-Launch
Checklist</a>
<ul>
<li><a href="#critical-block-launch"
id="toc-critical-block-launch">Critical (Block Launch)</a></li>
<li><a href="#high-priority-launch-within-week"
id="toc-high-priority-launch-within-week">High Priority (Launch Within
Week)</a></li>
<li><a href="#nice-to-have" id="toc-nice-to-have">Nice to Have</a></li>
</ul></li>
</ul></li>
<li><a href="#user-analysis" id="toc-user-analysis">User Analysis</a>
<ul>
<li><a href="#impact-on-end-users-ux-considerations"
id="toc-impact-on-end-users-ux-considerations">Impact on End Users &amp;
UX Considerations</a></li>
<li><a href="#user-personas" id="toc-user-personas">1. User Personas</a>
<ul>
<li><a href="#primary-users" id="toc-primary-users">1.1 Primary
Users</a></li>
</ul></li>
<li><a href="#user-journey-before-vs-after"
id="toc-user-journey-before-vs-after">2. User Journey: Before vs
After</a>
<ul>
<li><a href="#current-state-online-only"
id="toc-current-state-online-only">2.1 Current State
(Online-Only)</a></li>
<li><a href="#future-state-local-first"
id="toc-future-state-local-first">2.2 Future State
(Local-First)</a></li>
</ul></li>
<li><a href="#ux-design-recommendations"
id="toc-ux-design-recommendations">3. UX Design Recommendations</a>
<ul>
<li><a href="#sync-status-indicator" id="toc-sync-status-indicator">3.1
Sync Status Indicator</a></li>
<li><a href="#offline-mode-banner" id="toc-offline-mode-banner">3.2
Offline Mode Banner</a></li>
<li><a href="#conflict-resolution-ui"
id="toc-conflict-resolution-ui">3.3 Conflict Resolution UI</a></li>
</ul></li>
<li><a href="#user-communication-plan"
id="toc-user-communication-plan">4. User Communication Plan</a>
<ul>
<li><a href="#training-materials" id="toc-training-materials">4.1
Training Materials</a></li>
<li><a href="#key-messages" id="toc-key-messages">4.2 Key
Messages</a></li>
</ul></li>
<li><a href="#user-feedback-mechanisms"
id="toc-user-feedback-mechanisms">5. User Feedback Mechanisms</a>
<ul>
<li><a href="#in-app-feedback" id="toc-in-app-feedback">5.1 In-App
Feedback</a></li>
<li><a href="#analytics-to-track" id="toc-analytics-to-track">5.2
Analytics to Track</a></li>
</ul></li>
<li><a href="#rollout-strategy" id="toc-rollout-strategy">6. Rollout
Strategy</a>
<ul>
<li><a href="#phased-rollout" id="toc-phased-rollout">6.1 Phased
Rollout</a></li>
<li><a href="#success-criteria-per-phase"
id="toc-success-criteria-per-phase">6.2 Success Criteria per
Phase</a></li>
</ul></li>
<li><a href="#support-considerations" id="toc-support-considerations">7.
Support Considerations</a>
<ul>
<li><a href="#new-support-scenarios" id="toc-new-support-scenarios">7.1
New Support Scenarios</a></li>
<li><a href="#support-tools-needed" id="toc-support-tools-needed">7.2
Support Tools Needed</a></li>
</ul></li>
<li><a href="#expected-outcomes" id="toc-expected-outcomes">8. Expected
Outcomes</a>
<ul>
<li><a href="#quantitative-benefits" id="toc-quantitative-benefits">8.1
Quantitative Benefits</a></li>
<li><a href="#qualitative-benefits" id="toc-qualitative-benefits">8.2
Qualitative Benefits</a></li>
</ul></li>
</ul></li>
<li><a href="#implementation-plan"
id="toc-implementation-plan">Implementation Plan</a>
<ul>
<li><a href="#phased-rollout-for-electricsql-local-first-sync"
id="toc-phased-rollout-for-electricsql-local-first-sync">Phased Rollout
for ElectricSQL Local-First Sync</a></li>
<li><a href="#project-timeline" id="toc-project-timeline">1. Project
Timeline</a></li>
<li><a href="#phase-1-foundation-week-1-2"
id="toc-phase-1-foundation-week-1-2">2. Phase 1: Foundation (Week
1-2)</a>
<ul>
<li><a href="#infrastructure-tasks" id="toc-infrastructure-tasks">2.1
Infrastructure Tasks</a></li>
<li><a href="#database-preparation" id="toc-database-preparation">2.2
Database Preparation</a></li>
<li><a href="#deliverables" id="toc-deliverables">2.3
Deliverables</a></li>
</ul></li>
<li><a href="#phase-2-core-sync-week-3-4"
id="toc-phase-2-core-sync-week-3-4">3. Phase 2: Core Sync (Week 3-4)</a>
<ul>
<li><a href="#backend-tasks" id="toc-backend-tasks">3.1 Backend
Tasks</a></li>
<li><a href="#shape-definitions-2" id="toc-shape-definitions-2">3.2
Shape Definitions</a></li>
<li><a href="#client-integration" id="toc-client-integration">3.3 Client
Integration</a></li>
<li><a href="#deliverables-1" id="toc-deliverables-1">3.4
Deliverables</a></li>
</ul></li>
<li><a href="#phase-3-offline-capability-week-5-6"
id="toc-phase-3-offline-capability-week-5-6">4. Phase 3: Offline
Capability (Week 5-6)</a>
<ul>
<li><a href="#offline-queue-1" id="toc-offline-queue-1">4.1 Offline
Queue</a></li>
<li><a href="#conflict-resolution" id="toc-conflict-resolution">4.2
Conflict Resolution</a></li>
<li><a href="#ui-components" id="toc-ui-components">4.3 UI
Components</a></li>
<li><a href="#deliverables-2" id="toc-deliverables-2">4.4
Deliverables</a></li>
</ul></li>
<li><a href="#phase-4-testing-hardening-week-7-8"
id="toc-phase-4-testing-hardening-week-7-8">5. Phase 4: Testing &amp;
Hardening (Week 7-8)</a>
<ul>
<li><a href="#load-testing" id="toc-load-testing">5.1 Load
Testing</a></li>
<li><a href="#chaos-engineering" id="toc-chaos-engineering">5.2 Chaos
Engineering</a></li>
<li><a href="#security-audit" id="toc-security-audit">5.3 Security
Audit</a></li>
<li><a href="#deliverables-3" id="toc-deliverables-3">5.4
Deliverables</a></li>
</ul></li>
<li><a href="#phase-5-rollout-week-9-12"
id="toc-phase-5-rollout-week-9-12">6. Phase 5: Rollout (Week 9-12)</a>
<ul>
<li><a href="#beta-testing-week-9-10"
id="toc-beta-testing-week-9-10">6.1 Beta Testing (Week 9-10)</a></li>
<li><a href="#training-week-11" id="toc-training-week-11">6.2 Training
(Week 11)</a></li>
<li><a href="#general-availability-week-12"
id="toc-general-availability-week-12">6.3 General Availability (Week
12)</a></li>
</ul></li>
<li><a href="#resource-requirements" id="toc-resource-requirements">7.
Resource Requirements</a>
<ul>
<li><a href="#team" id="toc-team">7.1 Team</a></li>
<li><a href="#infrastructure-cost" id="toc-infrastructure-cost">7.2
Infrastructure Cost</a></li>
</ul></li>
<li><a href="#risk-mitigation" id="toc-risk-mitigation">8. Risk
Mitigation</a></li>
<li><a href="#success-metrics-1" id="toc-success-metrics-1">9. Success
Metrics</a></li>
<li><a href="#checklist-for-go-live" id="toc-checklist-for-go-live">10.
Checklist for Go-Live</a>
<ul>
<li><a href="#technical-readiness"
id="toc-technical-readiness">Technical Readiness</a></li>
<li><a href="#business-readiness" id="toc-business-readiness">Business
Readiness</a></li>
</ul></li>
</ul></li>
<li><a href="#proof-of-concept" id="toc-proof-of-concept">Proof of
Concept</a>
<ul>
<li><a href="#electricsql-local-first-sync-demo"
id="toc-electricsql-local-first-sync-demo">ElectricSQL Local-First Sync
Demo</a></li>
<li><a href="#poc-objectives" id="toc-poc-objectives">1. POC
Objectives</a></li>
<li><a href="#poc-architecture" id="toc-poc-architecture">2. POC
Architecture</a></li>
<li><a href="#setup-instructions" id="toc-setup-instructions">3. Setup
Instructions</a>
<ul>
<li><a href="#docker-compose" id="toc-docker-compose">3.1 Docker
Compose</a></li>
<li><a href="#database-schema" id="toc-database-schema">3.2 Database
Schema</a></li>
<li><a href="#client-setup-react" id="toc-client-setup-react">3.3 Client
Setup (React)</a></li>
<li><a href="#client-code" id="toc-client-code">3.4 Client Code</a></li>
</ul></li>
<li><a href="#test-scenarios" id="toc-test-scenarios">4. Test
Scenarios</a>
<ul>
<li><a href="#initial-sync-test" id="toc-initial-sync-test">4.1 Initial
Sync Test</a></li>
<li><a href="#real-time-sync-test" id="toc-real-time-sync-test">4.2
Real-time Sync Test</a></li>
<li><a href="#offline-write-test" id="toc-offline-write-test">4.3
Offline Write Test</a></li>
<li><a href="#conflict-test" id="toc-conflict-test">4.4 Conflict
Test</a></li>
</ul></li>
<li><a href="#performance-benchmarks" id="toc-performance-benchmarks">5.
Performance Benchmarks</a>
<ul>
<li><a href="#sync-speed" id="toc-sync-speed">5.1 Sync Speed</a></li>
<li><a href="#latency" id="toc-latency">5.2 Latency</a></li>
</ul></li>
<li><a href="#run-poc" id="toc-run-poc">6. Run POC</a></li>
<li><a href="#poc-findings-template" id="toc-poc-findings-template">7.
POC Findings Template</a></li>
</ul></li>
<li><a href="#p2p-lan-sync" id="toc-p2p-lan-sync">P2P / LAN Sync</a>
<ul>
<li><a href="#device-to-device-synchronization-on-local-network"
id="toc-device-to-device-synchronization-on-local-network">Device-to-Device
Synchronization on Local Network</a></li>
<li><a href="#konsep-p2p-sync" id="toc-konsep-p2p-sync">1. Konsep P2P
Sync</a></li>
<li><a href="#use-cases" id="toc-use-cases">2. Use Cases</a>
<ul>
<li><a href="#warehouse-pairing-scenario"
id="toc-warehouse-pairing-scenario">2.1 Warehouse Pairing
Scenario</a></li>
<li><a href="#field-operations" id="toc-field-operations">2.2 Field
Operations</a></li>
</ul></li>
<li><a href="#technical-architecture" id="toc-technical-architecture">3.
Technical Architecture</a>
<ul>
<li><a href="#discovery-protocol" id="toc-discovery-protocol">3.1
Discovery Protocol</a></li>
<li><a href="#sync-protocol" id="toc-sync-protocol">3.2 Sync
Protocol</a></li>
<li><a href="#mesh-network" id="toc-mesh-network">3.3 Mesh
Network</a></li>
</ul></li>
<li><a href="#implementation-options" id="toc-implementation-options">4.
Implementation Options</a>
<ul>
<li><a href="#technology-stack" id="toc-technology-stack">4.1 Technology
Stack</a></li>
<li><a href="#y.js-based-implementation"
id="toc-y.js-based-implementation">4.2 Y.js Based
Implementation</a></li>
<li><a href="#webrtc-alternative" id="toc-webrtc-alternative">4.3 WebRTC
Alternative</a></li>
</ul></li>
<li><a href="#security-considerations"
id="toc-security-considerations">5. Security Considerations</a>
<ul>
<li><a href="#p2p-security-model" id="toc-p2p-security-model">5.1 P2P
Security Model</a></li>
</ul></li>
<li><a href="#hybrid-sync-flow" id="toc-hybrid-sync-flow">6. Hybrid Sync
Flow</a></li>
<li><a href="#uiux-for-p2p" id="toc-uiux-for-p2p">7. UI/UX for P2P</a>
<ul>
<li><a href="#p2p-status-indicator" id="toc-p2p-status-indicator">7.1
P2P Status Indicator</a></li>
<li><a href="#connection-flow" id="toc-connection-flow">7.2 Connection
Flow</a></li>
</ul></li>
<li><a href="#implementation-phases" id="toc-implementation-phases">8.
Implementation Phases</a></li>
<li><a href="#pros-cons" id="toc-pros-cons">9. Pros &amp; Cons</a>
<ul>
<li><a href="#advantages" id="toc-advantages">Advantages</a></li>
<li><a href="#disadvantages"
id="toc-disadvantages">Disadvantages</a></li>
</ul></li>
<li><a href="#recommendation-1" id="toc-recommendation-1">10.
Recommendation</a></li>
</ul></li>
</ul>
</nav>
<h1 id="executive-summary">Executive Summary</h1>
<h2 id="electricsql-local-first-sync-untuk-app_barcode">ElectricSQL
Local-First Sync untuk app_barcode</h2>
<hr />
<h2 id="problem-statement">1. Problem Statement</h2>
<h3 id="current-pain-points">Current Pain Points</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                    MASALAH SAAT INI                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ❌ Offline = Tidak bisa scan barcode                       │
│  ❌ Koneksi lambat = User frustasi                          │
│  ❌ Data besar = Load time lama                             │
│  ❌ Multi-device = Sync conflict                            │
│  ❌ Server down = Operasi berhenti total                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="business-impact">Business Impact</h3>
<table>
<thead>
<tr>
<th>Issue</th>
<th>Impact</th>
</tr>
</thead>
<tbody>
<tr>
<td>Downtime 1 jam</td>
<td>~Rp XXX juta lost productivity</td>
</tr>
<tr>
<td>Offline di gudang</td>
<td>Pairing barcode manual, error-prone</td>
</tr>
<tr>
<td>Slow sync</td>
<td>User bypass system, data inconsistent</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="proposed-solution">2. Proposed Solution</h2>
<h3 id="electricsql-local-first-architecture">ElectricSQL Local-First
Architecture</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                    SOLUSI: LOCAL-FIRST                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ✅ Offline = Full functionality (local SQLite)             │
│  ✅ Online = Auto-sync background                           │
│  ✅ Conflict = CRDT auto-resolve                            │
│  ✅ Large data = Shape-based partial sync                   │
│  ✅ Server down = Client tetap jalan                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="why-electricsql">3. Why ElectricSQL?</h2>
<h3 id="comparison-matrix">Comparison Matrix</h3>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 28%" />
<col style="width: 23%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr>
<th>Feature</th>
<th>ElectricSQL</th>
<th>PowerSync</th>
<th>Custom Sync</th>
</tr>
</thead>
<tbody>
<tr>
<td>PostgreSQL Native</td>
<td>✅ Yes</td>
<td>✅ Yes</td>
<td>⚠️ Manual</td>
</tr>
<tr>
<td>CRDT Conflict Resolution</td>
<td>✅ Built-in</td>
<td>❌ Last-write-wins</td>
<td>❌ Manual</td>
</tr>
<tr>
<td>Open Source</td>
<td>✅ Apache 2.0</td>
<td>⚠️ Partial</td>
<td>N/A</td>
</tr>
<tr>
<td>Partial Sync (Shapes)</td>
<td>✅ Yes</td>
<td>✅ Yes</td>
<td>⚠️ Manual</td>
</tr>
<tr>
<td>Real-time Updates</td>
<td>✅ WebSocket</td>
<td>✅ WebSocket</td>
<td>⚠️ Manual</td>
</tr>
<tr>
<td>Active Development</td>
<td>✅ Supabase backing</td>
<td>✅ Active</td>
<td>N/A</td>
</tr>
</tbody>
</table>
<h3 id="key-advantage-crdt">Key Advantage: CRDT</h3>
<p><strong>CRDT (Conflict-free Replicated Data Types)</strong>
memungkinkan: - Multiple users edit sama data offline - Auto-merge tanpa
conflict - Eventual consistency guaranteed</p>
<pre><code>User A (Offline): Scan barcode → Pair ke Parent X
User B (Offline): Scan barcode → Update note &quot;QC passed&quot;
                    ↓
             [Both go online]
                    ↓
        CRDT merges: Parent X + Note &quot;QC passed&quot;
              (No conflict, no data loss)</code></pre>
<hr />
<h2 id="high-level-architecture">4. High-Level Architecture</h2>
<pre><code>┌────────────────────────────────────────────────────────────────────┐
│                         ARCHITECTURE OVERVIEW                       │
├────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌─────────────┐          ┌──────────────────┐                    │
│   │ PostgreSQL  │◄────────►│ Electric Service │                    │
│   │ app_barcode │  WAL     │ (Sync Engine)    │                    │
│   │             │  Capture │                  │                    │
│   └─────────────┘          └────────┬─────────┘                    │
│                                     │                               │
│                                     │ WebSocket / HTTP              │
│                                     │                               │
│              ┌──────────────────────┼──────────────────────┐       │
│              │                      │                      │        │
│              ▼                      ▼                      ▼        │
│   ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐│
│   │ Mobile App      │    │ Desktop App     │    │ Web App         ││
│   │ (SQLite)        │    │ (SQLite)        │    │ (IndexedDB)     ││
│   │                 │    │                 │    │                 ││
│   │ Scanner A       │    │ Admin Console   │    │ Dashboard       ││
│   └─────────────────┘    └─────────────────┘    └─────────────────┘│
│                                                                     │
└────────────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="scope-of-implementation">5. Scope of Implementation</h2>
<h3 id="in-scope-phase-1">In Scope (Phase 1)</h3>
<table>
<thead>
<tr>
<th>Table</th>
<th>Priority</th>
<th>Reason</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>bc_batch</code></td>
<td>HIGH</td>
<td>Master data, small</td>
</tr>
<tr>
<td><code>bc_parent</code></td>
<td>HIGH</td>
<td>Container hierarchy</td>
</tr>
<tr>
<td><code>bc_barcode</code></td>
<td>CRITICAL</td>
<td>Core scanning data</td>
</tr>
<tr>
<td><code>bc_token</code></td>
<td>HIGH</td>
<td>Validation tokens</td>
</tr>
<tr>
<td><code>bc_mfg</code></td>
<td>MEDIUM</td>
<td>Manufacturing tracking</td>
</tr>
<tr>
<td><code>bc_pair_brcdxparent</code></td>
<td>MEDIUM</td>
<td>Pairing logs</td>
</tr>
</tbody>
</table>
<h3 id="out-of-scope-phase-1">Out of Scope (Phase 1)</h3>
<table>
<thead>
<tr>
<th>Table</th>
<th>Reason</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>bc_logs</code></td>
<td>Audit only, server-side</td>
</tr>
<tr>
<td><code>bc_downloads</code></td>
<td>File management, server-side</td>
</tr>
<tr>
<td>Views (<code>view_*</code>)</td>
<td>Computed on client</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="success-metrics">6. Success Metrics</h2>
<h3 id="technical-kpis">Technical KPIs</h3>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Target</th>
<th>Measurement</th>
</tr>
</thead>
<tbody>
<tr>
<td>Offline Capability</td>
<td>100% core features</td>
<td>Manual testing</td>
</tr>
<tr>
<td>Initial Sync Time</td>
<td>&lt; 30 seconds</td>
<td>P95 latency</td>
</tr>
<tr>
<td>Incremental Sync</td>
<td>&lt; 2 seconds</td>
<td>P95 latency</td>
</tr>
<tr>
<td>Conflict Resolution</td>
<td>99.9% auto-resolved</td>
<td>Conflict logs</td>
</tr>
<tr>
<td>Data Consistency</td>
<td>100% eventual</td>
<td>Checksum validation</td>
</tr>
</tbody>
</table>
<h3 id="business-kpis">Business KPIs</h3>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Target</th>
<th>Current</th>
</tr>
</thead>
<tbody>
<tr>
<td>Scan Success Rate</td>
<td>99.9%</td>
<td>TBD</td>
</tr>
<tr>
<td>User Productivity</td>
<td>+20%</td>
<td>Baseline TBD</td>
</tr>
<tr>
<td>Support Tickets (sync issues)</td>
<td>-50%</td>
<td>Baseline TBD</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="risk-summary">7. Risk Summary</h2>
<table>
<thead>
<tr>
<th>Risk</th>
<th>Severity</th>
<th>Mitigation</th>
</tr>
</thead>
<tbody>
<tr>
<td>Data loss during sync</td>
<td>HIGH</td>
<td>CRDT + versioning + backup</td>
</tr>
<tr>
<td>Security breach</td>
<td>HIGH</td>
<td>E2E encryption + RLS</td>
</tr>
<tr>
<td>Performance degradation</td>
<td>MEDIUM</td>
<td>Batching + indexing</td>
</tr>
<tr>
<td>User adoption</td>
<td>MEDIUM</td>
<td>Training + gradual rollout</td>
</tr>
</tbody>
</table>
<p><em>Detail analisis di <a
href="./07_BLINDSPOTS.md">07_BLINDSPOTS.md</a></em></p>
<hr />
<h2 id="timeline-estimate">8. Timeline Estimate</h2>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                    IMPLEMENTATION TIMELINE                   │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  Week 1-2: Setup &amp; PoC                                       │
│  ├── Electric service deployment                             │
│  ├── Basic sync for bc_batch                                 │
│  └── Client SDK integration                                  │
│                                                              │
│  Week 3-4: Core Implementation                               │
│  ├── Full schema sync (bc_barcode, bc_parent, bc_token)     │
│  ├── Conflict resolution rules                               │
│  └── Offline testing                                         │
│                                                              │
│  Week 5-6: Security &amp; Optimization                           │
│  ├── Row-level security                                      │
│  ├── Performance tuning                                      │
│  └── Load testing                                            │
│                                                              │
│  Week 7-8: Rollout                                           │
│  ├── Beta testing (1 vendor)                                 │
│  ├── Monitoring &amp; fixes                                      │
│  └── Gradual rollout                                         │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="recommendation">9. Recommendation</h2>
<blockquote>
<p><strong>PROCEED</strong> dengan ElectricSQL implementation dengan
catatan:</p>
<ol type="1">
<li>✅ Start dengan PoC untuk 1 vendor</li>
<li>✅ Implement security layer first</li>
<li>✅ Setup monitoring sebelum production</li>
<li>⚠️ Plan rollback strategy</li>
<li>⚠️ Train users on offline behavior</li>
</ol>
</blockquote>
<hr />
<h2 id="next-steps">10. Next Steps</h2>
<ol type="1">
<li><strong>Immediate</strong>: Review <a
href="./02_ARCHITECTURE.md">Architecture</a> dan <a
href="./05_SECURITY.md">Security</a></li>
<li><strong>Week 1</strong>: Setup Electric service di staging</li>
<li><strong>Week 2</strong>: PoC dengan subset data</li>
<li><strong>Week 3+</strong>: Iterative implementation</li>
</ol>
<h1 id="system-architecture">System Architecture</h1>
<h2 id="electricsql-local-first-sync">ElectricSQL Local-First Sync</h2>
<hr />
<h2 id="architecture-overview">1. Architecture Overview</h2>
<h3 id="high-level-system-design">1.1 High-Level System Design</h3>
<pre><code>┌─────────────────────────────────────────────────────────────────────────────┐
│                           PRODUCTION ENVIRONMENT                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                         DATA LAYER                                   │    │
│  │  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐            │    │
│  │  │ PostgreSQL  │────►│ Electric    │────►│ Redis       │            │    │
│  │  │ Primary     │ WAL │ Sync Engine │     │ Cache       │            │    │
│  │  │             │     │             │     │             │            │    │
│  │  └──────┬──────┘     └──────┬──────┘     └─────────────┘            │    │
│  │         │                   │                                        │    │
│  │         ▼                   │                                        │    │
│  │  ┌─────────────┐           │                                        │    │
│  │  │ PostgreSQL  │           │                                        │    │
│  │  │ Replica     │           │                                        │    │
│  │  └─────────────┘           │                                        │    │
│  └────────────────────────────┼────────────────────────────────────────┘    │
│                               │                                              │
│  ┌────────────────────────────┼────────────────────────────────────────┐    │
│  │                         API LAYER                                    │    │
│  │                            │                                         │    │
│  │  ┌─────────────┐     ┌─────┴─────┐     ┌─────────────┐              │    │
│  │  │ FastAPI     │     │ Electric  │     │ Auth        │              │    │
│  │  │ Backend     │     │ Proxy     │     │ Service     │              │    │
│  │  │ (REST)      │     │ (WS/HTTP) │     │ (JWT)       │              │    │
│  │  └─────────────┘     └─────┬─────┘     └─────────────┘              │    │
│  └────────────────────────────┼────────────────────────────────────────┘    │
│                               │                                              │
│  ┌────────────────────────────┼────────────────────────────────────────┐    │
│  │                      DELIVERY LAYER                                  │    │
│  │                            │                                         │    │
│  │  ┌─────────────┐     ┌─────┴─────┐     ┌─────────────┐              │    │
│  │  │ CDN         │     │ Load      │     │ API         │              │    │
│  │  │ (Static)    │     │ Balancer  │     │ Gateway     │              │    │
│  │  └─────────────┘     └───────────┘     └─────────────┘              │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ Internet
                                    │
┌─────────────────────────────────────────────────────────────────────────────┐
│                              CLIENT LAYER                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐           │
│  │   MOBILE APP    │   │   DESKTOP APP   │   │    WEB APP      │           │
│  │  (React Native) │   │   (Electron)    │   │   (Vue/React)   │           │
│  │                 │   │                 │   │                 │           │
│  │  ┌───────────┐  │   │  ┌───────────┐  │   │  ┌───────────┐  │           │
│  │  │ Electric  │  │   │  │ Electric  │  │   │  │ Electric  │  │           │
│  │  │ Client    │  │   │  │ Client    │  │   │  │ Client    │  │           │
│  │  └─────┬─────┘  │   │  └─────┬─────┘  │   │  └─────┬─────┘  │           │
│  │        │        │   │        │        │   │        │        │           │
│  │  ┌─────┴─────┐  │   │  ┌─────┴─────┐  │   │  ┌─────┴─────┐  │           │
│  │  │ SQLite    │  │   │  │ SQLite    │  │   │  │ IndexedDB │  │           │
│  │  │ (Local)   │  │   │  │ (Local)   │  │   │  │ (Local)   │  │           │
│  │  └───────────┘  │   │  └───────────┘  │   │  └───────────┘  │           │
│  └─────────────────┘   └─────────────────┘   └─────────────────┘           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="component-details">2. Component Details</h2>
<h3 id="electric-sync-engine">2.1 Electric Sync Engine</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                    ELECTRIC SYNC ENGINE                      │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                  WAL CONSUMER                        │    │
│  │  • Reads PostgreSQL Write-Ahead Log                  │    │
│  │  • Captures INSERT, UPDATE, DELETE                   │    │
│  │  • Maintains replication slot                        │    │
│  └──────────────────────┬──────────────────────────────┘    │
│                         │                                    │
│                         ▼                                    │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                  SHAPE MANAGER                       │    │
│  │  • Defines data subsets for sync                     │    │
│  │  • Filters by vendor_code, batch_id                  │    │
│  │  • Manages shape subscriptions                       │    │
│  └──────────────────────┬──────────────────────────────┘    │
│                         │                                    │
│                         ▼                                    │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                  CRDT PROCESSOR                      │    │
│  │  • Converts SQL ops to CRDT operations               │    │
│  │  • Handles conflict detection                        │    │
│  │  • Generates merge operations                        │    │
│  └──────────────────────┬──────────────────────────────┘    │
│                         │                                    │
│                         ▼                                    │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                  SYNC DISPATCHER                     │    │
│  │  • WebSocket connections to clients                  │    │
│  │  • HTTP long-polling fallback                        │    │
│  │  • Batches and compresses payloads                   │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="client-architecture">2.2 Client Architecture</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                    CLIENT APPLICATION                        │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                  UI LAYER                            │    │
│  │  • Barcode Scanner Component                         │    │
│  │  • Batch Management UI                               │    │
│  │  • Sync Status Indicator                             │    │
│  └──────────────────────┬──────────────────────────────┘    │
│                         │                                    │
│                         ▼                                    │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                  SYNC LAYER                          │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │    │
│  │  │ Electric    │  │ Offline     │  │ Conflict    │  │    │
│  │  │ Client SDK  │  │ Queue       │  │ Resolver    │  │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  │    │
│  └──────────────────────┬──────────────────────────────┘    │
│                         │                                    │
│                         ▼                                    │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                  DATA LAYER                          │    │
│  │  ┌─────────────────────────────────────────────┐    │    │
│  │  │              LOCAL DATABASE                  │    │    │
│  │  │  • SQLite (Mobile/Desktop)                   │    │    │
│  │  │  • IndexedDB (Web)                           │    │    │
│  │  │  • Encrypted at rest                         │    │    │
│  │  └─────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="data-flow-diagrams">3. Data Flow Diagrams</h2>
<h3 id="initial-sync-flow">3.1 Initial Sync Flow</h3>
<pre><code>┌─────────────────────────────────────────────────────────────────────────┐
│                        INITIAL SYNC FLOW                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  CLIENT                    ELECTRIC                    POSTGRESQL        │
│    │                          │                            │             │
│    │  1. Connect + Auth       │                            │             │
│    │─────────────────────────►│                            │             │
│    │                          │                            │             │
│    │  2. Subscribe Shape      │                            │             │
│    │  (vendor_code=X)         │                            │             │
│    │─────────────────────────►│                            │             │
│    │                          │                            │             │
│    │                          │  3. Query Initial Data     │             │
│    │                          │───────────────────────────►│             │
│    │                          │                            │             │
│    │                          │  4. Return Rows (batched)  │             │
│    │                          │◄───────────────────────────│             │
│    │                          │                            │             │
│    │  5. Stream Data Chunks   │                            │             │
│    │◄─────────────────────────│                            │             │
│    │  (compressed, CRDT ops)  │                            │             │
│    │                          │                            │             │
│    │  6. Insert to Local DB   │                            │             │
│    │─────────┐                │                            │             │
│    │         │                │                            │             │
│    │◄────────┘                │                            │             │
│    │                          │                            │             │
│    │  7. Sync Complete        │                            │             │
│    │◄─────────────────────────│                            │             │
│    │                          │                            │             │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="real-time-sync-flow">3.2 Real-time Sync Flow</h3>
<pre><code>┌─────────────────────────────────────────────────────────────────────────┐
│                       REAL-TIME SYNC FLOW                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  POSTGRESQL                 ELECTRIC                    CLIENT           │
│    │                          │                            │             │
│    │  1. INSERT/UPDATE row    │                            │             │
│    │─────────────────────────►│                            │             │
│    │  (via FastAPI backend)   │ (WAL capture)              │             │
│    │                          │                            │             │
│    │                          │  2. Check Shape Match      │             │
│    │                          │─────────┐                  │             │
│    │                          │         │                  │             │
│    │                          │◄────────┘                  │             │
│    │                          │                            │             │
│    │                          │  3. Push to Subscribers    │             │
│    │                          │───────────────────────────►│             │
│    │                          │  (WebSocket, CRDT op)      │             │
│    │                          │                            │             │
│    │                          │                            │  4. Apply   │
│    │                          │                            │  to Local   │
│    │                          │                            │─────────┐   │
│    │                          │                            │         │   │
│    │                          │                            │◄────────┘   │
│    │                          │                            │             │
│    │                          │  5. ACK                    │             │
│    │                          │◄───────────────────────────│             │
│    │                          │                            │             │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="offline-online-sync-flow">3.3 Offline → Online Sync Flow</h3>
<pre><code>┌─────────────────────────────────────────────────────────────────────────┐
│                    OFFLINE → ONLINE SYNC FLOW                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ═══════════════════════ OFFLINE PHASE ═══════════════════════          │
│                                                                          │
│  CLIENT (Offline)                                                        │
│    │                                                                     │
│    │  1. User scans barcode                                              │
│    │─────────┐                                                           │
│    │         │                                                           │
│    │  2. Write to local SQLite                                           │
│    │         │  + Add to pending_ops queue                               │
│    │◄────────┘                                                           │
│    │                                                                     │
│    │  3. User continues working offline...                               │
│    │  (All ops queued locally)                                           │
│    │                                                                     │
│                                                                          │
│  ═══════════════════════ COMES ONLINE ═══════════════════════           │
│                                                                          │
│  CLIENT                    ELECTRIC                    POSTGRESQL        │
│    │                          │                            │             │
│    │  4. Reconnect            │                            │             │
│    │─────────────────────────►│                            │             │
│    │                          │                            │             │
│    │  5. Pull server changes  │                            │             │
│    │◄─────────────────────────│                            │             │
│    │  (CRDT ops since last)   │                            │             │
│    │                          │                            │             │
│    │  6. CRDT Merge           │                            │             │
│    │  (local + remote)        │                            │             │
│    │─────────┐                │                            │             │
│    │         │                │                            │             │
│    │◄────────┘                │                            │             │
│    │                          │                            │             │
│    │  7. Push pending ops     │                            │             │
│    │─────────────────────────►│                            │             │
│    │                          │                            │             │
│    │                          │  8. Write to PostgreSQL    │             │
│    │                          │───────────────────────────►│             │
│    │                          │                            │             │
│    │  9. Confirm sync         │                            │             │
│    │◄─────────────────────────│                            │             │
│    │                          │                            │             │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="shape-definitions">4. Shape Definitions</h2>
<h3 id="shape-strategy-per-multi-tenant">4.1 Shape Strategy per
Multi-Tenant</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                    SHAPE DEFINITIONS                         │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  SHAPE 1: Vendor Master Data                                 │
│  ─────────────────────────────                               │
│  Tables: bc_batch, bc_mfg, bc_config                         │
│  Filter: vendor_code = :current_vendor                       │
│  Sync: Always, Full                                          │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  Shape ID: vendor_master_{vendor_code}              │    │
│  │  WHERE: vendor_code = &#39;VENDOR001&#39;                   │    │
│  │         AND is_deleted = false                      │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  SHAPE 2: Active Batch Data                                  │
│  ──────────────────────────                                  │
│  Tables: bc_parent, bc_barcode, bc_token                     │
│  Filter: vendor_code + batch_id (active only)                │
│  Sync: On-demand per batch assignment                        │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  Shape ID: batch_data_{vendor_code}_{batch_id}      │    │
│  │  WHERE: vendor_code = &#39;VENDOR001&#39;                   │    │
│  │         AND batch_id = 123                          │    │
│  │         AND is_deleted = false                      │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  SHAPE 3: Recent Pairing Logs                                │
│  ────────────────────────────                                │
│  Tables: bc_pair_brcdxparent, bc_inbound_pairing             │
│  Filter: vendor_code + created_at (last 7 days)              │
│  Sync: Background, incremental                               │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  Shape ID: pairing_logs_{vendor_code}               │    │
│  │  WHERE: vendor_code = &#39;VENDOR001&#39;                   │    │
│  │         AND created_at &gt; now() - interval &#39;7 days&#39;  │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="shape-subscription-lifecycle">4.2 Shape Subscription
Lifecycle</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                SHAPE SUBSCRIPTION LIFECYCLE                  │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────┐     ┌──────────┐     ┌──────────┐             │
│  │  LOGIN   │────►│ SUBSCRIBE│────►│  ACTIVE  │             │
│  │          │     │  SHAPES  │     │          │             │
│  └──────────┘     └──────────┘     └─────┬────┘             │
│                                          │                   │
│                                          ▼                   │
│                              ┌───────────────────┐          │
│                              │                   │          │
│                              ▼                   │          │
│                   ┌──────────────────┐          │           │
│                   │  User switches   │          │           │
│                   │  to new batch    │          │           │
│                   └────────┬─────────┘          │           │
│                            │                     │           │
│                            ▼                     │           │
│                   ┌──────────────────┐          │           │
│                   │  Subscribe new   │          │           │
│                   │  batch shape     │          │           │
│                   └────────┬─────────┘          │           │
│                            │                     │           │
│                            └─────────────────────┘          │
│                                                              │
│  Note: Old shapes stay subscribed for quick switching        │
│        LRU eviction for memory management                    │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="deployment-architecture">5. Deployment Architecture</h2>
<h3 id="infrastructure-stack">5.1 Infrastructure Stack</h3>
<pre><code>┌─────────────────────────────────────────────────────────────────────────┐
│                       DEPLOYMENT ARCHITECTURE                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                        KUBERNETES CLUSTER                        │    │
│  │                                                                  │    │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │    │
│  │  │ Electric Pod    │  │ Electric Pod    │  │ Electric Pod    │  │    │
│  │  │ (Replica 1)     │  │ (Replica 2)     │  │ (Replica 3)     │  │    │
│  │  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘  │    │
│  │           │                    │                    │           │    │
│  │           └────────────────────┼────────────────────┘           │    │
│  │                                │                                 │    │
│  │                         ┌──────┴──────┐                         │    │
│  │                         │   Service   │                         │    │
│  │                         │ (ClusterIP) │                         │    │
│  │                         └──────┬──────┘                         │    │
│  │                                │                                 │    │
│  └────────────────────────────────┼────────────────────────────────┘    │
│                                   │                                      │
│  ┌────────────────────────────────┼────────────────────────────────┐    │
│  │                         LOAD BALANCER                            │    │
│  │  ┌─────────────────────────────────────────────────────────┐    │    │
│  │  │  • SSL Termination                                       │    │    │
│  │  │  • WebSocket Sticky Sessions                             │    │    │
│  │  │  • Health Checks                                         │    │    │
│  │  └─────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                        DATABASE LAYER                            │    │
│  │                                                                  │    │
│  │  ┌─────────────────┐              ┌─────────────────┐           │    │
│  │  │ PostgreSQL      │──────────────│ PostgreSQL      │           │    │
│  │  │ Primary         │  Streaming   │ Replica         │           │    │
│  │  │ (RDS/CloudSQL)  │  Replication │ (Read-only)     │           │    │
│  │  └─────────────────┘              └─────────────────┘           │    │
│  │                                                                  │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="docker-compose-development">5.2 Docker Compose
(Development)</h3>
<div class="sourceCode" id="cb15"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># docker-compose.electric.yaml</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="fu">version</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;3.8&#39;</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">postgres</span><span class="kw">:</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> postgres:16</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">POSTGRES_DB</span><span class="kw">:</span><span class="at"> barcode</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">POSTGRES_USER</span><span class="kw">:</span><span class="at"> electric</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">POSTGRES_PASSWORD</span><span class="kw">:</span><span class="at"> ${DB_PASSWORD}</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">command</span><span class="kw">:</span><span class="at"> </span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;postgres&quot;</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;-c&quot;</span><span class="at"> </span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;wal_level=logical&quot;</span><span class="co">  # Required for Electric</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> postgres_data:/var/lib/postgresql/data</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;5432:5432&quot;</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">electric</span><span class="kw">:</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> electricsql/electric:latest</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">DATABASE_URL</span><span class="kw">:</span><span class="at"> postgresql://electric:${DB_PASSWORD}@postgres:5432/barcode</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">ELECTRIC_WRITE_TO_PG_MODE</span><span class="kw">:</span><span class="at"> direct_writes</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">AUTH_MODE</span><span class="kw">:</span><span class="at"> secure</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">AUTH_JWT_KEY</span><span class="kw">:</span><span class="at"> ${JWT_SECRET}</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;5133:5133&quot;</span><span class="co">  # Electric HTTP API</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;5433:5433&quot;</span><span class="co">  # Electric Proxy (Postgres wire protocol)</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">depends_on</span><span class="kw">:</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> postgres</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">fastapi</span><span class="kw">:</span></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">build</span><span class="kw">:</span><span class="at"> ./backend</span></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">DATABASE_URL</span><span class="kw">:</span><span class="at"> postgresql://app:${DB_PASSWORD}@postgres:5432/barcode</span></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">ELECTRIC_URL</span><span class="kw">:</span><span class="at"> http://electric:5133</span></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;8000:8000&quot;</span></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">depends_on</span><span class="kw">:</span></span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> electric</span></span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">postgres_data</span><span class="kw">:</span></span></code></pre></div>
<hr />
<h2 id="network-architecture">6. Network Architecture</h2>
<h3 id="network-topology">6.1 Network Topology</h3>
<pre><code>┌─────────────────────────────────────────────────────────────────────────┐
│                         NETWORK TOPOLOGY                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│                           INTERNET                                       │
│                              │                                           │
│                              ▼                                           │
│  ┌───────────────────────────────────────────────────────────────┐      │
│  │                      CDN / WAF                                 │      │
│  │  • CloudFlare / AWS CloudFront                                 │      │
│  │  • DDoS protection                                             │      │
│  │  • SSL/TLS termination                                         │      │
│  └───────────────────────────────────────────────────────────────┘      │
│                              │                                           │
│                              ▼                                           │
│  ┌───────────────────────────────────────────────────────────────┐      │
│  │                    VPC / Private Network                       │      │
│  │                                                                │      │
│  │  Public Subnet                                                 │      │
│  │  ┌─────────────────────────────────────────────────────┐      │      │
│  │  │  Load Balancer (ALB/NLB)                            │      │      │
│  │  │  • /api/* → FastAPI                                 │      │      │
│  │  │  • /v1/shape/* → Electric                           │      │      │
│  │  │  • WebSocket → Electric (sticky session)            │      │      │
│  │  └─────────────────────────────────────────────────────┘      │      │
│  │                              │                                 │      │
│  │  Private Subnet              │                                 │      │
│  │  ┌───────────────────────────┼───────────────────────┐        │      │
│  │  │                           │                       │        │      │
│  │  │  ┌─────────┐       ┌──────┴──────┐      ┌───────┐│        │      │
│  │  │  │ FastAPI │       │  Electric   │      │ Redis ││        │      │
│  │  │  │ Pods    │       │  Pods       │      │       ││        │      │
│  │  │  └─────────┘       └─────────────┘      └───────┘│        │      │
│  │  │                                                   │        │      │
│  │  └───────────────────────────────────────────────────┘        │      │
│  │                              │                                 │      │
│  │  Database Subnet             │                                 │      │
│  │  ┌───────────────────────────┼───────────────────────┐        │      │
│  │  │                           │                       │        │      │
│  │  │  ┌─────────────┐    ┌─────┴─────┐                │        │      │
│  │  │  │ PostgreSQL  │    │ PostgreSQL│                │        │      │
│  │  │  │ Primary     │───►│ Replica   │                │        │      │
│  │  │  └─────────────┘    └───────────┘                │        │      │
│  │  │                                                   │        │      │
│  │  └───────────────────────────────────────────────────┘        │      │
│  │                                                                │      │
│  └────────────────────────────────────────────────────────────────┘      │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="monitoring-architecture">7. Monitoring Architecture</h2>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                    OBSERVABILITY STACK                       │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                    COLLECTION                        │    │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐             │    │
│  │  │ Metrics │  │ Logs    │  │ Traces  │             │    │
│  │  │ (Prom.) │  │ (Loki)  │  │ (Jaeger)│             │    │
│  │  └────┬────┘  └────┬────┘  └────┬────┘             │    │
│  └───────┼────────────┼────────────┼────────────────────┘    │
│          │            │            │                         │
│          ▼            ▼            ▼                         │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                    STORAGE                           │    │
│  │  ┌─────────────────────────────────────────────┐    │    │
│  │  │              Grafana Stack                   │    │    │
│  │  │  • Mimir (Metrics)                          │    │    │
│  │  │  • Loki (Logs)                              │    │    │
│  │  │  • Tempo (Traces)                           │    │    │
│  │  └─────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────┘    │
│                         │                                    │
│                         ▼                                    │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                  VISUALIZATION                       │    │
│  │  ┌─────────────────────────────────────────────┐    │    │
│  │  │              Grafana Dashboards              │    │    │
│  │  │  • Sync Performance                          │    │    │
│  │  │  • Error Rates                               │    │    │
│  │  │  • Client Connections                        │    │    │
│  │  │  • Database Health                           │    │    │
│  │  └─────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────┘    │
│                         │                                    │
│                         ▼                                    │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                    ALERTING                          │    │
│  │  • PagerDuty / OpsGenie                              │    │
│  │  • Slack / Telegram notifications                    │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<h1 id="sync-algorithm">Sync Algorithm</h1>
<h2 id="electricsql-crdt-based-synchronization">ElectricSQL CRDT-Based
Synchronization</h2>
<hr />
<h2 id="core-principles">1. Core Principles</h2>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                    SYNC ALGORITHM PRINCIPLES                 │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  1. LOCAL-FIRST: All reads/writes go to local DB first      │
│  2. EVENTUAL CONSISTENCY: All replicas converge             │
│  3. CONFLICT-FREE: CRDT auto-merge, no manual resolution    │
│  4. PARTIAL REPLICATION: Only sync what user needs          │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="crdt-types-used">2. CRDT Types Used</h2>
<table>
<thead>
<tr>
<th>Field Type</th>
<th>CRDT</th>
<th>Resolution</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>note</code>, <code>status</code></td>
<td>LWW-Register</td>
<td>Latest timestamp wins</td>
</tr>
<tr>
<td><code>is_deleted</code>, <code>is_archived</code></td>
<td>Flag (OR)</td>
<td>True always wins</td>
</tr>
<tr>
<td>Pairing logs</td>
<td>OR-Set</td>
<td>All pairings kept, deduped</td>
</tr>
<tr>
<td>Counters</td>
<td>G-Counter</td>
<td>Sum all increments</td>
</tr>
</tbody>
</table>
<h3 id="crdt-merge-example">CRDT Merge Example</h3>
<pre><code>Device A (Offline): barcode.note = &quot;QC OK&quot; @ T1
Device B (Offline): barcode.parent_id = 500 @ T2

[Both come online → CRDT Merge]

Result: { note: &quot;QC OK&quot;, parent_id: 500 }
✅ Both changes preserved, no conflict!</code></pre>
<hr />
<h2 id="sync-phases">3. Sync Phases</h2>
<pre><code>PHASE 1: BOOTSTRAP (First-time)
├── Authenticate → Get JWT
├── Subscribe vendor_master shape
├── Download bc_batch, bc_config
├── For each assigned batch:
│   └── Subscribe batch_data shape
└── Mark bootstrap complete

PHASE 2: REAL-TIME (Continuous)
├── WebSocket receives CRDT op from Electric
├── Apply to local SQLite
├── Update UI reactively
└── Send ACK

PHASE 3: PUSH (Local → Server)
├── Write to local SQLite (immediate)
├── Queue CRDT operation
├── If online: Push immediately
└── If offline: Queue for later

PHASE 4: CATCHUP (After offline)
├── Get server checkpoint
├── Fetch ops since local checkpoint
├── CRDT merge with local
└── Push pending ops</code></pre>
<hr />
<h2 id="batching-strategy">4. Batching Strategy</h2>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 19%" />
<col style="width: 19%" />
<col style="width: 41%" />
</colgroup>
<thead>
<tr>
<th>Tier</th>
<th>Data</th>
<th>Rows</th>
<th>Sync Timing</th>
</tr>
</thead>
<tbody>
<tr>
<td>CRITICAL</td>
<td>bc_config, bc_batch (active)</td>
<td>~1K</td>
<td>Always, on app start</td>
</tr>
<tr>
<td>WORKING SET</td>
<td>bc_parent, bc_barcode per batch</td>
<td>~21K/batch</td>
<td>On-demand</td>
</tr>
<tr>
<td>HISTORICAL</td>
<td>Completed batches</td>
<td>Variable</td>
<td>Background, low priority</td>
</tr>
<tr>
<td>NEVER SYNC</td>
<td>bc_logs, views</td>
<td>N/A</td>
<td>Server-only</td>
</tr>
</tbody>
</table>
<h3 id="chunked-download">Chunked Download</h3>
<pre><code>CHUNK_SIZE = 10000 rows
MAX_CONCURRENT = 3 chunks

FOR each chunk:
  1. Fetch chunk from Electric
  2. Write to SQLite in transaction
  3. Emit progress update</code></pre>
<hr />
<h2 id="offline-queue">5. Offline Queue</h2>
<div class="sourceCode" id="cb22"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> pending_operations (</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">id</span> <span class="dt">INTEGER</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  operation_type TEXT,</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  table_name TEXT,</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  row_id <span class="dt">INTEGER</span>,</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  crdt_operation <span class="dt">BLOB</span>,</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  created_at <span class="dt">TIMESTAMP</span>,</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  retry_count <span class="dt">INTEGER</span> <span class="kw">DEFAULT</span> <span class="dv">0</span>,</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  status TEXT <span class="kw">DEFAULT</span> <span class="st">&#39;pending&#39;</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<h3 id="queue-processing">Queue Processing</h3>
<pre><code>FUNCTION process_pending_queue():
  pending = SELECT * FROM pending_operations WHERE status=&#39;pending&#39;
  
  FOR op IN pending:
    TRY:
      electric.push(op.crdt_operation)
      DELETE op
    CATCH NetworkError:
      BREAK  // Stop, still offline
    CATCH Error:
      IF retry_count &gt;= 5:
        status = &#39;failed&#39;
      ELSE:
        retry_count += 1</code></pre>
<hr />
<h2 id="conflict-resolution-rules">6. Conflict Resolution Rules</h2>
<table>
<thead>
<tr>
<th>Table</th>
<th>Field</th>
<th>Rule</th>
</tr>
</thead>
<tbody>
<tr>
<td>bc_barcode</td>
<td>parent_id</td>
<td>First-write-wins (one barcode = one parent)</td>
</tr>
<tr>
<td>bc_barcode</td>
<td>note</td>
<td>Last-write-wins</td>
</tr>
<tr>
<td>bc_barcode</td>
<td>is_deleted</td>
<td>True always wins</td>
</tr>
<tr>
<td>bc_pair_*</td>
<td>(row)</td>
<td>OR-Set, keep all unique pairings</td>
</tr>
</tbody>
</table>
<h3 id="business-rule-barcode-pairing-conflict">Business Rule: Barcode
Pairing Conflict</h3>
<pre><code>IF concurrent pairing to different parents:
  1. Keep FIRST pairing (earlier timestamp)
  2. Reject second pairing
  3. Notify user of rejection</code></pre>
<hr />
<h2 id="integrity-check">7. Integrity Check</h2>
<pre><code>FUNCTION integrity_check(vendor_code):
  local = COUNT(*), SUM(id), MAX(updated_at) FROM bc_barcode
  server = electric.get_checksum(bc_barcode, vendor_code)
  
  IF local != server:
    force_resync(vendor_code)
    
Schedule: Every 6 hours when on WiFi</code></pre>
<hr />
<h2 id="complexity-analysis">8. Complexity Analysis</h2>
<table>
<thead>
<tr>
<th>Operation</th>
<th>Time</th>
<th>Space</th>
</tr>
</thead>
<tbody>
<tr>
<td>Initial sync</td>
<td>O(N/C)</td>
<td>O(C) per chunk</td>
</tr>
<tr>
<td>Incremental sync</td>
<td>O(Δ)</td>
<td>O(Δ)</td>
</tr>
<tr>
<td>Single write</td>
<td>O(1)</td>
<td>O(1)</td>
</tr>
<tr>
<td>CRDT merge</td>
<td>O(1)</td>
<td>O(1)</td>
</tr>
</tbody>
</table>
<p><strong>Key insight</strong>: Incremental sync is proportional to
CHANGES, not total data.</p>
<h1 id="api-routing-design">API Routing Design</h1>
<h2 id="electricsql-fastapi-integration">ElectricSQL + FastAPI
Integration</h2>
<hr />
<h2 id="api-architecture-overview">1. API Architecture Overview</h2>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                    API LAYER ARCHITECTURE                    │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  CLIENT                                                      │
│    │                                                         │
│    ├─────► /api/* ─────► FastAPI Backend ─────► PostgreSQL   │
│    │       (Business Logic, Validation)                      │
│    │                                                         │
│    └─────► /v1/shape/* ─────► Electric ─────► PostgreSQL     │
│            (Sync Operations via WebSocket/HTTP)              │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="endpoint-categories">2. Endpoint Categories</h2>
<h3 id="authentication-endpoints">2.1 Authentication Endpoints</h3>
<table>
<thead>
<tr>
<th>Method</th>
<th>Path</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>POST</td>
<td><code>/api/auth/login</code></td>
<td>Login, returns JWT</td>
</tr>
<tr>
<td>POST</td>
<td><code>/api/auth/refresh</code></td>
<td>Refresh JWT token</td>
</tr>
<tr>
<td>POST</td>
<td><code>/api/auth/logout</code></td>
<td>Invalidate token</td>
</tr>
<tr>
<td>GET</td>
<td><code>/api/auth/me</code></td>
<td>Get current user info</td>
</tr>
</tbody>
</table>
<h3 id="electric-sync-endpoints">2.2 Electric Sync Endpoints</h3>
<table>
<thead>
<tr>
<th>Method</th>
<th>Path</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td><code>/v1/shape</code></td>
<td>Get shape definition</td>
</tr>
<tr>
<td>GET</td>
<td><code>/v1/shape/{shape_id}</code></td>
<td>Subscribe to shape (SSE/WS)</td>
</tr>
<tr>
<td>POST</td>
<td><code>/v1/shape/{shape_id}/sync</code></td>
<td>Initial sync for shape</td>
</tr>
<tr>
<td>WS</td>
<td><code>/v1/shape/{shape_id}/live</code></td>
<td>Real-time sync WebSocket</td>
</tr>
</tbody>
</table>
<h3 id="business-logic-endpoints">2.3 Business Logic Endpoints</h3>
<table>
<thead>
<tr>
<th>Method</th>
<th>Path</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>POST</td>
<td><code>/api/barcode/scan</code></td>
<td>Validate &amp; process barcode scan</td>
</tr>
<tr>
<td>POST</td>
<td><code>/api/barcode/pair</code></td>
<td>Pair barcode to parent</td>
</tr>
<tr>
<td>GET</td>
<td><code>/api/batch/{id}</code></td>
<td>Get batch details</td>
</tr>
<tr>
<td>POST</td>
<td><code>/api/batch/{id}/activate</code></td>
<td>Activate batch</td>
</tr>
</tbody>
</table>
<h3 id="sync-status-endpoints">2.4 Sync Status Endpoints</h3>
<table>
<thead>
<tr>
<th>Method</th>
<th>Path</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td><code>/api/sync/status</code></td>
<td>Get sync status</td>
</tr>
<tr>
<td>POST</td>
<td><code>/api/sync/force</code></td>
<td>Force full resync</td>
</tr>
<tr>
<td>GET</td>
<td><code>/api/sync/pending</code></td>
<td>Get pending operations count</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="shape-definitions-1">3. Shape Definitions</h2>
<h3 id="shape-vendor_master">3.1 Shape: vendor_master</h3>
<div class="sourceCode" id="cb27"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Subscription URL: /v1/shape/vendor_master?vendor_code=ABC</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">shape</span><span class="kw">:</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> vendor_master</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">tables</span><span class="kw">:</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> bc_batch</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> bc_config</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> bc_mfg</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">params</span><span class="kw">:</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> vendor_code</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="fu">  where</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    vendor_code = :vendor_code </span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    AND is_deleted = false</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">permissions</span><span class="kw">:</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">read</span><span class="kw">:</span><span class="at"> vendor_member</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">write</span><span class="kw">:</span><span class="at"> vendor_admin</span></span></code></pre></div>
<h3 id="shape-batch_data">3.2 Shape: batch_data</h3>
<div class="sourceCode" id="cb28"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Subscription URL: /v1/shape/batch_data?batch_id=123</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">shape</span><span class="kw">:</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> batch_data</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">tables</span><span class="kw">:</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> bc_parent</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> bc_barcode</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> bc_token</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">params</span><span class="kw">:</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> batch_id</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="fu">  where</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    batch_id = :batch_id </span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    AND is_deleted = false</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">permissions</span><span class="kw">:</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">read</span><span class="kw">:</span><span class="at"> batch_assigned</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">write</span><span class="kw">:</span><span class="at"> batch_operator</span></span></code></pre></div>
<h3 id="shape-pairing_logs">3.3 Shape: pairing_logs</h3>
<div class="sourceCode" id="cb29"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Subscription URL: /v1/shape/pairing_logs?vendor_code=ABC</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">shape</span><span class="kw">:</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> pairing_logs</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">tables</span><span class="kw">:</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> bc_pair_brcdxparent</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> bc_inbound_pairing</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">params</span><span class="kw">:</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> vendor_code</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="fu">  where</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    vendor_code = :vendor_code </span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    AND created_at &gt; now() - interval &#39;7 days&#39;</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">permissions</span><span class="kw">:</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">read</span><span class="kw">:</span><span class="at"> vendor_member</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">write</span><span class="kw">:</span><span class="at"> batch_operator</span></span></code></pre></div>
<hr />
<h2 id="requestresponse-flow">4. Request/Response Flow</h2>
<h3 id="initial-sync-flow-1">4.1 Initial Sync Flow</h3>
<pre><code>Client                    API Gateway              Electric              PostgreSQL
  │                           │                       │                      │
  │ 1. POST /api/auth/login   │                       │                      │
  │──────────────────────────►│                       │                      │
  │                           │ validate credentials  │                      │
  │                           │──────────────────────────────────────────────►│
  │                           │                       │                      │
  │ ◄──────────────────────── │ JWT token             │                      │
  │                           │                       │                      │
  │ 2. GET /v1/shape/vendor_master?vendor_code=ABC    │                      │
  │──────────────────────────►│──────────────────────►│                      │
  │                           │                       │ query shape data     │
  │                           │                       │─────────────────────►│
  │                           │                       │                      │
  │ ◄─────────────────────────────────────────────────│ stream data chunks   │
  │ (chunked response)        │                       │                      │
  │                           │                       │                      │
  │ 3. WS /v1/shape/vendor_master/live                │                      │
  │──────────────────────────►│──────────────────────►│                      │
  │ ◄═════════════════════════════════════════════════│ WebSocket connected  │
  │ (real-time updates)       │                       │                      │</code></pre>
<h3 id="barcode-scan-flow-online">4.2 Barcode Scan Flow (Online)</h3>
<pre><code>Client                    FastAPI                  Electric              PostgreSQL
  │                           │                       │                      │
  │ 1. Scan barcode locally   │                       │                      │
  │ (write to SQLite)         │                       │                      │
  │                           │                       │                      │
  │ 2. POST /api/barcode/scan │                       │                      │
  │ {barcode: &quot;ABC123&quot;}       │                       │                      │
  │──────────────────────────►│                       │                      │
  │                           │ validate barcode      │                      │
  │                           │──────────────────────────────────────────────►│
  │                           │                       │                      │
  │                           │ log to bc_logs        │                      │
  │                           │──────────────────────────────────────────────►│
  │                           │                       │                      │
  │                           │                       │ WAL trigger          │
  │                           │                       │◄─────────────────────│
  │                           │                       │                      │
  │ ◄──────────────────────── │ validation result     │                      │
  │                           │                       │                      │
  │ ◄═════════════════════════════════════════════════│ sync update to other │
  │ (WebSocket update)        │                       │ devices              │</code></pre>
<h3 id="offline-online-sync-flow-1">4.3 Offline → Online Sync Flow</h3>
<pre><code>Client (comes online)     FastAPI                  Electric              PostgreSQL
  │                           │                       │                      │
  │ 1. GET /v1/shape/batch_data?since=&lt;checkpoint&gt;    │                      │
  │──────────────────────────►│──────────────────────►│                      │
  │                           │                       │ fetch deltas         │
  │                           │                       │─────────────────────►│
  │                           │                       │                      │
  │ ◄─────────────────────────────────────────────────│ return changes       │
  │                           │                       │                      │
  │ (CRDT merge locally)      │                       │                      │
  │                           │                       │                      │
  │ 2. POST /v1/shape/batch_data/write                │                      │
  │ {operations: [...]}       │                       │                      │
  │──────────────────────────►│──────────────────────►│                      │
  │                           │                       │ apply CRDT ops       │
  │                           │                       │─────────────────────►│
  │                           │                       │                      │
  │ ◄─────────────────────────────────────────────────│ confirm              │</code></pre>
<hr />
<h2 id="authentication-authorization">5. Authentication &amp;
Authorization</h2>
<h3 id="jwt-token-structure">5.1 JWT Token Structure</h3>
<div class="sourceCode" id="cb33"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;sub&quot;</span><span class="fu">:</span> <span class="st">&quot;user_123&quot;</span><span class="fu">,</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;vendor_code&quot;</span><span class="fu">:</span> <span class="st">&quot;ABC&quot;</span><span class="fu">,</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;roles&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;operator&quot;</span><span class="ot">,</span> <span class="st">&quot;viewer&quot;</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;assigned_batches&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="dv">1</span><span class="ot">,</span> <span class="dv">2</span><span class="ot">,</span> <span class="dv">3</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;exp&quot;</span><span class="fu">:</span> <span class="dv">1735200000</span><span class="fu">,</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;iat&quot;</span><span class="fu">:</span> <span class="dv">1735113600</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h3 id="permission-model">5.2 Permission Model</h3>
<table>
<thead>
<tr>
<th>Role</th>
<th>Shape Access</th>
<th>Write Access</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>viewer</code></td>
<td>vendor_master (read)</td>
<td>None</td>
</tr>
<tr>
<td><code>operator</code></td>
<td>batch_data (read/write)</td>
<td>bc_barcode, bc_pair_*</td>
</tr>
<tr>
<td><code>admin</code></td>
<td>All shapes</td>
<td>All tables</td>
</tr>
</tbody>
</table>
<h3 id="row-level-security">5.3 Row-Level Security</h3>
<div class="sourceCode" id="cb34"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Electric applies these filters automatically</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="co">-- Users can only see data for their vendor_code</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>POLICY vendor_isolation <span class="kw">ON</span> bc_barcode</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">USING</span> (vendor_code <span class="op">=</span> current_setting(<span class="st">&#39;app.vendor_code&#39;</span>));</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>POLICY batch_assignment <span class="kw">ON</span> bc_barcode</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">USING</span> (batch_id <span class="kw">IN</span> (</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> batch_id <span class="kw">FROM</span> user_batch_assignments </span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> user_id <span class="op">=</span> current_setting(<span class="st">&#39;app.user_id&#39;</span>)</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>  ));</span></code></pre></div>
<hr />
<h2 id="error-handling">6. Error Handling</h2>
<h3 id="error-response-format">6.1 Error Response Format</h3>
<div class="sourceCode" id="cb35"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;error&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;code&quot;</span><span class="fu">:</span> <span class="st">&quot;SYNC_CONFLICT&quot;</span><span class="fu">,</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;message&quot;</span><span class="fu">:</span> <span class="st">&quot;Barcode already paired to different parent&quot;</span><span class="fu">,</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;details&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;barcode_id&quot;</span><span class="fu">:</span> <span class="dv">12345</span><span class="fu">,</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;current_parent&quot;</span><span class="fu">:</span> <span class="dv">500</span><span class="fu">,</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;attempted_parent&quot;</span><span class="fu">:</span> <span class="dv">600</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">},</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;retry_after&quot;</span><span class="fu">:</span> <span class="kw">null</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h3 id="error-codes">6.2 Error Codes</h3>
<table>
<thead>
<tr>
<th>Code</th>
<th>HTTP</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AUTH_EXPIRED</code></td>
<td>401</td>
<td>Token expired, refresh needed</td>
</tr>
<tr>
<td><code>AUTH_INVALID</code></td>
<td>401</td>
<td>Invalid token</td>
</tr>
<tr>
<td><code>PERMISSION_DENIED</code></td>
<td>403</td>
<td>No access to resource</td>
</tr>
<tr>
<td><code>SYNC_CONFLICT</code></td>
<td>409</td>
<td>CRDT conflict (manual resolution needed)</td>
</tr>
<tr>
<td><code>SHAPE_NOT_FOUND</code></td>
<td>404</td>
<td>Shape definition not found</td>
</tr>
<tr>
<td><code>RATE_LIMITED</code></td>
<td>429</td>
<td>Too many requests</td>
</tr>
<tr>
<td><code>SYNC_OUTDATED</code></td>
<td>410</td>
<td>Shape version outdated, resync needed</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="rate-limiting">7. Rate Limiting</h2>
<table>
<thead>
<tr>
<th>Endpoint Type</th>
<th>Limit</th>
<th>Window</th>
</tr>
</thead>
<tbody>
<tr>
<td>Auth endpoints</td>
<td>10 req</td>
<td>1 min</td>
</tr>
<tr>
<td>Shape sync</td>
<td>100 req</td>
<td>1 min</td>
</tr>
<tr>
<td>Business logic</td>
<td>1000 req</td>
<td>1 min</td>
</tr>
<tr>
<td>WebSocket</td>
<td>1 connection</td>
<td>per device</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="websocket-protocol">8. WebSocket Protocol</h2>
<h3 id="connection">8.1 Connection</h3>
<div class="sourceCode" id="cb36"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Client connects with JWT in query param</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>ws <span class="op">=</span> <span class="kw">new</span> <span class="bu">WebSocket</span>(<span class="st">&#39;/v1/shape/batch_data/live?token=&lt;jwt&gt;&amp;batch_id=123&#39;</span>)</span></code></pre></div>
<h3 id="message-types">8.2 Message Types</h3>
<p><strong>Server → Client:</strong></p>
<div class="sourceCode" id="cb37"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="er">//</span> <span class="er">Data</span> <span class="er">update</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span><span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;data&quot;</span><span class="fu">,</span> <span class="dt">&quot;table&quot;</span><span class="fu">:</span> <span class="st">&quot;bc_barcode&quot;</span><span class="fu">,</span> <span class="dt">&quot;op&quot;</span><span class="fu">:</span> <span class="st">&quot;UPDATE&quot;</span><span class="fu">,</span> <span class="dt">&quot;row&quot;</span><span class="fu">:</span> <span class="fu">{</span><span class="er">...</span><span class="fu">}}</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="er">//</span> <span class="er">Checkpoint</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span><span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;checkpoint&quot;</span><span class="fu">,</span> <span class="dt">&quot;lsn&quot;</span><span class="fu">:</span> <span class="st">&quot;0/ABC123&quot;</span><span class="fu">}</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="er">//</span> <span class="er">Heartbeat</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span><span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;heartbeat&quot;</span><span class="fu">,</span> <span class="dt">&quot;ts&quot;</span><span class="fu">:</span> <span class="dv">1735200000</span><span class="fu">}</span></span></code></pre></div>
<p><strong>Client → Server:</strong></p>
<div class="sourceCode" id="cb38"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="er">//</span> <span class="er">ACK</span> <span class="er">checkpoint</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span><span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;ack&quot;</span><span class="fu">,</span> <span class="dt">&quot;lsn&quot;</span><span class="fu">:</span> <span class="st">&quot;0/ABC123&quot;</span><span class="fu">}</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="er">//</span> <span class="er">Push</span> <span class="er">operation</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span><span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;write&quot;</span><span class="fu">,</span> <span class="dt">&quot;table&quot;</span><span class="fu">:</span> <span class="st">&quot;bc_barcode&quot;</span><span class="fu">,</span> <span class="dt">&quot;op&quot;</span><span class="fu">:</span> <span class="st">&quot;UPDATE&quot;</span><span class="fu">,</span> <span class="dt">&quot;row&quot;</span><span class="fu">:</span> <span class="fu">{</span><span class="er">...</span><span class="fu">}}</span></span></code></pre></div>
<h1 id="security-analysis">Security Analysis</h1>
<h2 id="electricsql-local-first-security">ElectricSQL Local-First
Security</h2>
<hr />
<h2 id="security-overview">1. Security Overview</h2>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                    SECURITY LAYERS                           │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  Layer 1: Network Security                                   │
│  ├── TLS 1.3 for all connections                            │
│  ├── Certificate pinning (mobile)                           │
│  └── WAF / DDoS protection                                  │
│                                                              │
│  Layer 2: Authentication                                     │
│  ├── JWT tokens with short expiry                           │
│  ├── Refresh token rotation                                 │
│  └── Device binding                                         │
│                                                              │
│  Layer 3: Authorization                                      │
│  ├── Role-based access control (RBAC)                       │
│  ├── Row-level security (RLS) in PostgreSQL                 │
│  └── Shape-level permissions in Electric                    │
│                                                              │
│  Layer 4: Data Protection                                    │
│  ├── Encryption at rest (SQLite, PostgreSQL)                │
│  ├── Encryption in transit (TLS)                            │
│  └── Client-side encryption (optional)                      │
│                                                              │
│  Layer 5: Audit &amp; Monitoring                                 │
│  ├── All operations logged                                  │
│  ├── Anomaly detection                                      │
│  └── Compliance reporting                                   │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="threat-model">2. Threat Model</h2>
<h3 id="stride-analysis">2.1 STRIDE Analysis</h3>
<table>
<colgroup>
<col style="width: 30%" />
<col style="width: 23%" />
<col style="width: 46%" />
</colgroup>
<thead>
<tr>
<th>Threat</th>
<th>Risk</th>
<th>Mitigation</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>S</strong>poofing</td>
<td>Attacker impersonates user</td>
<td>JWT + device binding</td>
</tr>
<tr>
<td><strong>T</strong>ampering</td>
<td>Data modification in transit</td>
<td>TLS + CRDT checksums</td>
</tr>
<tr>
<td><strong>R</strong>epudiation</td>
<td>Deny sync operations</td>
<td>Audit logs + signed ops</td>
</tr>
<tr>
<td><strong>I</strong>nformation Disclosure</td>
<td>Data leak</td>
<td>Encryption + RLS</td>
</tr>
<tr>
<td><strong>D</strong>enial of Service</td>
<td>Overload sync service</td>
<td>Rate limiting + WAF</td>
</tr>
<tr>
<td><strong>E</strong>levation of Privilege</td>
<td>Access other vendor data</td>
<td>RLS + tenant isolation</td>
</tr>
</tbody>
</table>
<h3 id="attack-vectors">2.2 Attack Vectors</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                    ATTACK VECTORS                            │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  1. STOLEN DEVICE                                            │
│  ───────────────                                             │
│  Risk: Physical access to local SQLite DB                   │
│  Impact: Data exposure for synced barcodes                  │
│  Mitigation:                                                 │
│  • SQLite encryption (SQLCipher)                            │
│  • Remote wipe capability                                   │
│  • Auto-logout after inactivity                             │
│  • Biometric/PIN lock                                       │
│                                                              │
│  2. MAN-IN-THE-MIDDLE                                        │
│  ────────────────────                                        │
│  Risk: Intercept sync traffic                               │
│  Impact: Data exposure, CRDT injection                      │
│  Mitigation:                                                 │
│  • TLS 1.3 mandatory                                        │
│  • Certificate pinning                                      │
│  • HSTS headers                                             │
│                                                              │
│  3. MALICIOUS INSIDER                                        │
│  ────────────────────                                        │
│  Risk: Employee with valid credentials                      │
│  Impact: Data theft, sabotage                               │
│  Mitigation:                                                 │
│  • Least privilege access                                   │
│  • Audit logging                                            │
│  • Anomaly detection                                        │
│  • Data access reviews                                      │
│                                                              │
│  4. TOKEN THEFT                                              │
│  ────────────                                                │
│  Risk: JWT stolen from device/memory                        │
│  Impact: Unauthorized sync operations                       │
│  Mitigation:                                                 │
│  • Short token expiry (15 min)                              │
│  • Secure token storage (Keychain/Keystore)                 │
│  • Token binding to device ID                               │
│  • Refresh token rotation                                   │
│                                                              │
│  5. REPLAY ATTACK                                            │
│  ──────────────                                              │
│  Risk: Re-send old sync operations                          │
│  Impact: Data corruption, duplicate entries                 │
│  Mitigation:                                                 │
│  • CRDT timestamps prevent duplicates                       │
│  • Operation IDs (idempotency)                              │
│  • Nonce in requests                                        │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="authentication-design">3. Authentication Design</h2>
<h3 id="jwt-token-flow">3.1 JWT Token Flow</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                    JWT TOKEN FLOW                            │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  1. LOGIN                                                    │
│  ────────                                                    │
│  Client ──► POST /auth/login ──► Auth Service               │
│             {username, password,                             │
│              device_id, device_fingerprint}                  │
│                                                              │
│  Auth Service:                                               │
│  • Validate credentials                                      │
│  • Generate access token (15 min TTL)                       │
│  • Generate refresh token (7 days TTL)                      │
│  • Bind tokens to device_id                                 │
│                                                              │
│  Response:                                                   │
│  {access_token, refresh_token, expires_in}                  │
│                                                              │
│  2. API CALLS                                                │
│  ──────────                                                  │
│  Client ──► Any API ──► Middleware validates JWT            │
│  Header: Authorization: Bearer &lt;access_token&gt;               │
│                                                              │
│  3. TOKEN REFRESH                                            │
│  ──────────────                                              │
│  Client ──► POST /auth/refresh ──► Auth Service             │
│             {refresh_token}                                  │
│                                                              │
│  Auth Service:                                               │
│  • Validate refresh token                                   │
│  • Check device binding                                     │
│  • Rotate refresh token (old one invalidated)               │
│  • Issue new access token                                   │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="jwt-payload">3.2 JWT Payload</h3>
<div class="sourceCode" id="cb42"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;sub&quot;</span><span class="fu">:</span> <span class="st">&quot;user_123&quot;</span><span class="fu">,</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;vendor_code&quot;</span><span class="fu">:</span> <span class="st">&quot;ABC&quot;</span><span class="fu">,</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;roles&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;operator&quot;</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;permissions&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;read:batch&quot;</span><span class="ot">,</span> <span class="st">&quot;write:barcode&quot;</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;assigned_batches&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="dv">1</span><span class="ot">,</span> <span class="dv">2</span><span class="ot">,</span> <span class="dv">3</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;device_id&quot;</span><span class="fu">:</span> <span class="st">&quot;device_xyz&quot;</span><span class="fu">,</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;iat&quot;</span><span class="fu">:</span> <span class="dv">1735113600</span><span class="fu">,</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;exp&quot;</span><span class="fu">:</span> <span class="dv">1735114500</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<hr />
<h2 id="authorization-design">4. Authorization Design</h2>
<h3 id="row-level-security-postgresql">4.1 Row-Level Security
(PostgreSQL)</h3>
<div class="sourceCode" id="cb43"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Enable RLS on all barcode tables</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> bc_barcode <span class="kw">ENABLE</span> <span class="kw">ROW</span> <span class="kw">LEVEL</span> SECURITY;</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> bc_parent <span class="kw">ENABLE</span> <span class="kw">ROW</span> <span class="kw">LEVEL</span> SECURITY;</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> bc_batch <span class="kw">ENABLE</span> <span class="kw">ROW</span> <span class="kw">LEVEL</span> SECURITY;</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="co">-- Vendor isolation policy</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> POLICY vendor_isolation <span class="kw">ON</span> bc_barcode</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">FOR</span> <span class="kw">ALL</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">USING</span> (vendor_code <span class="op">=</span> current_setting(<span class="st">&#39;app.vendor_code&#39;</span>):<span class="ch">:text</span>);</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="co">-- Batch assignment policy</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> POLICY batch_access <span class="kw">ON</span> bc_barcode</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">FOR</span> <span class="kw">SELECT</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">USING</span> (</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    batch_id <span class="kw">IN</span> (</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>      <span class="kw">SELECT</span> batch_id <span class="kw">FROM</span> user_batch_assignments </span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>      <span class="kw">WHERE</span> user_id <span class="op">=</span> current_setting(<span class="st">&#39;app.user_id&#39;</span>):<span class="ch">:int</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>  );</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a><span class="co">-- Write policy (only operators can write)</span></span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> POLICY operator_write <span class="kw">ON</span> bc_barcode</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">FOR</span> <span class="kw">INSERT</span></span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WITH</span> <span class="kw">CHECK</span> (</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>    current_setting(<span class="st">&#39;app.role&#39;</span>):<span class="ch">:text</span> <span class="op">=</span> <span class="st">&#39;operator&#39;</span></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">AND</span> vendor_code <span class="op">=</span> current_setting(<span class="st">&#39;app.vendor_code&#39;</span>):<span class="ch">:text</span></span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>  );</span></code></pre></div>
<h3 id="electric-shape-authorization">4.2 Electric Shape
Authorization</h3>
<div class="sourceCode" id="cb44"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Electric configuration</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="fu">shapes</span><span class="kw">:</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">batch_data</span><span class="kw">:</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">tables</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">bc_parent</span><span class="kw">,</span><span class="at"> bc_barcode</span><span class="kw">,</span><span class="at"> bc_token</span><span class="kw">]</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">authorization</span><span class="kw">:</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="co">      # JWT claim requirements</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">require</span><span class="kw">:</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">claim</span><span class="kw">:</span><span class="at"> vendor_code</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">matches</span><span class="kw">:</span><span class="at"> :vendor_code</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">claim</span><span class="kw">:</span><span class="at"> assigned_batches</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">contains</span><span class="kw">:</span><span class="at"> :batch_id</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a><span class="co">      # Write permissions</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">write</span><span class="kw">:</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">require_role</span><span class="kw">:</span><span class="at"> operator</span></span></code></pre></div>
<hr />
<h2 id="data-encryption">5. Data Encryption</h2>
<h3 id="encryption-at-rest">5.1 Encryption at Rest</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                 ENCRYPTION AT REST                           │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  SERVER SIDE                                                 │
│  ───────────                                                 │
│  PostgreSQL:                                                 │
│  • Disk encryption (LUKS/AWS EBS encryption)                │
│  • Column-level encryption for sensitive fields             │
│  • Key management via AWS KMS / HashiCorp Vault             │
│                                                              │
│  CLIENT SIDE                                                 │
│  ───────────                                                 │
│  SQLite (Mobile/Desktop):                                   │
│  • SQLCipher encryption                                     │
│  • Key derived from user PIN + device key                   │
│  • Key stored in Keychain (iOS) / Keystore (Android)        │
│                                                              │
│  IndexedDB (Web):                                           │
│  • Web Crypto API encryption                                │
│  • Key derived from password + PBKDF2                       │
│  • Consider not storing sensitive data in web version       │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="encryption-in-transit">5.2 Encryption in Transit</h3>
<pre><code>All connections MUST use TLS 1.3

HTTPS endpoints:
• Certificate: Let&#39;s Encrypt / AWS ACM
• HSTS: max-age=31536000; includeSubDomains
• Content-Security-Policy: strict

WebSocket:
• wss:// only (no ws://)
• Same certificate as HTTPS

Mobile certificate pinning:
• Pin to leaf certificate
• Include backup pin for rotation</code></pre>
<h3 id="field-level-encryption-optional">5.3 Field-Level Encryption
(Optional)</h3>
<div class="sourceCode" id="cb47"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For extra-sensitive fields (e.g., token values)</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> cryptography.fernet <span class="im">import</span> Fernet</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> EncryptedField:</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, key: <span class="bu">bytes</span>):</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fernet <span class="op">=</span> Fernet(key)</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> encrypt(<span class="va">self</span>, value: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.fernet.encrypt(value.encode()).decode()</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> decrypt(<span class="va">self</span>, encrypted: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.fernet.decrypt(encrypted.encode()).decode()</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Usage in model</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>bc_token.token <span class="op">=</span> encrypted_field.encrypt(raw_token)</span></code></pre></div>
<hr />
<h2 id="security-controls-matrix">6. Security Controls Matrix</h2>
<table>
<thead>
<tr>
<th>Control</th>
<th>Server</th>
<th>Mobile</th>
<th>Web</th>
<th>Priority</th>
</tr>
</thead>
<tbody>
<tr>
<td>TLS 1.3</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
<td>CRITICAL</td>
</tr>
<tr>
<td>JWT auth</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
<td>CRITICAL</td>
</tr>
<tr>
<td>RLS</td>
<td>✅</td>
<td>N/A</td>
<td>N/A</td>
<td>CRITICAL</td>
</tr>
<tr>
<td>SQLite encryption</td>
<td>N/A</td>
<td>✅</td>
<td>N/A</td>
<td>HIGH</td>
</tr>
<tr>
<td>Certificate pinning</td>
<td>N/A</td>
<td>✅</td>
<td>N/A</td>
<td>HIGH</td>
</tr>
<tr>
<td>Rate limiting</td>
<td>✅</td>
<td>N/A</td>
<td>N/A</td>
<td>HIGH</td>
</tr>
<tr>
<td>Audit logging</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
<td>MEDIUM</td>
</tr>
<tr>
<td>WAF</td>
<td>✅</td>
<td>N/A</td>
<td>N/A</td>
<td>MEDIUM</td>
</tr>
<tr>
<td>Field encryption</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>LOW</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="incident-response">7. Incident Response</h2>
<h3 id="security-incident-types">7.1 Security Incident Types</h3>
<table>
<thead>
<tr>
<th>Type</th>
<th>Severity</th>
<th>Response Time</th>
</tr>
</thead>
<tbody>
<tr>
<td>Data breach</td>
<td>CRITICAL</td>
<td>&lt; 1 hour</td>
</tr>
<tr>
<td>Token compromise</td>
<td>HIGH</td>
<td>&lt; 4 hours</td>
</tr>
<tr>
<td>DDoS attack</td>
<td>HIGH</td>
<td>&lt; 1 hour</td>
</tr>
<tr>
<td>Unauthorized access</td>
<td>MEDIUM</td>
<td>&lt; 24 hours</td>
</tr>
</tbody>
</table>
<h3 id="remote-wipe-capability">7.2 Remote Wipe Capability</h3>
<pre><code>IF device_compromised:
  1. Revoke all tokens for device_id
  2. Add device_id to blocklist
  3. Trigger remote wipe via push notification
  4. Client deletes local SQLite DB
  5. Log incident to security team</code></pre>
<hr />
<h2 id="compliance-considerations">8. Compliance Considerations</h2>
<table>
<thead>
<tr>
<th>Standard</th>
<th>Requirement</th>
<th>Implementation</th>
</tr>
</thead>
<tbody>
<tr>
<td>GDPR</td>
<td>Data minimization</td>
<td>Sync only needed data</td>
</tr>
<tr>
<td>GDPR</td>
<td>Right to erasure</td>
<td>Cascade delete in sync</td>
</tr>
<tr>
<td>ISO 27001</td>
<td>Access control</td>
<td>RLS + RBAC</td>
</tr>
<tr>
<td>SOC 2</td>
<td>Audit trails</td>
<td>All ops logged</td>
</tr>
<tr>
<td>PCI DSS</td>
<td>Encryption</td>
<td>TLS + SQLCipher</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="security-checklist">9. Security Checklist</h2>
<h3 id="pre-production">Pre-Production</h3>
<ul class="task-list">
<li><label><input type="checkbox" />Penetration testing
completed</label></li>
<li><label><input type="checkbox" />Security code review
done</label></li>
<li><label><input type="checkbox" />Dependency vulnerability
scan</label></li>
<li><label><input type="checkbox" />TLS configuration
validated</label></li>
<li><label><input type="checkbox" />JWT implementation
reviewed</label></li>
<li><label><input type="checkbox" />RLS policies tested</label></li>
<li><label><input type="checkbox" />Rate limiting
configured</label></li>
<li><label><input type="checkbox" />WAF rules deployed</label></li>
</ul>
<h3 id="ongoing">Ongoing</h3>
<ul class="task-list">
<li><label><input type="checkbox" />Weekly vulnerability
scans</label></li>
<li><label><input type="checkbox" />Monthly access reviews</label></li>
<li><label><input type="checkbox" />Quarterly penetration
tests</label></li>
<li><label><input type="checkbox" />Annual security audit</label></li>
</ul>
<h1 id="sla-reliability-design">SLA &amp; Reliability Design</h1>
<h2 id="uptime-architecture">99.99% Uptime Architecture</h2>
<hr />
<h2 id="sla-targets">1. SLA Targets</h2>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                    SLA TARGETS                               │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  TIER 1: CRITICAL (99.99% = 52 min downtime/year)           │
│  ────────────────────────────────────────────────            │
│  • Barcode scanning (offline-capable)                       │
│  • Local database operations                                │
│  • Offline queue processing                                 │
│                                                              │
│  TIER 2: HIGH (99.9% = 8.76 hours downtime/year)            │
│  ───────────────────────────────────────────────             │
│  • Real-time sync (WebSocket)                               │
│  • Initial sync (bootstrap)                                 │
│  • API endpoints                                            │
│                                                              │
│  TIER 3: STANDARD (99.5% = 43.8 hours downtime/year)        │
│  ─────────────────────────────────────────────────           │
│  • Background sync                                          │
│  • Historical data access                                   │
│  • Reporting &amp; analytics                                    │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="how-local-first-achieves-99.99">2. How Local-First Achieves
99.99%</h2>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│              LOCAL-FIRST = HIGH AVAILABILITY                 │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  TRADITIONAL ARCHITECTURE                                    │
│  ─────────────────────────                                   │
│  App ──► Network ──► Server ──► Database                    │
│       │         │           │                               │
│       └─ Failure points ────┘                               │
│                                                              │
│  Availability = 99.9% × 99.9% × 99.9% = 99.7%               │
│                                                              │
│  ═══════════════════════════════════════                     │
│                                                              │
│  LOCAL-FIRST ARCHITECTURE                                    │
│  ─────────────────────────                                   │
│  App ──► Local SQLite (always available)                    │
│       │                                                      │
│       └──► Background sync (eventually consistent)          │
│                                                              │
│  Core operations: 99.99%+ (limited only by app/device)      │
│  Sync operations: 99.9% (server-dependent)                  │
│                                                              │
│  User Experience Availability = 99.99%                       │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="failure-mode-analysis">3. Failure Mode Analysis</h2>
<h3 id="failure-scenarios-mitigations">3.1 Failure Scenarios &amp;
Mitigations</h3>
<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 17%" />
<col style="width: 24%" />
<col style="width: 26%" />
<col style="width: 11%" />
</colgroup>
<thead>
<tr>
<th>Failure</th>
<th>Impact</th>
<th>Detection</th>
<th>Mitigation</th>
<th>RTO</th>
</tr>
</thead>
<tbody>
<tr>
<td>Network down</td>
<td>No sync</td>
<td>Connection monitor</td>
<td>Offline mode</td>
<td>0s</td>
</tr>
<tr>
<td>Electric crash</td>
<td>No sync</td>
<td>Health check</td>
<td>Auto-restart K8s</td>
<td>30s</td>
</tr>
<tr>
<td>PostgreSQL down</td>
<td>No sync</td>
<td>PG health check</td>
<td>Failover to replica</td>
<td>1 min</td>
</tr>
<tr>
<td>Client crash</td>
<td>App restart</td>
<td>OS-level</td>
<td>Auto-resume sync</td>
<td>5s</td>
</tr>
<tr>
<td>Local DB corrupt</td>
<td>Data loss</td>
<td>Checksum</td>
<td>Re-sync from server</td>
<td>1 min</td>
</tr>
<tr>
<td>Full datacenter outage</td>
<td>No sync</td>
<td>Multi-region</td>
<td>DR failover</td>
<td>5 min</td>
</tr>
</tbody>
</table>
<h3 id="rtorpo-targets">3.2 RTO/RPO Targets</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                    RTO / RPO TARGETS                         │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  RTO (Recovery Time Objective)                               │
│  ─────────────────────────────                               │
│  • Local operations: 0 seconds (always available)           │
│  • Sync resume: &lt; 30 seconds after network restore          │
│  • Full system recovery: &lt; 5 minutes                        │
│                                                              │
│  RPO (Recovery Point Objective)                              │
│  ─────────────────────────────                               │
│  • Local changes: 0 (persisted immediately)                 │
│  • Server state: &lt; 1 second (real-time sync)                │
│  • Worst case (offline period): Duration of offline         │
│                                                              │
│  Note: With local-first, no data is ever lost.              │
│  Data syncs when connection restores.                        │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="high-availability-architecture">4. High Availability
Architecture</h2>
<h3 id="server-side-ha">4.1 Server-Side HA</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                SERVER-SIDE HA ARCHITECTURE                   │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  REGION A (Primary)              REGION B (DR)               │
│  ──────────────────              ────────────────            │
│                                                              │
│  ┌─────────────────┐            ┌─────────────────┐         │
│  │ Load Balancer   │────────────│ Load Balancer   │         │
│  │ (Active)        │            │ (Standby)       │         │
│  └────────┬────────┘            └────────┬────────┘         │
│           │                              │                   │
│  ┌────────┴────────┐            ┌────────┴────────┐         │
│  │ Electric Pod ×3 │            │ Electric Pod ×2 │         │
│  │ (Auto-scaling)  │            │ (Warm standby)  │         │
│  └────────┬────────┘            └────────┬────────┘         │
│           │                              │                   │
│  ┌────────┴────────┐            ┌────────┴────────┐         │
│  │ PostgreSQL      │────────────│ PostgreSQL      │         │
│  │ Primary         │  Streaming │ Replica         │         │
│  │                 │  Replication                 │         │
│  └─────────────────┘            └─────────────────┘         │
│                                                              │
│  Failover: Automatic via health checks                       │
│  DNS: Route53 health-based routing                           │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="client-side-resilience">4.2 Client-Side Resilience</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                CLIENT-SIDE RESILIENCE                        │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  1. CONNECTION MANAGEMENT                                    │
│  ─────────────────────────                                   │
│  • Automatic reconnection with exponential backoff          │
│  • Connection pooling for WebSocket                         │
│  • Fallback from WebSocket → HTTP long-polling              │
│                                                              │
│  2. DATA INTEGRITY                                           │
│  ─────────────────                                           │
│  • WAL (Write-Ahead Log) for SQLite                         │
│  • Transaction support for all writes                       │
│  • Periodic checksums against server                        │
│                                                              │
│  3. ERROR RECOVERY                                           │
│  ─────────────────                                           │
│  • Retry logic for failed sync operations                   │
│  • Conflict queue for manual resolution                     │
│  • Automatic re-sync on corruption detection                │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="monitoring-alerting">5. Monitoring &amp; Alerting</h2>
<h3 id="health-metrics">5.1 Health Metrics</h3>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Threshold</th>
<th>Alert</th>
</tr>
</thead>
<tbody>
<tr>
<td>Electric pod CPU</td>
<td>&gt; 80%</td>
<td>WARNING</td>
</tr>
<tr>
<td>Electric pod memory</td>
<td>&gt; 85%</td>
<td>WARNING</td>
</tr>
<tr>
<td>WebSocket connections</td>
<td>&gt; 10K/pod</td>
<td>SCALE UP</td>
</tr>
<tr>
<td>Sync latency P99</td>
<td>&gt; 5 seconds</td>
<td>WARNING</td>
</tr>
<tr>
<td>Sync error rate</td>
<td>&gt; 1%</td>
<td>CRITICAL</td>
</tr>
<tr>
<td>PostgreSQL replication lag</td>
<td>&gt; 10 seconds</td>
<td>CRITICAL</td>
</tr>
<tr>
<td>Client offline duration</td>
<td>&gt; 24 hours</td>
<td>INFO</td>
</tr>
</tbody>
</table>
<h3 id="alerting-matrix">5.2 Alerting Matrix</h3>
<pre><code>CRITICAL (Page on-call immediately):
• All Electric pods down
• PostgreSQL primary unavailable
• Sync error rate &gt; 5%
• Data integrity checksum mismatch

WARNING (Notify team, investigate):
• Single pod failure
• Sync latency &gt; 30 seconds
• Replication lag &gt; 1 minute
• Memory usage &gt; 85%

INFO (Log, review daily):
• New client version adoption
• Offline client count
• Conflict resolution rate</code></pre>
<hr />
<h2 id="disaster-recovery">6. Disaster Recovery</h2>
<h3 id="dr-strategy">6.1 DR Strategy</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                    DR STRATEGY                               │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  TIER 1: AUTOMATIC (Infrastructure failures)                │
│  ────────────────────────────────────────────                │
│  • K8s auto-restart crashed pods                            │
│  • PostgreSQL auto-failover to replica                      │
│  • DNS failover to DR region                                │
│  • No manual intervention needed                            │
│                                                              │
│  TIER 2: SEMI-AUTOMATIC (Regional failures)                 │
│  ──────────────────────────────────────────                  │
│  • Trigger DR runbook                                       │
│  • Promote DR PostgreSQL to primary                         │
│  • Update DNS to point to DR region                         │
│  • ~5 minute recovery                                       │
│                                                              │
│  TIER 3: MANUAL (Catastrophic failures)                     │
│  ──────────────────────────────────────                      │
│  • Restore from backup                                      │
│  • Rebuild infrastructure                                   │
│  • Re-bootstrap clients (data preserved locally)            │
│  • ~30 minute recovery                                      │
│                                                              │
│  CLIENT BEHAVIOR DURING DR:                                  │
│  • Continues operating offline                              │
│  • Queues all operations locally                            │
│  • Auto-syncs when servers recover                          │
│  • Zero user-facing downtime                                │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="backup-strategy">6.2 Backup Strategy</h3>
<table>
<thead>
<tr>
<th>Data</th>
<th>Frequency</th>
<th>Retention</th>
<th>Storage</th>
</tr>
</thead>
<tbody>
<tr>
<td>PostgreSQL full</td>
<td>Daily</td>
<td>30 days</td>
<td>S3 + Glacier</td>
</tr>
<tr>
<td>PostgreSQL WAL</td>
<td>Continuous</td>
<td>7 days</td>
<td>S3</td>
</tr>
<tr>
<td>Electric state</td>
<td>Hourly</td>
<td>7 days</td>
<td>S3</td>
</tr>
<tr>
<td>Client SQLite</td>
<td>On sync</td>
<td>N/A</td>
<td>Server is backup</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="capacity-planning">7. Capacity Planning</h2>
<h3 id="load-estimates">7.1 Load Estimates</h3>
<pre><code>Assumptions:
• 100 vendors
• 10,000 active users
• 1,000,000 barcodes per vendor
• 100 scans per user per day

Calculations:
• Total sync connections: 10,000 (peak)
• Writes per second: 1,000,000 scans / 28,800 sec = ~35 writes/sec
• Sync messages per second: 35 × 100 (fanout) = 3,500 msg/sec</code></pre>
<h3 id="infrastructure-sizing">7.2 Infrastructure Sizing</h3>
<table>
<thead>
<tr>
<th>Component</th>
<th>Size</th>
<th>Scale Trigger</th>
</tr>
</thead>
<tbody>
<tr>
<td>Electric pods</td>
<td>3 × 2 CPU, 4GB RAM</td>
<td>CPU &gt; 70%</td>
</tr>
<tr>
<td>PostgreSQL</td>
<td>db.r6g.xlarge (4 vCPU, 32GB)</td>
<td>Connections &gt; 500</td>
</tr>
<tr>
<td>Redis cache</td>
<td>cache.r6g.large</td>
<td>Memory &gt; 80%</td>
</tr>
<tr>
<td>Load Balancer</td>
<td>Application LB</td>
<td>Auto-scales</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="sla-dashboard-metrics">8. SLA Dashboard Metrics</h2>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                    SLA DASHBOARD                             │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  AVAILABILITY (Last 30 days)                                 │
│  ───────────────────────────                                 │
│  Overall System:      99.95% ████████████████████░░ ✓       │
│  Electric Service:    99.98% █████████████████████░ ✓       │
│  PostgreSQL:          99.99% █████████████████████░ ✓       │
│  Client Operations:   100.0% █████████████████████ ✓        │
│                                                              │
│  PERFORMANCE (P99 Latency)                                   │
│  ─────────────────────────                                   │
│  Initial Sync:        12.3s  ████████░░░░░░░░░░░░░ ✓        │
│  Incremental Sync:    0.8s   ██░░░░░░░░░░░░░░░░░░░ ✓        │
│  Local Write:         5ms    ░░░░░░░░░░░░░░░░░░░░░ ✓        │
│  Conflict Resolution: 50ms   ░░░░░░░░░░░░░░░░░░░░░ ✓        │
│                                                              │
│  INCIDENTS                                                   │
│  ─────────                                                   │
│  This Month:          1 (minor, 5 min)                      │
│  Last Quarter:        3 (total downtime: 18 min)            │
│  SLA Target:          52 min/year allowed                   │
│  Remaining Budget:    34 min                                 │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="reliability-checklist">9. Reliability Checklist</h2>
<h3 id="pre-production-1">Pre-Production</h3>
<ul class="task-list">
<li><label><input type="checkbox" />Load testing completed (2× expected
peak)</label></li>
<li><label><input type="checkbox" />Failover testing
completed</label></li>
<li><label><input type="checkbox" />DR drill executed</label></li>
<li><label><input type="checkbox" />Chaos engineering tests
passed</label></li>
<li><label><input type="checkbox" />Client offline testing (72
hours)</label></li>
<li><label><input type="checkbox" />Sync conflict scenarios
tested</label></li>
<li><label><input type="checkbox" />Monitoring dashboards
configured</label></li>
<li><label><input type="checkbox" />Alerting rules
configured</label></li>
<li><label><input type="checkbox" />Runbooks documented</label></li>
</ul>
<h3 id="ongoing-1">Ongoing</h3>
<ul class="task-list">
<li><label><input type="checkbox" />Weekly health checks</label></li>
<li><label><input type="checkbox" />Monthly DR drills</label></li>
<li><label><input type="checkbox" />Quarterly capacity
review</label></li>
<li><label><input type="checkbox" />Annual architecture
review</label></li>
</ul>
<h1 id="blindspots-risk-analysis">Blindspots &amp; Risk Analysis</h1>
<h2 id="edge-cases-risks-and-mitigation-strategies">Edge Cases, Risks,
and Mitigation Strategies</h2>
<hr />
<h2 id="risk-overview">1. Risk Overview</h2>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                    RISK MATRIX                               │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  IMPACT                                                      │
│    ▲                                                         │
│    │                                                         │
│  H │  ┌────────┐     ┌────────┐                             │
│  I │  │ Clock  │     │ Data   │                             │
│  G │  │ Drift  │     │ Loss   │                             │
│  H │  └────────┘     └────────┘                             │
│    │                                                         │
│  M │  ┌────────┐     ┌────────┐     ┌────────┐             │
│  E │  │ Schema │     │Storage │     │Conflict│             │
│  D │  │ Change │     │ Full   │     │ Flood  │             │
│    │  └────────┘     └────────┘     └────────┘             │
│    │                                                         │
│  L │  ┌────────┐     ┌────────┐                             │
│  O │  │ Slow   │     │ User   │                             │
│  W │  │ Sync   │     │ Error  │                             │
│    │  └────────┘     └────────┘                             │
│    │                                                         │
│    └────────────────────────────────────────────►           │
│       LOW            MEDIUM           HIGH                   │
│                    LIKELIHOOD                                │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="technical-blindspots">2. Technical Blindspots</h2>
<h3 id="clock-drift-issue">2.1 Clock Drift Issue</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│  BLINDSPOT: Device Clock Drift                               │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  PROBLEM:                                                    │
│  • CRDT uses timestamps for conflict resolution             │
│  • If device clock is wrong, wrong data wins                │
│  • Mobile devices can have significantly wrong clocks        │
│                                                              │
│  SCENARIO:                                                   │
│  Device A clock: 2025-12-25 10:00:00 (correct)              │
│  Device B clock: 2025-12-26 10:00:00 (1 day ahead!)         │
│                                                              │
│  Both update same barcode → Device B always wins            │
│  (even for older changes)                                    │
│                                                              │
│  IMPACT: HIGH                                                │
│  LIKELIHOOD: MEDIUM                                          │
│                                                              │
│  MITIGATION:                                                 │
│  1. Use Hybrid Logical Clock (HLC) instead of wall clock    │
│  2. Validate device time delta on sync                       │
│  3. Warn user if clock is significantly off                  │
│  4. Server can reject ops with unrealistic timestamps        │
│                                                              │
│  IMPLEMENTATION:                                             │
│  • On sync connect, compare device time vs server time       │
│  • If |delta| &gt; 5 minutes, warn user                        │
│  • If |delta| &gt; 1 hour, block sync until fixed              │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="storage-exhaustion">2.2 Storage Exhaustion</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│  BLINDSPOT: Client Storage Full                              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  PROBLEM:                                                    │
│  • Mobile devices have limited storage                       │
│  • SQLite DB can grow large with many barcodes               │
│  • System may prevent writes when storage is low            │
│                                                              │
│  SCENARIO:                                                   │
│  • User syncs large batch (100K barcodes)                   │
│  • Phone storage at 95%                                     │
│  • SQLite write fails → sync stuck                          │
│  • User cannot scan new barcodes                            │
│                                                              │
│  IMPACT: HIGH                                                │
│  LIKELIHOOD: MEDIUM                                          │
│                                                              │
│  MITIGATION:                                                 │
│  1. Monitor storage before sync                              │
│  2. Implement LRU eviction for old batch data               │
│  3. Compress local DB periodically (VACUUM)                 │
│  4. Warn user when storage &lt; 500MB free                     │
│  5. Allow partial sync (critical data only)                 │
│                                                              │
│  STORAGE ESTIMATION:                                         │
│  • 100K barcodes × 500 bytes = 50 MB                        │
│  • + indexes + overhead = ~100 MB per batch                 │
│  • Reserved minimum: 200 MB for operations                  │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="schema-migration">2.3 Schema Migration</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│  BLINDSPOT: Schema Changes During Active Sync                │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  PROBLEM:                                                    │
│  • Server schema changes (new column, new table)            │
│  • Client has old schema in SQLite                          │
│  • Sync breaks or data is lost                              │
│                                                              │
│  SCENARIO:                                                   │
│  1. Server adds new column: bc_barcode.quality_score        │
│  2. Old client tries to sync                                │
│  3. Client receives row with unknown column                 │
│  4. Insert fails or column is silently dropped              │
│                                                              │
│  IMPACT: HIGH                                                │
│  LIKELIHOOD: LOW (planning reduces this)                    │
│                                                              │
│  MITIGATION:                                                 │
│  1. Version the sync protocol                               │
│  2. Client reports its schema version on connect             │
│  3. Server downgrades response for old clients              │
│  4. Force app update for breaking schema changes            │
│  5. Use backward-compatible migrations only                 │
│                                                              │
│  MIGRATION RULES:                                            │
│  ✅ ADD column with default value                           │
│  ✅ ADD new table                                           │
│  ⚠️ RENAME column (requires version gate)                  │
│  ❌ DROP column (never, use is_deprecated flag)             │
│  ❌ CHANGE column type (never)                              │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="conflict-flood">2.4 Conflict Flood</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│  BLINDSPOT: Mass Conflict During Reconnect                   │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  PROBLEM:                                                    │
│  • Many users offline simultaneously (network outage)       │
│  • All make changes to same data                            │
│  • All reconnect at same time                               │
│  • Massive conflict resolution load                         │
│                                                              │
│  SCENARIO:                                                   │
│  • Factory WiFi down for 4 hours                            │
│  • 50 operators scanning barcodes offline                   │
│  • WiFi restored → all sync at once                         │
│  • 50,000 CRDT operations to merge                          │
│  • Server overwhelmed, sync fails                           │
│                                                              │
│  IMPACT: MEDIUM                                              │
│  LIKELIHOOD: MEDIUM                                          │
│                                                              │
│  MITIGATION:                                                 │
│  1. Jitter reconnection (random delay 0-30 sec)             │
│  2. Rate limit sync operations per client                   │
│  3. Priority queue (older offline clients first)            │
│  4. Circuit breaker on Electric service                     │
│  5. Auto-scale pods on connection spike                     │
│                                                              │
│  IMPLEMENTATION:                                             │
│  reconnect_delay = random(0, 30) + (offline_duration / 100) │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="business-logic-blindspots">3. Business Logic Blindspots</h2>
<h3 id="double-pairing-prevention">3.1 Double Pairing Prevention</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│  BLINDSPOT: Barcode Paired to Multiple Parents               │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  PROBLEM:                                                    │
│  • Business rule: 1 barcode = 1 parent only                 │
│  • Two users offline pair same barcode to different parents │
│  • CRDT merges both → barcode has 2 parents                 │
│  • Inventory count incorrect                                │
│                                                              │
│  IMPACT: HIGH (business data integrity)                     │
│  LIKELIHOOD: MEDIUM                                          │
│                                                              │
│  MITIGATION:                                                 │
│  1. First-write-wins for pairing (not LWW)                  │
│  2. Server validates pairing on sync                        │
│  3. Reject second pairing, notify user                      │
│  4. Add &quot;pairing conflict&quot; queue for manual resolution      │
│                                                              │
│  DETECTION:                                                  │
│  • CHECK constraint: bc_barcode.parent_id is unique per row │
│  • Periodic audit: SELECT barcodes with &gt;1 pairing log      │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="deleted-data-resurrection">3.2 Deleted Data Resurrection</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│  BLINDSPOT: Deleted Items Coming Back                        │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  PROBLEM:                                                    │
│  • Admin deletes barcode on server                          │
│  • Offline user edits same barcode                          │
│  • User syncs → barcode &quot;resurrects&quot;                        │
│                                                              │
│  SCENARIO:                                                   │
│  T1: Admin sets is_deleted = true (server)                  │
│  T2: Offline user updates note (local, timestamp after T1)  │
│  T3: User syncs → LWW picks user&#39;s update (T2 &gt; T1)         │
│  T4: is_deleted reverted to false! 💀                       │
│                                                              │
│  IMPACT: MEDIUM                                              │
│  LIKELIHOOD: LOW                                             │
│                                                              │
│  MITIGATION:                                                 │
│  1. Use tombstone semantics (delete = permanent)            │
│  2. is_deleted uses OR-set (true always wins)               │
│  3. Separate delete operation from update                   │
│  4. Server rejects updates to deleted rows                  │
│                                                              │
│  CRDT RULE:                                                  │
│  is_deleted field uses &quot;add-wins&quot; semantics:                │
│  DELETE(T1) + UPDATE(T2) = DELETED (regardless of T1 vs T2) │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="stale-read-issues">3.3 Stale Read Issues</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│  BLINDSPOT: Acting on Stale Data                             │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  PROBLEM:                                                    │
│  • User views data that&#39;s outdated                          │
│  • Makes decision based on stale info                       │
│  • Sync updates show different reality                      │
│                                                              │
│  SCENARIO:                                                   │
│  • User A sees: &quot;Parent X has 5 barcodes paired&quot;            │
│  • Actually server shows: &quot;Parent X has 10 barcodes&quot;        │
│  • User A pairs 5 more (thinks they&#39;re completing it)       │
│  • Sync shows Parent X now has 15 (overfilled!)             │
│                                                              │
│  IMPACT: MEDIUM                                              │
│  LIKELIHOOD: MEDIUM                                          │
│                                                              │
│  MITIGATION:                                                 │
│  1. Show &quot;last synced&quot; timestamp prominently                │
│  2. Warn user if data is &gt; 5 min stale                      │
│  3. For critical operations, require fresh sync             │
│  4. Use optimistic locking with version check               │
│                                                              │
│  UX RECOMMENDATION:                                          │
│  &quot;Data from 2 hours ago&quot; warning banner                      │
│  &quot;Sync now&quot; button for critical screens                      │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="operational-blindspots">4. Operational Blindspots</h2>
<h3 id="long-offline-period">4.1 Long Offline Period</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│  BLINDSPOT: Client Offline for Weeks                         │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  PROBLEM:                                                    │
│  • Client offline for extended period (weeks)               │
│  • Massive accumulated delta on server                      │
│  • Schema may have changed                                   │
│  • Initial re-sync takes very long or fails                 │
│                                                              │
│  IMPACT: MEDIUM                                              │
│  LIKELIHOOD: LOW                                             │
│                                                              │
│  MITIGATION:                                                 │
│  1. Track last sync timestamp per device                    │
│  2. If &gt; 7 days offline, force full re-sync                 │
│  3. Warn user before sync: &quot;Large sync required&quot;            │
│  4. Allow background sync with progress                     │
│  5. Preserve local changes during re-sync                   │
│                                                              │
│  THRESHOLD LOGIC:                                            │
│  if (offline_duration &lt; 7 days):                            │
│      incremental_sync()                                      │
│  else:                                                       │
│      warn_user(&quot;Large sync required&quot;)                        │
│      full_resync_with_merge()                                │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="electric-service-memory-leak">4.2 Electric Service Memory
Leak</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│  BLINDSPOT: Memory Leak in Long-Running Service              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  PROBLEM:                                                    │
│  • Electric service runs 24/7                               │
│  • Memory slowly increases over days/weeks                  │
│  • Eventually OOM kills the service                         │
│  • Clients lose sync connection                             │
│                                                              │
│  IMPACT: HIGH (service outage)                              │
│  LIKELIHOOD: LOW                                             │
│                                                              │
│  MITIGATION:                                                 │
│  1. Monitor memory usage over time                          │
│  2. Set K8s memory limits (hard cap)                        │
│  3. Automatic pod rolling restart weekly                    │
│  4. Alert on memory growth trend                            │
│  5. Profile service under load                              │
│                                                              │
│  K8s CONFIG:                                                 │
│  resources:                                                  │
│    limits:                                                   │
│      memory: 4Gi                                             │
│    requests:                                                 │
│      memory: 2Gi                                             │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="user-experience-blindspots">5. User Experience Blindspots</h2>
<h3 id="sync-progress-ux">5.1 Sync Progress UX</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│  BLINDSPOT: User Doesn&#39;t Know Sync State                     │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  PROBLEM:                                                    │
│  • User doesn&#39;t know if they&#39;re synced or not               │
│  • Makes changes thinking they&#39;re saved to server           │
│  • Logs out or uninstalls app                               │
│  • Changes lost (were still in local queue)                 │
│                                                              │
│  IMPACT: HIGH (user trust, data loss)                       │
│  LIKELIHOOD: MEDIUM                                          │
│                                                              │
│  MITIGATION:                                                 │
│  1. Always show sync status indicator                       │
│  2. Show pending changes count                              │
│  3. Warn before logout if pending changes exist             │
│  4. Block uninstall if pending changes (if possible)        │
│  5. Regular &quot;all synced&quot; notification                       │
│                                                              │
│  UX ELEMENTS:                                                │
│  ┌──────────────────────────┐                               │
│  │ ✓ All synced             │  (green)                      │
│  │ ↻ Syncing 5 items...     │  (blue, animated)             │
│  │ ⚠ 3 pending changes      │  (yellow)                     │
│  │ ✗ Offline - 12 pending   │  (red)                        │
│  └──────────────────────────┘                               │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="conflict-notification">5.2 Conflict Notification</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│  BLINDSPOT: User Unaware of Auto-Resolved Conflicts          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  PROBLEM:                                                    │
│  • CRDT auto-resolves conflicts                             │
│  • User&#39;s changes might be &quot;lost&quot; (LWW picked other)        │
│  • User doesn&#39;t know their change didn&#39;t win                │
│  • Confusion when data differs from what they entered       │
│                                                              │
│  IMPACT: MEDIUM (user confusion)                            │
│  LIKELIHOOD: MEDIUM                                          │
│                                                              │
│  MITIGATION:                                                 │
│  1. Log all conflict resolutions                            │
│  2. Notify user when their change was superseded            │
│  3. Show conflict history for debugging                     │
│  4. For critical fields, require manual resolution          │
│                                                              │
│  NOTIFICATION:                                               │
│  &quot;Your note was updated by another user (John, 5 min ago).  │
│   Your version: &#39;QC OK&#39;                                      │
│   Current version: &#39;QC Failed - see supervisor&#39;&quot;             │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="risk-mitigation-summary">6. Risk Mitigation Summary</h2>
<table>
<thead>
<tr>
<th>Blindspot</th>
<th>Severity</th>
<th>Mitigation Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>Clock Drift</td>
<td>HIGH</td>
<td>⚠️ Need HLC implementation</td>
</tr>
<tr>
<td>Storage Full</td>
<td>HIGH</td>
<td>⚠️ Need LRU eviction</td>
</tr>
<tr>
<td>Schema Migration</td>
<td>HIGH</td>
<td>✅ Version protocol</td>
</tr>
<tr>
<td>Conflict Flood</td>
<td>MEDIUM</td>
<td>⚠️ Need jitter + rate limit</td>
</tr>
<tr>
<td>Double Pairing</td>
<td>HIGH</td>
<td>⚠️ Need server validation</td>
</tr>
<tr>
<td>Deleted Resurrection</td>
<td>MEDIUM</td>
<td>✅ OR-set semantics</td>
</tr>
<tr>
<td>Stale Read</td>
<td>MEDIUM</td>
<td>⚠️ Need staleness indicator</td>
</tr>
<tr>
<td>Long Offline</td>
<td>MEDIUM</td>
<td>✅ Force re-sync logic</td>
</tr>
<tr>
<td>Memory Leak</td>
<td>HIGH</td>
<td>✅ K8s limits + restart</td>
</tr>
<tr>
<td>Sync State UX</td>
<td>HIGH</td>
<td>⚠️ Need status indicator</td>
</tr>
<tr>
<td>Conflict UX</td>
<td>MEDIUM</td>
<td>⚠️ Need notifications</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="recommended-pre-launch-checklist">7. Recommended Pre-Launch
Checklist</h2>
<h3 id="critical-block-launch">Critical (Block Launch)</h3>
<ul class="task-list">
<li><label><input type="checkbox" />HLC implementation for
timestamps</label></li>
<li><label><input type="checkbox" />Server-side pairing
validation</label></li>
<li><label><input type="checkbox" />Sync status indicator in
UI</label></li>
<li><label><input type="checkbox" />Storage monitoring +
warnings</label></li>
<li><label><input type="checkbox" />Reconnection jitter
algorithm</label></li>
</ul>
<h3 id="high-priority-launch-within-week">High Priority (Launch Within
Week)</h3>
<ul class="task-list">
<li><label><input type="checkbox" />LRU eviction for old batch
data</label></li>
<li><label><input type="checkbox" />Conflict notification
system</label></li>
<li><label><input type="checkbox" />Staleness warning UI</label></li>
<li><label><input type="checkbox" />Memory monitoring
dashboard</label></li>
</ul>
<h3 id="nice-to-have">Nice to Have</h3>
<ul class="task-list">
<li><label><input type="checkbox" />Conflict history viewer</label></li>
<li><label><input type="checkbox" />Advanced analytics on sync
patterns</label></li>
<li><label><input type="checkbox" />Custom conflict resolution
UI</label></li>
</ul>
<h1 id="user-analysis">User Analysis</h1>
<h2 id="impact-on-end-users-ux-considerations">Impact on End Users &amp;
UX Considerations</h2>
<hr />
<h2 id="user-personas">1. User Personas</h2>
<h3 id="primary-users">1.1 Primary Users</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                    USER PERSONAS                             │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  PERSONA 1: Factory Operator                                 │
│  ──────────────────────────                                  │
│  Name: Budi                                                  │
│  Role: Production line barcode scanner                       │
│  Tech Level: Basic smartphone user                           │
│  Environment: Factory floor, sometimes weak WiFi             │
│  Pain Points:                                                │
│  • App freezes when scanning quickly                        │
│  • Loses work when WiFi drops                               │
│  • Confused by error messages                               │
│  Goals:                                                      │
│  • Scan barcodes quickly without waiting                    │
│  • Not lose work when connection is unstable                │
│                                                              │
│  ─────────────────────────────────────────────               │
│                                                              │
│  PERSONA 2: Warehouse Supervisor                             │
│  ────────────────────────────                                │
│  Name: Dewi                                                  │
│  Role: Manages inbound/outbound, oversees operators          │
│  Tech Level: Intermediate                                    │
│  Environment: Warehouse, moves between WiFi zones            │
│  Pain Points:                                                │
│  • Can&#39;t see real-time status from operators                │
│  • Data conflicts between team members                      │
│  • Reports show stale data                                  │
│  Goals:                                                      │
│  • Real-time visibility of operations                       │
│  • Quick conflict resolution                                │
│  • Accurate reporting                                       │
│                                                              │
│  ─────────────────────────────────────────────               │
│                                                              │
│  PERSONA 3: Admin / Manager                                  │
│  ─────────────────────────                                   │
│  Name: Andi                                                  │
│  Role: System admin, batch management                        │
│  Tech Level: Advanced                                        │
│  Environment: Office, stable connection                      │
│  Pain Points:                                                │
│  • Managing multiple batches across vendors                 │
│  • Understanding sync status across devices                 │
│  • Debugging issues from field                              │
│  Goals:                                                      │
│  • Dashboard for all sync statuses                          │
│  • Ability to force sync on devices                         │
│  • Audit trail for all operations                           │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="user-journey-before-vs-after">2. User Journey: Before vs
After</h2>
<h3 id="current-state-online-only">2.1 Current State (Online-Only)</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│             CURRENT USER JOURNEY (ONLINE-ONLY)               │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  Budi starts shift                                           │
│      │                                                       │
│      ▼                                                       │
│  Opens app, waits for data to load ⏳ (30 seconds)           │
│      │                                                       │
│      ▼                                                       │
│  Starts scanning barcodes                                    │
│      │                                                       │
│      ▼                                                       │
│  WiFi drops 📶❌                                              │
│      │                                                       │
│      ▼                                                       │
│  ❌ App shows error: &quot;No connection&quot;                         │
│  ❌ Cannot scan barcodes                                     │
│  ❌ Budi waits, frustrated                                   │
│      │                                                       │
│      ▼                                                       │
│  WiFi returns (5 min later)                                  │
│      │                                                       │
│      ▼                                                       │
│  ❌ App needs to reload all data again                       │
│  ❌ 5 minutes of productive time lost                        │
│      │                                                       │
│      ▼                                                       │
│  Continues scanning                                          │
│      │                                                       │
│      ▼                                                       │
│  End of shift: Some scans may have been lost                 │
│                                                              │
│  TOTAL DOWNTIME: ~30 min/day per operator                    │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="future-state-local-first">2.2 Future State (Local-First)</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│             FUTURE USER JOURNEY (LOCAL-FIRST)                │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  Budi starts shift                                           │
│      │                                                       │
│      ▼                                                       │
│  Opens app, data already available ✅ (instant)              │
│  (synced in background since last session)                   │
│      │                                                       │
│      ▼                                                       │
│  Starts scanning barcodes                                    │
│  Each scan: instant feedback ✅                              │
│      │                                                       │
│      ▼                                                       │
│  WiFi drops 📶❌                                              │
│      │                                                       │
│      ▼                                                       │
│  ✅ App shows: &quot;Offline mode - changes will sync later&quot;      │
│  ✅ Budi continues scanning without interruption             │
│  ✅ All scans saved to local database                        │
│      │                                                       │
│      ▼                                                       │
│  WiFi returns (5 min later)                                  │
│      │                                                       │
│      ▼                                                       │
│  ✅ App background syncs changes (Budi doesn&#39;t notice)       │
│  ✅ &quot;12 items synced&quot; notification                           │
│      │                                                       │
│      ▼                                                       │
│  Continues scanning seamlessly                               │
│      │                                                       │
│      ▼                                                       │
│  End of shift: All data synced, zero loss ✅                 │
│                                                              │
│  TOTAL DOWNTIME: ~0 min/day per operator                     │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="ux-design-recommendations">3. UX Design Recommendations</h2>
<h3 id="sync-status-indicator">3.1 Sync Status Indicator</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                SYNC STATUS UI DESIGNS                        │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  OPTION A: Status Bar (Recommended)                          │
│  ───────────────────────────────────                         │
│  ┌──────────────────────────────────────────┐               │
│  │ ☰  Barcode Scanner              ✓ Synced │               │
│  ├──────────────────────────────────────────┤               │
│  │                                          │               │
│  │        [Main content area]               │               │
│  │                                          │               │
│  └──────────────────────────────────────────┘               │
│                                                              │
│  States:                                                     │
│  ✓ Synced (green)                                           │
│  ↻ Syncing... (blue, animated)                              │
│  ⚠ 3 pending (yellow)                                       │
│  ✗ Offline (red)                                            │
│                                                              │
│  ─────────────────────────────────────────────               │
│                                                              │
│  OPTION B: Floating Badge                                    │
│  ─────────────────────────                                   │
│  ┌──────────────────────────────────────────┐               │
│  │                                          │               │
│  │        [Main content area]               │               │
│  │                                          │               │
│  │                                    ┌───┐ │               │
│  │                                    │ 3 │ │  ← pending    │
│  │                                    └───┘ │    badge      │
│  └──────────────────────────────────────────┘               │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="offline-mode-banner">3.2 Offline Mode Banner</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                OFFLINE MODE BANNER                           │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────────────────────────────────────┐               │
│  │ 📶 You&#39;re offline                        │               │
│  │ Your changes will sync when connected    │               │
│  └──────────────────────────────────────────┘               │
│                                                              │
│  Behavior:                                                   │
│  • Slides down when connection lost                         │
│  • Background: muted orange (#FFF3CD)                       │
│  • Auto-dismisses when back online                          │
│  • &quot;Reconnecting...&quot; state while attempting                 │
│                                                              │
│  ─────────────────────────────────────────────               │
│                                                              │
│  Back online notification:                                   │
│  ┌──────────────────────────────────────────┐               │
│  │ ✓ Back online! 12 items synced           │               │
│  └──────────────────────────────────────────┘               │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="conflict-resolution-ui">3.3 Conflict Resolution UI</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│               CONFLICT RESOLUTION UI                         │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  For auto-resolved conflicts (notification only):            │
│                                                              │
│  ┌──────────────────────────────────────────┐               │
│  │ ⚠ Update conflict resolved                │               │
│  │ Barcode ABC123 was updated by John        │               │
│  │ Your change: &quot;QC OK&quot;                      │               │
│  │ Applied change: &quot;QC Failed&quot;               │               │
│  │                              [View] [OK]  │               │
│  └──────────────────────────────────────────┘               │
│                                                              │
│  ─────────────────────────────────────────────               │
│                                                              │
│  For manual resolution (rare, critical conflicts):           │
│                                                              │
│  ┌──────────────────────────────────────────┐               │
│  │ ⚠ Pairing conflict                        │               │
│  │                                          │               │
│  │ Barcode ABC123 was paired to:             │               │
│  │                                          │               │
│  │ ○ Parent-001 (by you, 10:30 AM)          │               │
│  │ ○ Parent-002 (by John, 10:32 AM)         │               │
│  │                                          │               │
│  │ [Ask Supervisor] [Keep Mine] [Keep John] │               │
│  └──────────────────────────────────────────┘               │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="user-communication-plan">4. User Communication Plan</h2>
<h3 id="training-materials">4.1 Training Materials</h3>
<table>
<thead>
<tr>
<th>Material</th>
<th>Audience</th>
<th>Format</th>
<th>Duration</th>
</tr>
</thead>
<tbody>
<tr>
<td>Quick Start Guide</td>
<td>All users</td>
<td>PDF/Video</td>
<td>5 min</td>
</tr>
<tr>
<td>Offline Mode Training</td>
<td>Operators</td>
<td>Video</td>
<td>10 min</td>
</tr>
<tr>
<td>Conflict Resolution</td>
<td>Supervisors</td>
<td>Video + Quiz</td>
<td>15 min</td>
</tr>
<tr>
<td>Admin Dashboard</td>
<td>Admins</td>
<td>Live training</td>
<td>1 hour</td>
</tr>
</tbody>
</table>
<h3 id="key-messages">4.2 Key Messages</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                KEY USER MESSAGES                             │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  MESSAGE 1: &quot;Your work is always saved&quot;                      │
│  ─────────────────────────────────────                       │
│  &quot;Even without internet, every scan you make is saved       │
│   on your device. When internet returns, it syncs           │
│   automatically. You never lose work.&quot;                       │
│                                                              │
│  MESSAGE 2: &quot;Keep working, we handle the rest&quot;               │
│  ──────────────────────────────────────────                  │
│  &quot;See the offline icon? Don&#39;t worry! Just keep scanning.    │
│   The app will sync everything when connected.&quot;             │
│                                                              │
│  MESSAGE 3: &quot;Conflicts are rare, but we&#39;ve got you&quot;          │
│  ────────────────────────────────────────────────            │
│  &quot;If two people edit the same thing, we pick the latest.    │
│   You&#39;ll see a notification if your change was replaced.&quot;   │
│                                                              │
│  MESSAGE 4: &quot;Check the sync status&quot;                          │
│  ─────────────────────────────────                           │
│  &quot;The icon at the top shows sync status:                     │
│   ✓ = All good, ⚠ = Some pending, ✗ = Offline&quot;              │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="user-feedback-mechanisms">5. User Feedback Mechanisms</h2>
<h3 id="in-app-feedback">5.1 In-App Feedback</h3>
<pre><code>Trigger points for feedback collection:

1. After first week of use
   → &quot;How&#39;s the new offline mode working for you?&quot;
   → Rating 1-5 + optional comment

2. After conflict resolution
   → &quot;Was this conflict easy to understand?&quot;
   → Yes/No + optional comment

3. After large sync (&gt;1000 items)
   → &quot;How was the sync experience?&quot;
   → Rating 1-5

4. Error recovery
   → &quot;Did the app recover correctly?&quot;
   → Yes/No</code></pre>
<h3 id="analytics-to-track">5.2 Analytics to Track</h3>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Purpose</th>
<th>Target</th>
</tr>
</thead>
<tbody>
<tr>
<td>Offline session duration</td>
<td>Understand offline patterns</td>
<td>Track avg</td>
</tr>
<tr>
<td>Sync success rate</td>
<td>Reliability</td>
<td>&gt; 99.9%</td>
</tr>
<tr>
<td>Conflict frequency</td>
<td>Workflow issues</td>
<td>&lt; 1% of ops</td>
</tr>
<tr>
<td>Pending items at logout</td>
<td>User awareness</td>
<td>&lt; 10 avg</td>
</tr>
<tr>
<td>Time to first scan</td>
<td>App startup perf</td>
<td>&lt; 3 sec</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="rollout-strategy">6. Rollout Strategy</h2>
<h3 id="phased-rollout">6.1 Phased Rollout</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                 ROLLOUT PHASES                               │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  PHASE 1: Internal Testing (Week 1-2)                        │
│  ─────────────────────────────────                           │
│  • 5 internal users                                         │
│  • All features enabled                                     │
│  • Direct feedback channel                                  │
│  • Fix critical issues                                      │
│                                                              │
│  PHASE 2: Beta Vendor (Week 3-4)                            │
│  ─────────────────────────────                               │
│  • 1 vendor (50 users)                                      │
│  • On-site training                                         │
│  • Daily check-ins                                          │
│  • Gather usage patterns                                    │
│                                                              │
│  PHASE 3: Expanded Beta (Week 5-6)                          │
│  ─────────────────────────────────                           │
│  • 3 more vendors (150 users)                               │
│  • Remote training                                          │
│  • Weekly feedback sessions                                 │
│                                                              │
│  PHASE 4: General Availability (Week 7+)                    │
│  ──────────────────────────────────────                      │
│  • All vendors                                              │
│  • Self-serve training materials                            │
│  • Normal support channels                                  │
│                                                              │
│  ROLLBACK PLAN:                                              │
│  • Feature flag to disable offline mode                     │
│  • Revert to online-only if critical issues                 │
│  • Data preserved in both modes                             │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="success-criteria-per-phase">6.2 Success Criteria per Phase</h3>
<table>
<thead>
<tr>
<th>Phase</th>
<th>Criteria</th>
<th>Threshold</th>
</tr>
</thead>
<tbody>
<tr>
<td>Phase 1</td>
<td>No data loss</td>
<td>100%</td>
</tr>
<tr>
<td>Phase 1</td>
<td>Sync success</td>
<td>&gt; 95%</td>
</tr>
<tr>
<td>Phase 2</td>
<td>User satisfaction</td>
<td>&gt; 4/5</td>
</tr>
<tr>
<td>Phase 2</td>
<td>Downtime related tickets</td>
<td>-50%</td>
</tr>
<tr>
<td>Phase 3</td>
<td>Conflict resolution rate</td>
<td>&gt; 99% auto</td>
</tr>
<tr>
<td>Phase 4</td>
<td>Adoption rate</td>
<td>&gt; 90% active users</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="support-considerations">7. Support Considerations</h2>
<h3 id="new-support-scenarios">7.1 New Support Scenarios</h3>
<table>
<colgroup>
<col style="width: 30%" />
<col style="width: 33%" />
<col style="width: 36%" />
</colgroup>
<thead>
<tr>
<th>Scenario</th>
<th>User Says</th>
<th>Resolution</th>
</tr>
</thead>
<tbody>
<tr>
<td>Pending items stuck</td>
<td>“It says 5 pending for hours”</td>
<td>Check connectivity, force sync</td>
</tr>
<tr>
<td>Data mismatch</td>
<td>“My scan is missing”</td>
<td>Check conflict log, verify sync</td>
</tr>
<tr>
<td>Slow sync</td>
<td>“Sync takes forever”</td>
<td>Check data volume, network</td>
</tr>
<tr>
<td>Can’t pair</td>
<td>“Barcode won’t pair”</td>
<td>Check if already paired (conflict)</td>
</tr>
</tbody>
</table>
<h3 id="support-tools-needed">7.2 Support Tools Needed</h3>
<ul class="task-list">
<li><label><input type="checkbox" />Admin dashboard with device sync
status</label></li>
<li><label><input type="checkbox" />Ability to view pending items per
device</label></li>
<li><label><input type="checkbox" />Force sync trigger for specific
device</label></li>
<li><label><input type="checkbox" />Conflict log viewer</label></li>
<li><label><input type="checkbox" />Device sync history</label></li>
</ul>
<hr />
<h2 id="expected-outcomes">8. Expected Outcomes</h2>
<h3 id="quantitative-benefits">8.1 Quantitative Benefits</h3>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Before</th>
<th>After</th>
<th>Improvement</th>
</tr>
</thead>
<tbody>
<tr>
<td>Daily downtime/user</td>
<td>30 min</td>
<td>~0 min</td>
<td>-100%</td>
</tr>
<tr>
<td>Scan success rate</td>
<td>95%</td>
<td>99.9%</td>
<td>+5%</td>
</tr>
<tr>
<td>Data loss incidents</td>
<td>2/month</td>
<td>0/month</td>
<td>-100%</td>
</tr>
<tr>
<td>Support tickets (sync)</td>
<td>50/week</td>
<td>10/week</td>
<td>-80%</td>
</tr>
</tbody>
</table>
<h3 id="qualitative-benefits">8.2 Qualitative Benefits</h3>
<ul>
<li>✅ Reduced user frustration</li>
<li>✅ Higher confidence in system reliability</li>
<li>✅ Faster onboarding (app works anywhere)</li>
<li>✅ Better field operation flexibility</li>
<li>✅ Improved data accuracy</li>
</ul>
<h1 id="implementation-plan">Implementation Plan</h1>
<h2 id="phased-rollout-for-electricsql-local-first-sync">Phased Rollout
for ElectricSQL Local-First Sync</h2>
<hr />
<h2 id="project-timeline">1. Project Timeline</h2>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                   PROJECT TIMELINE                           │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  PHASE 1: FOUNDATION (Week 1-2)                              │
│  ├── Infrastructure setup                                   │
│  ├── ElectricSQL deployment                                 │
│  └── Database preparation                                   │
│                                                              │
│  PHASE 2: CORE SYNC (Week 3-4)                               │
│  ├── Shape definitions                                      │
│  ├── Client library integration                             │
│  └── Basic sync functionality                               │
│                                                              │
│  PHASE 3: OFFLINE CAPABILITY (Week 5-6)                      │
│  ├── Offline queue implementation                           │
│  ├── Conflict resolution logic                              │
│  └── UI sync indicators                                     │
│                                                              │
│  PHASE 4: TESTING &amp; HARDENING (Week 7-8)                     │
│  ├── Load testing                                           │
│  ├── Chaos engineering                                      │
│  └── Security audit                                         │
│                                                              │
│  PHASE 5: ROLLOUT (Week 9-12)                                │
│  ├── Beta testing                                           │
│  ├── User training                                          │
│  └── General availability                                   │
│                                                              │
│  TOTAL: 12 weeks                                             │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="phase-1-foundation-week-1-2">2. Phase 1: Foundation (Week
1-2)</h2>
<h3 id="infrastructure-tasks">2.1 Infrastructure Tasks</h3>
<table>
<colgroup>
<col style="width: 16%" />
<col style="width: 18%" />
<col style="width: 27%" />
<col style="width: 37%" />
</colgroup>
<thead>
<tr>
<th>Task</th>
<th>Owner</th>
<th>Duration</th>
<th>Dependencies</th>
</tr>
</thead>
<tbody>
<tr>
<td>Deploy PostgreSQL with logical replication</td>
<td>DevOps</td>
<td>2 days</td>
<td>None</td>
</tr>
<tr>
<td>Deploy ElectricSQL service</td>
<td>DevOps</td>
<td>2 days</td>
<td>PostgreSQL</td>
</tr>
<tr>
<td>Configure load balancer</td>
<td>DevOps</td>
<td>1 day</td>
<td>ElectricSQL</td>
</tr>
<tr>
<td>Set up monitoring (Prometheus/Grafana)</td>
<td>DevOps</td>
<td>1 day</td>
<td>ElectricSQL</td>
</tr>
<tr>
<td>Configure TLS certificates</td>
<td>DevOps</td>
<td>1 day</td>
<td>Load balancer</td>
</tr>
</tbody>
</table>
<h3 id="database-preparation">2.2 Database Preparation</h3>
<div class="sourceCode" id="cb80"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Enable logical replication (postgresql.conf)</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>wal_level <span class="op">=</span> logical</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- Create publication for Electric</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> PUBLICATION electric_pub <span class="cf">FOR</span> <span class="kw">TABLE</span></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>  app_barcode.bc_batch,</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>  app_barcode.bc_parent,</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>  app_barcode.bc_barcode,</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>  app_barcode.bc_token,</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>  app_barcode.bc_config,</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>  app_barcode.bc_pair_brcdxparent;</span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a><span class="co">-- Enable RLS on sync tables</span></span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> app_barcode.bc_barcode <span class="kw">ENABLE</span> <span class="kw">ROW</span> <span class="kw">LEVEL</span> SECURITY;</span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> app_barcode.bc_parent <span class="kw">ENABLE</span> <span class="kw">ROW</span> <span class="kw">LEVEL</span> SECURITY;</span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a><span class="co">-- Create RLS policies</span></span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> POLICY vendor_isolation <span class="kw">ON</span> app_barcode.bc_barcode</span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">USING</span> (vendor_code <span class="op">=</span> current_setting(<span class="st">&#39;app.vendor_code&#39;</span>):<span class="ch">:text</span>);</span></code></pre></div>
<h3 id="deliverables">2.3 Deliverables</h3>
<ul class="task-list">
<li><label><input type="checkbox" />PostgreSQL deployed with WAL level =
logical</label></li>
<li><label><input type="checkbox" />ElectricSQL running and connected to
PostgreSQL</label></li>
<li><label><input type="checkbox" />HTTPS endpoint
accessible</label></li>
<li><label><input type="checkbox" />Basic health monitoring in
place</label></li>
<li><label><input type="checkbox" />RLS policies created</label></li>
</ul>
<hr />
<h2 id="phase-2-core-sync-week-3-4">3. Phase 2: Core Sync (Week
3-4)</h2>
<h3 id="backend-tasks">3.1 Backend Tasks</h3>
<table>
<thead>
<tr>
<th>Task</th>
<th>Owner</th>
<th>Duration</th>
</tr>
</thead>
<tbody>
<tr>
<td>Define shape configurations</td>
<td>Backend</td>
<td>2 days</td>
</tr>
<tr>
<td>Implement JWT auth for Electric</td>
<td>Backend</td>
<td>2 days</td>
</tr>
<tr>
<td>Create sync status API endpoints</td>
<td>Backend</td>
<td>1 day</td>
</tr>
<tr>
<td>Write shape authorization rules</td>
<td>Backend</td>
<td>2 days</td>
</tr>
</tbody>
</table>
<h3 id="shape-definitions-2">3.2 Shape Definitions</h3>
<div class="sourceCode" id="cb81"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># electric-config.yaml</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="fu">shapes</span><span class="kw">:</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">vendor_master</span><span class="kw">:</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">tables</span><span class="kw">:</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> bc_batch</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> bc_config</span></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">where</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;vendor_code = :vendor_code AND is_deleted = false&quot;</span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">batch_data</span><span class="kw">:</span></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">tables</span><span class="kw">:</span></span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> bc_parent</span></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> bc_barcode</span></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> bc_token</span></span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">where</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;batch_id = :batch_id AND is_deleted = false&quot;</span></span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a><span class="at">    </span></span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">pairing_logs</span><span class="kw">:</span></span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">tables</span><span class="kw">:</span></span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> bc_pair_brcdxparent</span></span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">where</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;vendor_code = :vendor_code AND created_at &gt; now() - interval &#39;7 days&#39;&quot;</span></span></code></pre></div>
<h3 id="client-integration">3.3 Client Integration</h3>
<table>
<thead>
<tr>
<th>Task</th>
<th>Owner</th>
<th>Duration</th>
</tr>
</thead>
<tbody>
<tr>
<td>Add electric-sql client library</td>
<td>Frontend</td>
<td>1 day</td>
</tr>
<tr>
<td>Implement SQLite local storage</td>
<td>Frontend</td>
<td>2 days</td>
</tr>
<tr>
<td>Create sync service wrapper</td>
<td>Frontend</td>
<td>2 days</td>
</tr>
<tr>
<td>Integrate with existing UI</td>
<td>Frontend</td>
<td>3 days</td>
</tr>
</tbody>
</table>
<h3 id="deliverables-1">3.4 Deliverables</h3>
<ul class="task-list">
<li><label><input type="checkbox" />Shapes defined and
tested</label></li>
<li><label><input type="checkbox" />JWT auth working with
Electric</label></li>
<li><label><input type="checkbox" />Client can sync data from
server</label></li>
<li><label><input type="checkbox" />Data visible in local
SQLite</label></li>
<li><label><input type="checkbox" />Basic CRUD operations
working</label></li>
</ul>
<hr />
<h2 id="phase-3-offline-capability-week-5-6">4. Phase 3: Offline
Capability (Week 5-6)</h2>
<h3 id="offline-queue-1">4.1 Offline Queue</h3>
<table>
<thead>
<tr>
<th>Task</th>
<th>Owner</th>
<th>Duration</th>
</tr>
</thead>
<tbody>
<tr>
<td>Implement pending_operations table</td>
<td>Frontend</td>
<td>1 day</td>
</tr>
<tr>
<td>Create write interceptor</td>
<td>Frontend</td>
<td>2 days</td>
</tr>
<tr>
<td>Implement queue processor</td>
<td>Frontend</td>
<td>2 days</td>
</tr>
<tr>
<td>Add retry logic with backoff</td>
<td>Frontend</td>
<td>1 day</td>
</tr>
</tbody>
</table>
<h3 id="conflict-resolution">4.2 Conflict Resolution</h3>
<table>
<thead>
<tr>
<th>Task</th>
<th>Owner</th>
<th>Duration</th>
</tr>
</thead>
<tbody>
<tr>
<td>Implement CRDT merge for barcode</td>
<td>Backend/Frontend</td>
<td>2 days</td>
</tr>
<tr>
<td>Add first-write-wins for pairing</td>
<td>Backend</td>
<td>1 day</td>
</tr>
<tr>
<td>Create conflict notification system</td>
<td>Frontend</td>
<td>2 days</td>
</tr>
<tr>
<td>Server-side validation for conflicts</td>
<td>Backend</td>
<td>2 days</td>
</tr>
</tbody>
</table>
<h3 id="ui-components">4.3 UI Components</h3>
<table>
<thead>
<tr>
<th>Task</th>
<th>Owner</th>
<th>Duration</th>
</tr>
</thead>
<tbody>
<tr>
<td>Sync status indicator</td>
<td>Frontend</td>
<td>1 day</td>
</tr>
<tr>
<td>Offline mode banner</td>
<td>Frontend</td>
<td>1 day</td>
</tr>
<tr>
<td>Pending items badge</td>
<td>Frontend</td>
<td>1 day</td>
</tr>
<tr>
<td>Conflict resolution modal</td>
<td>Frontend</td>
<td>2 days</td>
</tr>
</tbody>
</table>
<h3 id="deliverables-2">4.4 Deliverables</h3>
<ul class="task-list">
<li><label><input type="checkbox" />Offline writes queued and
processed</label></li>
<li><label><input type="checkbox" />Conflicts auto-resolved via
CRDT</label></li>
<li><label><input type="checkbox" />Manual resolution UI for edge
cases</label></li>
<li><label><input type="checkbox" />Clear sync status in UI</label></li>
<li><label><input type="checkbox" />Graceful offline/online
transitions</label></li>
</ul>
<hr />
<h2 id="phase-4-testing-hardening-week-7-8">5. Phase 4: Testing &amp;
Hardening (Week 7-8)</h2>
<h3 id="load-testing">5.1 Load Testing</h3>
<table>
<thead>
<tr>
<th>Test</th>
<th>Tool</th>
<th>Target</th>
</tr>
</thead>
<tbody>
<tr>
<td>Concurrent connections</td>
<td>k6</td>
<td>10,000 connections</td>
</tr>
<tr>
<td>Sync throughput</td>
<td>k6</td>
<td>1,000 ops/sec</td>
</tr>
<tr>
<td>Initial sync time</td>
<td>Custom</td>
<td>&lt; 30 sec for 100K rows</td>
</tr>
<tr>
<td>Reconnection storm</td>
<td>Custom</td>
<td>1,000 simultaneous reconnects</td>
</tr>
</tbody>
</table>
<h3 id="chaos-engineering">5.2 Chaos Engineering</h3>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 25%" />
<col style="width: 56%" />
</colgroup>
<thead>
<tr>
<th>Test</th>
<th>Method</th>
<th>Expected Outcome</th>
</tr>
</thead>
<tbody>
<tr>
<td>Network partition</td>
<td>tc netem</td>
<td>Client continues offline</td>
</tr>
<tr>
<td>Electric pod crash</td>
<td>kubectl delete</td>
<td>K8s restarts, clients reconnect</td>
</tr>
<tr>
<td>PostgreSQL failover</td>
<td>pg_ctl stop</td>
<td>Replica promoted, no data loss</td>
</tr>
<tr>
<td>Full sync after 7 days offline</td>
<td>Manual</td>
<td>Complete resync successful</td>
</tr>
</tbody>
</table>
<h3 id="security-audit">5.3 Security Audit</h3>
<ul class="task-list">
<li><label><input type="checkbox" />Penetration testing</label></li>
<li><label><input type="checkbox" />JWT implementation
review</label></li>
<li><label><input type="checkbox" />RLS policy verification</label></li>
<li><label><input type="checkbox" />Data exposure analysis</label></li>
<li><label><input type="checkbox" />Dependency vulnerability
scan</label></li>
</ul>
<h3 id="deliverables-3">5.4 Deliverables</h3>
<ul class="task-list">
<li><label><input type="checkbox" />Load test report with
recommendations</label></li>
<li><label><input type="checkbox" />Chaos test results
documented</label></li>
<li><label><input type="checkbox" />Security audit passed</label></li>
<li><label><input type="checkbox" />Performance optimizations
applied</label></li>
<li><label><input type="checkbox" />Runbooks created for incident
response</label></li>
</ul>
<hr />
<h2 id="phase-5-rollout-week-9-12">6. Phase 5: Rollout (Week 9-12)</h2>
<h3 id="beta-testing-week-9-10">6.1 Beta Testing (Week 9-10)</h3>
<table>
<thead>
<tr>
<th>Week</th>
<th>Scope</th>
<th>Users</th>
</tr>
</thead>
<tbody>
<tr>
<td>Week 9</td>
<td>Internal team</td>
<td>5</td>
</tr>
<tr>
<td>Week 10</td>
<td>Single vendor</td>
<td>50</td>
</tr>
</tbody>
</table>
<h3 id="training-week-11">6.2 Training (Week 11)</h3>
<table>
<thead>
<tr>
<th>Material</th>
<th>Audience</th>
<th>Delivery</th>
</tr>
</thead>
<tbody>
<tr>
<td>Quick Start Guide</td>
<td>All users</td>
<td>Self-serve</td>
</tr>
<tr>
<td>Offline Mode Video</td>
<td>Operators</td>
<td>Async</td>
</tr>
<tr>
<td>Admin Training</td>
<td>Admins</td>
<td>Live session</td>
</tr>
<tr>
<td>Support Runbook</td>
<td>Support team</td>
<td>Classroom</td>
</tr>
</tbody>
</table>
<h3 id="general-availability-week-12">6.3 General Availability (Week
12)</h3>
<ul class="task-list">
<li><label><input type="checkbox" />Feature flag enabled for all
vendors</label></li>
<li><label><input type="checkbox" />Monitoring dashboards
active</label></li>
<li><label><input type="checkbox" />Support team trained</label></li>
<li><label><input type="checkbox" />Rollback plan tested</label></li>
<li><label><input type="checkbox" />Success metrics
tracking</label></li>
</ul>
<hr />
<h2 id="resource-requirements">7. Resource Requirements</h2>
<h3 id="team">7.1 Team</h3>
<table>
<thead>
<tr>
<th>Role</th>
<th>FTE</th>
<th>Duration</th>
</tr>
</thead>
<tbody>
<tr>
<td>Backend Developer</td>
<td>1.5</td>
<td>12 weeks</td>
</tr>
<tr>
<td>Frontend Developer</td>
<td>1.5</td>
<td>10 weeks</td>
</tr>
<tr>
<td>DevOps Engineer</td>
<td>0.5</td>
<td>12 weeks</td>
</tr>
<tr>
<td>QA Engineer</td>
<td>1.0</td>
<td>6 weeks</td>
</tr>
<tr>
<td>Product Manager</td>
<td>0.5</td>
<td>12 weeks</td>
</tr>
</tbody>
</table>
<h3 id="infrastructure-cost">7.2 Infrastructure Cost</h3>
<table>
<thead>
<tr>
<th>Component</th>
<th>Monthly Cost</th>
</tr>
</thead>
<tbody>
<tr>
<td>Electric pods (3x)</td>
<td>$300</td>
</tr>
<tr>
<td>PostgreSQL (RDS)</td>
<td>$400</td>
</tr>
<tr>
<td>Load Balancer</td>
<td>$50</td>
</tr>
<tr>
<td>Monitoring</td>
<td>$100</td>
</tr>
<tr>
<td><strong>Total</strong></td>
<td><strong>$850/month</strong></td>
</tr>
</tbody>
</table>
<hr />
<h2 id="risk-mitigation">8. Risk Mitigation</h2>
<table>
<thead>
<tr>
<th>Risk</th>
<th>Likelihood</th>
<th>Impact</th>
<th>Mitigation</th>
</tr>
</thead>
<tbody>
<tr>
<td>Electric instability</td>
<td>Medium</td>
<td>High</td>
<td>Fallback to REST API</td>
</tr>
<tr>
<td>Performance issues</td>
<td>Medium</td>
<td>Medium</td>
<td>Progressive rollout</td>
</tr>
<tr>
<td>User resistance</td>
<td>Low</td>
<td>Medium</td>
<td>Training + champions</td>
</tr>
<tr>
<td>Data migration issues</td>
<td>Low</td>
<td>High</td>
<td>Keep both systems parallel</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="success-metrics-1">9. Success Metrics</h2>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Baseline</th>
<th>Target</th>
<th>Measurement</th>
</tr>
</thead>
<tbody>
<tr>
<td>Offline availability</td>
<td>0%</td>
<td>100%</td>
<td>Feature works offline</td>
</tr>
<tr>
<td>Sync success rate</td>
<td>N/A</td>
<td>99.9%</td>
<td>Monitoring</td>
</tr>
<tr>
<td>User satisfaction</td>
<td>N/A</td>
<td>4.5/5</td>
<td>Survey</td>
</tr>
<tr>
<td>Support tickets (sync)</td>
<td>50/week</td>
<td>10/week</td>
<td>Ticket tracking</td>
</tr>
<tr>
<td>Data loss incidents</td>
<td>2/month</td>
<td>0/month</td>
<td>Incident reports</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="checklist-for-go-live">10. Checklist for Go-Live</h2>
<h3 id="technical-readiness">Technical Readiness</h3>
<ul class="task-list">
<li><label><input type="checkbox" />All phases completed</label></li>
<li><label><input type="checkbox" />Load testing passed</label></li>
<li><label><input type="checkbox" />Security audit passed</label></li>
<li><label><input type="checkbox" />Monitoring configured</label></li>
<li><label><input type="checkbox" />Alerting configured</label></li>
<li><label><input type="checkbox" />Runbooks documented</label></li>
<li><label><input type="checkbox" />Rollback tested</label></li>
</ul>
<h3 id="business-readiness">Business Readiness</h3>
<ul class="task-list">
<li><label><input type="checkbox" />Training materials
ready</label></li>
<li><label><input type="checkbox" />Support team trained</label></li>
<li><label><input type="checkbox" />User communication sent</label></li>
<li><label><input type="checkbox" />Success metrics defined</label></li>
<li><label><input type="checkbox" />Stakeholder sign-off</label></li>
</ul>
<h1 id="proof-of-concept">Proof of Concept</h1>
<h2 id="electricsql-local-first-sync-demo">ElectricSQL Local-First Sync
Demo</h2>
<hr />
<h2 id="poc-objectives">1. POC Objectives</h2>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                    POC OBJECTIVES                            │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  1. Validate ElectricSQL with PostgreSQL                    │
│  2. Demonstrate real-time sync across devices               │
│  3. Test offline capability                                 │
│  4. Measure sync performance                                │
│  5. Identify integration challenges                         │
│                                                              │
│  SUCCESS CRITERIA:                                           │
│  ✓ Sync 10,000 barcodes in &lt; 60 seconds                     │
│  ✓ Offline writes sync correctly on reconnect               │
│  ✓ Conflicts resolved automatically                         │
│  ✓ No data loss in any scenario                             │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="poc-architecture">2. POC Architecture</h2>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                    POC ARCHITECTURE                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐   │
│  │   Device A  │     │   Device B  │     │   Device C  │   │
│  │  (Mobile)   │     │  (Tablet)   │     │   (Web)     │   │
│  │  SQLite     │     │  SQLite     │     │  IndexedDB  │   │
│  └──────┬──────┘     └──────┬──────┘     └──────┬──────┘   │
│         │                   │                   │           │
│         └───────────────────┼───────────────────┘           │
│                             │                               │
│                     ┌───────┴───────┐                       │
│                     │  Electric     │                       │
│                     │  (Docker)     │                       │
│                     └───────┬───────┘                       │
│                             │                               │
│                     ┌───────┴───────┐                       │
│                     │  PostgreSQL   │                       │
│                     │  (Docker)     │                       │
│                     └───────────────┘                       │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="setup-instructions">3. Setup Instructions</h2>
<h3 id="docker-compose">3.1 Docker Compose</h3>
<div class="sourceCode" id="cb84"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># docker-compose.poc.yaml</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="fu">version</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;3.8&#39;</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">postgres</span><span class="kw">:</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> postgres:16</span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">POSTGRES_DB</span><span class="kw">:</span><span class="at"> barcode_poc</span></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">POSTGRES_USER</span><span class="kw">:</span><span class="at"> postgres</span></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">POSTGRES_PASSWORD</span><span class="kw">:</span><span class="at"> postgres</span></span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">command</span><span class="kw">:</span><span class="at"> </span></span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> postgres</span></span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> -c</span></span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> wal_level=logical</span></span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;5432:5432&quot;</span></span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> pg_data:/var/lib/postgresql/data</span></span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> ./init.sql:/docker-entrypoint-initdb.d/init.sql</span></span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">electric</span><span class="kw">:</span></span>
<span id="cb84-22"><a href="#cb84-22" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> electricsql/electric:latest</span></span>
<span id="cb84-23"><a href="#cb84-23" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb84-24"><a href="#cb84-24" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">DATABASE_URL</span><span class="kw">:</span><span class="at"> postgresql://postgres:postgres@postgres:5432/barcode_poc</span></span>
<span id="cb84-25"><a href="#cb84-25" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">AUTH_MODE</span><span class="kw">:</span><span class="at"> insecure</span><span class="co">  # For POC only</span></span>
<span id="cb84-26"><a href="#cb84-26" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">ELECTRIC_WRITE_TO_PG_MODE</span><span class="kw">:</span><span class="at"> direct_writes</span></span>
<span id="cb84-27"><a href="#cb84-27" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb84-28"><a href="#cb84-28" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;5133:5133&quot;</span></span>
<span id="cb84-29"><a href="#cb84-29" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">depends_on</span><span class="kw">:</span></span>
<span id="cb84-30"><a href="#cb84-30" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> postgres</span></span>
<span id="cb84-31"><a href="#cb84-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-32"><a href="#cb84-32" aria-hidden="true" tabindex="-1"></a><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb84-33"><a href="#cb84-33" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">pg_data</span><span class="kw">:</span></span></code></pre></div>
<h3 id="database-schema">3.2 Database Schema</h3>
<div class="sourceCode" id="cb85"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- init.sql</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">SCHEMA</span> <span class="cf">IF</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> app_barcode;</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> app_barcode.bc_batch (</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> SERIAL <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>    vendor_code <span class="dt">VARCHAR</span>(<span class="dv">100</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>    name <span class="dt">VARCHAR</span>(<span class="dv">300</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>    is_active <span class="dt">BOOLEAN</span> <span class="kw">DEFAULT</span> <span class="kw">FALSE</span>,</span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>    is_deleted <span class="dt">BOOLEAN</span> <span class="kw">DEFAULT</span> <span class="kw">FALSE</span>,</span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>    created_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> NOW(),</span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>    updated_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> NOW()</span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> app_barcode.bc_parent (</span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> SERIAL <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a>    vendor_code <span class="dt">VARCHAR</span>(<span class="dv">100</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb85-17"><a href="#cb85-17" aria-hidden="true" tabindex="-1"></a>    batch_id <span class="dt">INTEGER</span> <span class="kw">REFERENCES</span> app_barcode.bc_batch(<span class="kw">id</span>),</span>
<span id="cb85-18"><a href="#cb85-18" aria-hidden="true" tabindex="-1"></a>    code <span class="dt">VARCHAR</span>(<span class="dv">200</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb85-19"><a href="#cb85-19" aria-hidden="true" tabindex="-1"></a>    qty <span class="dt">INTEGER</span> <span class="kw">DEFAULT</span> <span class="dv">0</span>,</span>
<span id="cb85-20"><a href="#cb85-20" aria-hidden="true" tabindex="-1"></a>    is_deleted <span class="dt">BOOLEAN</span> <span class="kw">DEFAULT</span> <span class="kw">FALSE</span>,</span>
<span id="cb85-21"><a href="#cb85-21" aria-hidden="true" tabindex="-1"></a>    created_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> NOW()</span>
<span id="cb85-22"><a href="#cb85-22" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb85-23"><a href="#cb85-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-24"><a href="#cb85-24" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> app_barcode.bc_barcode (</span>
<span id="cb85-25"><a href="#cb85-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> SERIAL <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb85-26"><a href="#cb85-26" aria-hidden="true" tabindex="-1"></a>    vendor_code <span class="dt">VARCHAR</span>(<span class="dv">100</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb85-27"><a href="#cb85-27" aria-hidden="true" tabindex="-1"></a>    batch_id <span class="dt">INTEGER</span> <span class="kw">REFERENCES</span> app_barcode.bc_batch(<span class="kw">id</span>),</span>
<span id="cb85-28"><a href="#cb85-28" aria-hidden="true" tabindex="-1"></a>    parent_id <span class="dt">INTEGER</span> <span class="kw">REFERENCES</span> app_barcode.bc_parent(<span class="kw">id</span>),</span>
<span id="cb85-29"><a href="#cb85-29" aria-hidden="true" tabindex="-1"></a>    barcode <span class="dt">VARCHAR</span>(<span class="dv">200</span>) <span class="kw">UNIQUE</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb85-30"><a href="#cb85-30" aria-hidden="true" tabindex="-1"></a>    note TEXT,</span>
<span id="cb85-31"><a href="#cb85-31" aria-hidden="true" tabindex="-1"></a>    is_deleted <span class="dt">BOOLEAN</span> <span class="kw">DEFAULT</span> <span class="kw">FALSE</span>,</span>
<span id="cb85-32"><a href="#cb85-32" aria-hidden="true" tabindex="-1"></a>    created_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> NOW(),</span>
<span id="cb85-33"><a href="#cb85-33" aria-hidden="true" tabindex="-1"></a>    updated_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> NOW()</span>
<span id="cb85-34"><a href="#cb85-34" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb85-35"><a href="#cb85-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-36"><a href="#cb85-36" aria-hidden="true" tabindex="-1"></a><span class="co">-- Seed data</span></span>
<span id="cb85-37"><a href="#cb85-37" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> app_barcode.bc_batch (vendor_code, name, is_active) </span>
<span id="cb85-38"><a href="#cb85-38" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span> (<span class="st">&#39;VENDOR_A&#39;</span>, <span class="st">&#39;POC Batch 1&#39;</span>, <span class="kw">true</span>);</span>
<span id="cb85-39"><a href="#cb85-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-40"><a href="#cb85-40" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> app_barcode.bc_parent (vendor_code, batch_id, code, qty)</span>
<span id="cb85-41"><a href="#cb85-41" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="st">&#39;VENDOR_A&#39;</span>, <span class="dv">1</span>, <span class="st">&#39;PARENT-&#39;</span> <span class="op">||</span> i, <span class="dv">10</span></span>
<span id="cb85-42"><a href="#cb85-42" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> generate_series(<span class="dv">1</span>, <span class="dv">100</span>) <span class="kw">AS</span> i;</span>
<span id="cb85-43"><a href="#cb85-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-44"><a href="#cb85-44" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> app_barcode.bc_barcode (vendor_code, batch_id, barcode)</span>
<span id="cb85-45"><a href="#cb85-45" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="st">&#39;VENDOR_A&#39;</span>, <span class="dv">1</span>, <span class="st">&#39;BC-&#39;</span> <span class="op">||</span> <span class="fu">LPAD</span>(i:<span class="ch">:text</span>, <span class="dv">6</span>, <span class="st">&#39;0&#39;</span>)</span>
<span id="cb85-46"><a href="#cb85-46" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> generate_series(<span class="dv">1</span>, <span class="dv">10000</span>) <span class="kw">AS</span> i;</span></code></pre></div>
<h3 id="client-setup-react">3.3 Client Setup (React)</h3>
<div class="sourceCode" id="cb86"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create POC client</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="ex">npx</span> create-vite@latest poc-client <span class="at">--template</span> react-ts</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> poc-client</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Install dependencies</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> install @electric-sql/client better-sqlite3</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> install <span class="at">-D</span> @electric-sql/cli</span></code></pre></div>
<h3 id="client-code">3.4 Client Code</h3>
<div class="sourceCode" id="cb87"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co">// src/electric.ts</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { ElectricClient<span class="op">,</span> ShapeStream } <span class="im">from</span> <span class="st">&#39;@electric-sql/client&#39;</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> ELECTRIC_URL <span class="op">=</span> <span class="st">&#39;http://localhost:5133&#39;</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">async</span> <span class="kw">function</span> <span class="fu">createShape</span>(batchId<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> stream <span class="op">=</span> <span class="kw">new</span> <span class="fu">ShapeStream</span>({</span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>    url<span class="op">:</span> <span class="vs">`</span><span class="sc">${</span>ELECTRIC_URL<span class="sc">}</span><span class="vs">/v1/shape`</span><span class="op">,</span></span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>    params<span class="op">:</span> {</span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>      table<span class="op">:</span> <span class="st">&#39;app_barcode.bc_barcode&#39;</span><span class="op">,</span></span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>      where<span class="op">:</span> <span class="vs">`batch_id = </span><span class="sc">${</span>batchId<span class="sc">}</span><span class="vs"> AND is_deleted = false`</span></span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb87-15"><a href="#cb87-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> stream</span>
<span id="cb87-16"><a href="#cb87-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb87-17"><a href="#cb87-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-18"><a href="#cb87-18" aria-hidden="true" tabindex="-1"></a><span class="co">// src/App.tsx</span></span>
<span id="cb87-19"><a href="#cb87-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { useState<span class="op">,</span> useEffect } <span class="im">from</span> <span class="st">&#39;react&#39;</span></span>
<span id="cb87-20"><a href="#cb87-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { createShape } <span class="im">from</span> <span class="st">&#39;./electric&#39;</span></span>
<span id="cb87-21"><a href="#cb87-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-22"><a href="#cb87-22" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">App</span>() {</span>
<span id="cb87-23"><a href="#cb87-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> [barcodes<span class="op">,</span> setBarcodes] <span class="op">=</span> <span class="fu">useState</span>([])</span>
<span id="cb87-24"><a href="#cb87-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> [syncStatus<span class="op">,</span> setSyncStatus] <span class="op">=</span> <span class="fu">useState</span>(<span class="st">&#39;connecting&#39;</span>)</span>
<span id="cb87-25"><a href="#cb87-25" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> [lastSync<span class="op">,</span> setLastSync] <span class="op">=</span> <span class="fu">useState</span>(<span class="kw">null</span>)</span>
<span id="cb87-26"><a href="#cb87-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-27"><a href="#cb87-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">useEffect</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb87-28"><a href="#cb87-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> initSync <span class="op">=</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb87-29"><a href="#cb87-29" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> shape <span class="op">=</span> <span class="cf">await</span> <span class="fu">createShape</span>(<span class="dv">1</span>)</span>
<span id="cb87-30"><a href="#cb87-30" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb87-31"><a href="#cb87-31" aria-hidden="true" tabindex="-1"></a>      shape<span class="op">.</span><span class="fu">subscribe</span>((messages) <span class="kw">=&gt;</span> {</span>
<span id="cb87-32"><a href="#cb87-32" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Apply changes to local state</span></span>
<span id="cb87-33"><a href="#cb87-33" aria-hidden="true" tabindex="-1"></a>        messages<span class="op">.</span><span class="fu">forEach</span>(msg <span class="kw">=&gt;</span> {</span>
<span id="cb87-34"><a href="#cb87-34" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (msg<span class="op">.</span><span class="at">headers</span><span class="op">.</span><span class="at">operation</span> <span class="op">===</span> <span class="st">&#39;insert&#39;</span>) {</span>
<span id="cb87-35"><a href="#cb87-35" aria-hidden="true" tabindex="-1"></a>            <span class="fu">setBarcodes</span>(prev <span class="kw">=&gt;</span> [<span class="op">...</span>prev<span class="op">,</span> msg<span class="op">.</span><span class="at">value</span>])</span>
<span id="cb87-36"><a href="#cb87-36" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> <span class="cf">if</span> (msg<span class="op">.</span><span class="at">headers</span><span class="op">.</span><span class="at">operation</span> <span class="op">===</span> <span class="st">&#39;update&#39;</span>) {</span>
<span id="cb87-37"><a href="#cb87-37" aria-hidden="true" tabindex="-1"></a>            <span class="fu">setBarcodes</span>(prev <span class="kw">=&gt;</span> </span>
<span id="cb87-38"><a href="#cb87-38" aria-hidden="true" tabindex="-1"></a>              prev<span class="op">.</span><span class="fu">map</span>(b <span class="kw">=&gt;</span> b<span class="op">.</span><span class="at">id</span> <span class="op">===</span> msg<span class="op">.</span><span class="at">value</span><span class="op">.</span><span class="at">id</span> <span class="op">?</span> msg<span class="op">.</span><span class="at">value</span> <span class="op">:</span> b)</span>
<span id="cb87-39"><a href="#cb87-39" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb87-40"><a href="#cb87-40" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb87-41"><a href="#cb87-41" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb87-42"><a href="#cb87-42" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb87-43"><a href="#cb87-43" aria-hidden="true" tabindex="-1"></a>        <span class="fu">setSyncStatus</span>(<span class="st">&#39;synced&#39;</span>)</span>
<span id="cb87-44"><a href="#cb87-44" aria-hidden="true" tabindex="-1"></a>        <span class="fu">setLastSync</span>(<span class="kw">new</span> <span class="bu">Date</span>())</span>
<span id="cb87-45"><a href="#cb87-45" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb87-46"><a href="#cb87-46" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb87-47"><a href="#cb87-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb87-48"><a href="#cb87-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">initSync</span>()</span>
<span id="cb87-49"><a href="#cb87-49" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span> [])</span>
<span id="cb87-50"><a href="#cb87-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-51"><a href="#cb87-51" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> (</span>
<span id="cb87-52"><a href="#cb87-52" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>div<span class="op">&gt;</span></span>
<span id="cb87-53"><a href="#cb87-53" aria-hidden="true" tabindex="-1"></a>      <span class="op">&lt;</span>h1<span class="op">&gt;</span>ElectricSQL POC<span class="op">&lt;/</span>h1<span class="op">&gt;</span></span>
<span id="cb87-54"><a href="#cb87-54" aria-hidden="true" tabindex="-1"></a>      <span class="op">&lt;</span>p<span class="op">&gt;</span>Status<span class="op">:</span> {syncStatus}<span class="op">&lt;/</span>p<span class="op">&gt;</span></span>
<span id="cb87-55"><a href="#cb87-55" aria-hidden="true" tabindex="-1"></a>      <span class="op">&lt;</span>p<span class="op">&gt;</span>Last sync<span class="op">:</span> {lastSync<span class="op">?.</span><span class="fu">toLocaleTimeString</span>()}<span class="op">&lt;/</span>p<span class="op">&gt;</span></span>
<span id="cb87-56"><a href="#cb87-56" aria-hidden="true" tabindex="-1"></a>      <span class="op">&lt;</span>p<span class="op">&gt;</span>Barcodes<span class="op">:</span> {barcodes<span class="op">.</span><span class="at">length</span>}<span class="op">&lt;/</span>p<span class="op">&gt;</span></span>
<span id="cb87-57"><a href="#cb87-57" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb87-58"><a href="#cb87-58" aria-hidden="true" tabindex="-1"></a>      <span class="op">&lt;</span>ul<span class="op">&gt;</span></span>
<span id="cb87-59"><a href="#cb87-59" aria-hidden="true" tabindex="-1"></a>        {barcodes<span class="op">.</span><span class="fu">slice</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">20</span>)<span class="op">.</span><span class="fu">map</span>(b <span class="kw">=&gt;</span> (</span>
<span id="cb87-60"><a href="#cb87-60" aria-hidden="true" tabindex="-1"></a>          <span class="op">&lt;</span>li key<span class="op">=</span>{b<span class="op">.</span><span class="at">id</span>}<span class="op">&gt;</span>{b<span class="op">.</span><span class="at">barcode</span>}<span class="op">&lt;/</span>li<span class="op">&gt;</span></span>
<span id="cb87-61"><a href="#cb87-61" aria-hidden="true" tabindex="-1"></a>        ))}</span>
<span id="cb87-62"><a href="#cb87-62" aria-hidden="true" tabindex="-1"></a>      <span class="op">&lt;/</span>ul<span class="op">&gt;</span></span>
<span id="cb87-63"><a href="#cb87-63" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb87-64"><a href="#cb87-64" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb87-65"><a href="#cb87-65" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<hr />
<h2 id="test-scenarios">4. Test Scenarios</h2>
<h3 id="initial-sync-test">4.1 Initial Sync Test</h3>
<pre><code>SCENARIO: First device sync
GIVEN: 10,000 barcodes in PostgreSQL
WHEN: Client connects to Electric
THEN: All 10,000 barcodes sync to client
EXPECTED: &lt; 60 seconds</code></pre>
<h3 id="real-time-sync-test">4.2 Real-time Sync Test</h3>
<pre><code>SCENARIO: Insert on one device, see on another
GIVEN: Two devices connected
WHEN: Device A inserts new barcode via PostgreSQL
THEN: Device B sees new barcode within 1 second</code></pre>
<h3 id="offline-write-test">4.3 Offline Write Test</h3>
<pre><code>SCENARIO: Write while offline
GIVEN: Device connected and synced
WHEN: 
  1. Disconnect network
  2. Update barcode note
  3. Reconnect network
THEN: 
  1. Local update succeeds immediately
  2. Update syncs to server on reconnect</code></pre>
<h3 id="conflict-test">4.4 Conflict Test</h3>
<pre><code>SCENARIO: Concurrent edits
GIVEN: Two devices with same barcode
WHEN:
  1. Both devices go offline
  2. Device A: note = &quot;QC OK&quot;
  3. Device B: note = &quot;Shipped&quot;
  4. Both reconnect
THEN:
  1. LWW resolves conflict (latest timestamp wins)
  2. Both devices show same final value</code></pre>
<hr />
<h2 id="performance-benchmarks">5. Performance Benchmarks</h2>
<h3 id="sync-speed">5.1 Sync Speed</h3>
<table>
<thead>
<tr>
<th>Data Volume</th>
<th>Expected Time</th>
<th>Actual Time</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>1,000 rows</td>
<td>&lt; 5 sec</td>
<td>TBD</td>
<td>⏳</td>
</tr>
<tr>
<td>10,000 rows</td>
<td>&lt; 60 sec</td>
<td>TBD</td>
<td>⏳</td>
</tr>
<tr>
<td>100,000 rows</td>
<td>&lt; 5 min</td>
<td>TBD</td>
<td>⏳</td>
</tr>
</tbody>
</table>
<h3 id="latency">5.2 Latency</h3>
<table>
<thead>
<tr>
<th>Operation</th>
<th>Expected</th>
<th>Actual</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>Local write</td>
<td>&lt; 10ms</td>
<td>TBD</td>
<td>⏳</td>
</tr>
<tr>
<td>Sync propagation</td>
<td>&lt; 500ms</td>
<td>TBD</td>
<td>⏳</td>
</tr>
<tr>
<td>Reconnection</td>
<td>&lt; 3 sec</td>
<td>TBD</td>
<td>⏳</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="run-poc">6. Run POC</h2>
<div class="sourceCode" id="cb92"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Start services</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="ex">docker-compose</span> <span class="at">-f</span> docker-compose.poc.yaml up <span class="at">-d</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Wait for Electric to connect</span></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> logs <span class="at">-f</span> electric</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Start client</span></span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> poc-client</span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> run dev</span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Open browser</span></span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a><span class="ex">open</span> http://localhost:5173</span></code></pre></div>
<hr />
<h2 id="poc-findings-template">7. POC Findings Template</h2>
<div class="sourceCode" id="cb93"><pre
class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">## POC Results</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a><span class="fu">### Date: ____</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a><span class="fu">### Success Criteria</span></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Criteria <span class="pp">|</span> Met <span class="pp">|</span> Notes <span class="pp">|</span></span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a><span class="pp">|----------|-----|-------|</span></span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Sync 10K in &lt; 60s <span class="pp">|</span> ☐ <span class="pp">|</span> <span class="pp">|</span></span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Offline writes work <span class="pp">|</span> ☐ <span class="pp">|</span> <span class="pp">|</span></span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Conflicts resolved <span class="pp">|</span> ☐ <span class="pp">|</span> <span class="pp">|</span></span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> No data loss <span class="pp">|</span> ☐ <span class="pp">|</span> <span class="pp">|</span></span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a><span class="fu">### Performance Results</span></span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-16"><a href="#cb93-16" aria-hidden="true" tabindex="-1"></a>Initial sync (10K rows): ____ seconds</span>
<span id="cb93-17"><a href="#cb93-17" aria-hidden="true" tabindex="-1"></a>Real-time propagation: ____ ms</span>
<span id="cb93-18"><a href="#cb93-18" aria-hidden="true" tabindex="-1"></a>Reconnection time: ____ seconds</span>
<span id="cb93-19"><a href="#cb93-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-20"><a href="#cb93-20" aria-hidden="true" tabindex="-1"></a><span class="fu">### Issues Found</span></span>
<span id="cb93-21"><a href="#cb93-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-22"><a href="#cb93-22" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>____</span>
<span id="cb93-23"><a href="#cb93-23" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>____</span>
<span id="cb93-24"><a href="#cb93-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-25"><a href="#cb93-25" aria-hidden="true" tabindex="-1"></a><span class="fu">### Recommendations</span></span>
<span id="cb93-26"><a href="#cb93-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-27"><a href="#cb93-27" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>____</span>
<span id="cb93-28"><a href="#cb93-28" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>____</span>
<span id="cb93-29"><a href="#cb93-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-30"><a href="#cb93-30" aria-hidden="true" tabindex="-1"></a><span class="fu">### Go/No-Go Decision</span></span>
<span id="cb93-31"><a href="#cb93-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-32"><a href="#cb93-32" aria-hidden="true" tabindex="-1"></a><span class="co">[ ]</span> GO - Proceed to Phase 1</span>
<span id="cb93-33"><a href="#cb93-33" aria-hidden="true" tabindex="-1"></a><span class="co">[ ]</span> NO-GO - Reason: ____</span></code></pre></div>
<h1 id="p2p-lan-sync">P2P / LAN Sync</h1>
<h2
id="device-to-device-synchronization-on-local-network">Device-to-Device
Synchronization on Local Network</h2>
<hr />
<h2 id="konsep-p2p-sync">1. Konsep P2P Sync</h2>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                    P2P SYNC CONCEPT                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  SCENARIO:                                                   │
│  • 2 operator di warehouse yang sama                        │
│  • Terhubung ke WiFi yang sama                              │
│  • Server/internet tidak stabil atau tidak ada              │
│  • Butuh sync antar device untuk pairing                    │
│                                                              │
│  SOLUTION: P2P SYNC via LAN                                  │
│                                                              │
│  ┌──────────┐      WiFi LAN       ┌──────────┐              │
│  │ Device A │◄──────────────────►│ Device B │              │
│  │ (Scan    │    Direct sync     │ (Scan    │              │
│  │  barcode)│    no server!      │  parent) │              │
│  └──────────┘                     └──────────┘              │
│                                                              │
│  HYBRID MODEL:                                               │
│  1. Primary: Sync via Electric (internet)                   │
│  2. Fallback: P2P sync via LAN (when offline)               │
│  3. Eventually: All sync to server when internet back       │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="use-cases">2. Use Cases</h2>
<h3 id="warehouse-pairing-scenario">2.1 Warehouse Pairing Scenario</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│              PAIRING USE CASE                                │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  SETUP:                                                      │
│  • Device A: Scan individual barcodes                       │
│  • Device B: Scan parent boxes                              │
│  • Both on same WiFi, internet slow/unavailable             │
│                                                              │
│  WORKFLOW:                                                   │
│  1. Device B scans Parent-001 (creates parent record)       │
│  2. P2P sync: Device A receives Parent-001                  │
│  3. Device A scans BC-001, pairs to Parent-001              │
│  4. P2P sync: Device B sees BC-001 paired                   │
│  5. Both devices have consistent view                       │
│  6. When internet back → both sync to server                │
│                                                              │
│  TIMELINE:                                                   │
│                                                              │
│  Device B    Device A    Server                              │
│     │           │           │                                │
│     │──(scan)──►│           │   P2P                         │
│     │◄──────────│           │   sync                        │
│     │           │──(scan)──►│                               │
│     │◄──────────│           │                               │
│     │           │           │                                │
│     │═══════════════════════│   Internet                    │
│     │           │           │   restored                    │
│     │──────────────────────►│                               │
│     │           │──────────►│                               │
│     │           │           │                                │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="field-operations">2.2 Field Operations</h3>
<pre><code>SCENARIO: Event/Exhibition venue
- No reliable internet
- 5 operators scanning products
- Need real-time inventory updates

P2P SOLUTION:
- One device acts as &quot;local hub&quot;
- Other devices sync to local hub
- Hub syncs to server when internet available</code></pre>
<hr />
<h2 id="technical-architecture">3. Technical Architecture</h2>
<h3 id="discovery-protocol">3.1 Discovery Protocol</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│              DEVICE DISCOVERY                                │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  OPTION A: mDNS/Bonjour (Recommended)                       │
│  ────────────────────────────────────                        │
│  • Standard protocol for LAN discovery                      │
│  • Works on iOS, Android, Desktop                           │
│  • No configuration needed                                  │
│                                                              │
│  Device A broadcasts:                                        │
│    _barcode-sync._tcp.local                                  │
│    Port: 8765                                                │
│    TXT: vendor=ABC, batch=123                               │
│                                                              │
│  Device B discovers:                                         │
│    &quot;Found device at 192.168.1.100:8765&quot;                     │
│    Same vendor? Same batch? → Connect                        │
│                                                              │
│  ─────────────────────────────────────────────               │
│                                                              │
│  OPTION B: Broadcast UDP                                     │
│  ────────────────────────                                    │
│  • Send discovery packet to 255.255.255.255                 │
│  • Simpler implementation                                   │
│  • May not work on some networks                            │
│                                                              │
│  ─────────────────────────────────────────────               │
│                                                              │
│  OPTION C: QR Code Pairing                                   │
│  ─────────────────────────                                   │
│  • Device A shows QR with IP:PORT                           │
│  • Device B scans QR to connect                             │
│  • Most reliable, no auto-discovery                         │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="sync-protocol">3.2 Sync Protocol</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│              P2P SYNC PROTOCOL                               │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  CONNECTION:                                                 │
│  • WebSocket over LAN                                       │
│  • TLS with self-signed cert (peer verification)            │
│  • JWT auth (same token as server)                          │
│                                                              │
│  SYNC FLOW:                                                  │
│                                                              │
│  1. HANDSHAKE                                                │
│     A → B: {type: &quot;hello&quot;, vendor: &quot;ABC&quot;, batch: 123,       │
│             checkpoint: &quot;abc123&quot;}                            │
│     B → A: {type: &quot;hello&quot;, vendor: &quot;ABC&quot;, batch: 123,       │
│             checkpoint: &quot;def456&quot;}                            │
│                                                              │
│  2. DELTA EXCHANGE                                           │
│     A → B: {type: &quot;ops&quot;, data: [CRDT ops since B&#39;s point]}  │
│     B → A: {type: &quot;ops&quot;, data: [CRDT ops since A&#39;s point]}  │
│                                                              │
│  3. CONTINUOUS SYNC                                          │
│     A → B: {type: &quot;op&quot;, table: &quot;bc_barcode&quot;,                │
│             operation: &quot;UPDATE&quot;, row: {...}}                 │
│     B → A: {type: &quot;ack&quot;, id: 123}                           │
│                                                              │
│  4. CONFLICT RESOLUTION                                      │
│     Same CRDT rules as server sync                          │
│     LWW for most fields                                     │
│     First-write-wins for pairing                            │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="mesh-network">3.3 Mesh Network</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│              MESH TOPOLOGY                                   │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  STAR (Simple):                MESH (Robust):                │
│                                                              │
│       B     C                   B ──── C                     │
│        \   /                    │\    /│                     │
│         \ /                     │ \  / │                     │
│          A (hub)                │  \/  │                     │
│         / \                     │  /\  │                     │
│        /   \                    │ /  \ │                     │
│       D     E                   D ──── E                     │
│                                                              │
│  Hub advantages:              Mesh advantages:               │
│  • Simple sync logic          • No single point of failure  │
│  • Lower bandwidth            • Any device can leave        │
│  • Easy to manage             • More resilient              │
│                                                              │
│  RECOMMENDATION: Star for &lt; 5 devices, Mesh for &gt; 5         │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="implementation-options">4. Implementation Options</h2>
<h3 id="technology-stack">4.1 Technology Stack</h3>
<table>
<thead>
<tr>
<th>Component</th>
<th>Option 1</th>
<th>Option 2</th>
<th>Recommendation</th>
</tr>
</thead>
<tbody>
<tr>
<td>Discovery</td>
<td>mDNS</td>
<td>QR Code</td>
<td>mDNS + QR fallback</td>
</tr>
<tr>
<td>Transport</td>
<td>WebSocket</td>
<td>WebRTC</td>
<td>WebSocket</td>
</tr>
<tr>
<td>Protocol</td>
<td>Custom CRDT</td>
<td>Y.js</td>
<td>Y.js (battle-tested)</td>
</tr>
<tr>
<td>Encryption</td>
<td>TLS</td>
<td>DTLS</td>
<td>TLS</td>
</tr>
</tbody>
</table>
<h3 id="y.js-based-implementation">4.2 Y.js Based Implementation</h3>
<div class="sourceCode" id="cb100"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co">// p2p-sync.ts</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="op">*</span> <span class="im">as</span> Y <span class="im">from</span> <span class="st">&#39;yjs&#39;</span></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { WebsocketProvider } <span class="im">from</span> <span class="st">&#39;y-websocket&#39;</span></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { IndexeddbPersistence } <span class="im">from</span> <span class="st">&#39;y-indexeddb&#39;</span></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Shared document for sync</span></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> ydoc <span class="op">=</span> <span class="kw">new</span> Y<span class="op">.</span><span class="fu">Doc</span>()</span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Local persistence</span></span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> persistence <span class="op">=</span> <span class="kw">new</span> <span class="fu">IndexeddbPersistence</span>(<span class="st">&#39;barcode-sync&#39;</span><span class="op">,</span> ydoc)</span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a><span class="co">// P2P connection (when peer discovered)</span></span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">connectToPeer</span>(peerUrl<span class="op">:</span> <span class="dt">string</span>) {</span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> wsProvider <span class="op">=</span> <span class="kw">new</span> <span class="fu">WebsocketProvider</span>(peerUrl<span class="op">,</span> <span class="st">&#39;barcode-room&#39;</span><span class="op">,</span> ydoc)</span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a>  wsProvider<span class="op">.</span><span class="fu">on</span>(<span class="st">&#39;sync&#39;</span><span class="op">,</span> (isSynced<span class="op">:</span> <span class="dt">boolean</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb100-17"><a href="#cb100-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (isSynced) {</span>
<span id="cb100-18"><a href="#cb100-18" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Synced with peer!&#39;</span>)</span>
<span id="cb100-19"><a href="#cb100-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb100-20"><a href="#cb100-20" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb100-21"><a href="#cb100-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb100-22"><a href="#cb100-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> wsProvider</span>
<span id="cb100-23"><a href="#cb100-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb100-24"><a href="#cb100-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-25"><a href="#cb100-25" aria-hidden="true" tabindex="-1"></a><span class="co">// Shared data structures</span></span>
<span id="cb100-26"><a href="#cb100-26" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> barcodes <span class="op">=</span> ydoc<span class="op">.</span><span class="fu">getMap</span>(<span class="st">&#39;barcodes&#39;</span>)</span>
<span id="cb100-27"><a href="#cb100-27" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> parents <span class="op">=</span> ydoc<span class="op">.</span><span class="fu">getMap</span>(<span class="st">&#39;parents&#39;</span>)</span>
<span id="cb100-28"><a href="#cb100-28" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> pairings <span class="op">=</span> ydoc<span class="op">.</span><span class="fu">getMap</span>(<span class="st">&#39;pairings&#39;</span>)</span>
<span id="cb100-29"><a href="#cb100-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-30"><a href="#cb100-30" aria-hidden="true" tabindex="-1"></a><span class="co">// Add barcode</span></span>
<span id="cb100-31"><a href="#cb100-31" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">addBarcode</span>(id<span class="op">:</span> <span class="dt">string</span><span class="op">,</span> data<span class="op">:</span> <span class="dt">any</span>) {</span>
<span id="cb100-32"><a href="#cb100-32" aria-hidden="true" tabindex="-1"></a>  barcodes<span class="op">.</span><span class="fu">set</span>(id<span class="op">,</span> data)</span>
<span id="cb100-33"><a href="#cb100-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb100-34"><a href="#cb100-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-35"><a href="#cb100-35" aria-hidden="true" tabindex="-1"></a><span class="co">// Pair barcode to parent (first-write-wins)</span></span>
<span id="cb100-36"><a href="#cb100-36" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">pairBarcode</span>(barcodeId<span class="op">:</span> <span class="dt">string</span><span class="op">,</span> parentId<span class="op">:</span> <span class="dt">string</span>) {</span>
<span id="cb100-37"><a href="#cb100-37" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> existing <span class="op">=</span> pairings<span class="op">.</span><span class="fu">get</span>(barcodeId)</span>
<span id="cb100-38"><a href="#cb100-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>existing) {</span>
<span id="cb100-39"><a href="#cb100-39" aria-hidden="true" tabindex="-1"></a>    pairings<span class="op">.</span><span class="fu">set</span>(barcodeId<span class="op">,</span> {</span>
<span id="cb100-40"><a href="#cb100-40" aria-hidden="true" tabindex="-1"></a>      parentId<span class="op">,</span></span>
<span id="cb100-41"><a href="#cb100-41" aria-hidden="true" tabindex="-1"></a>      pairedAt<span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="op">,</span></span>
<span id="cb100-42"><a href="#cb100-42" aria-hidden="true" tabindex="-1"></a>      pairedBy<span class="op">:</span> <span class="fu">getCurrentUserId</span>()</span>
<span id="cb100-43"><a href="#cb100-43" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb100-44"><a href="#cb100-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb100-45"><a href="#cb100-45" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb100-46"><a href="#cb100-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-47"><a href="#cb100-47" aria-hidden="true" tabindex="-1"></a><span class="co">// Listen for changes from peers</span></span>
<span id="cb100-48"><a href="#cb100-48" aria-hidden="true" tabindex="-1"></a>barcodes<span class="op">.</span><span class="fu">observe</span>(<span class="bu">event</span> <span class="kw">=&gt;</span> {</span>
<span id="cb100-49"><a href="#cb100-49" aria-hidden="true" tabindex="-1"></a>  <span class="bu">event</span><span class="op">.</span><span class="at">changes</span><span class="op">.</span><span class="fu">keys</span><span class="op">.</span><span class="fu">forEach</span>((change<span class="op">,</span> key) <span class="kw">=&gt;</span> {</span>
<span id="cb100-50"><a href="#cb100-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (change<span class="op">.</span><span class="at">action</span> <span class="op">===</span> <span class="st">&#39;add&#39;</span>) {</span>
<span id="cb100-51"><a href="#cb100-51" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`New barcode from peer: </span><span class="sc">${</span>key<span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb100-52"><a href="#cb100-52" aria-hidden="true" tabindex="-1"></a>      <span class="fu">updateUI</span>()</span>
<span id="cb100-53"><a href="#cb100-53" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb100-54"><a href="#cb100-54" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb100-55"><a href="#cb100-55" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<h3 id="webrtc-alternative">4.3 WebRTC Alternative</h3>
<div class="sourceCode" id="cb101"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="co">// For direct browser-to-browser (no local server needed)</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { WebrtcProvider } <span class="im">from</span> <span class="st">&#39;y-webrtc&#39;</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> provider <span class="op">=</span> <span class="kw">new</span> <span class="fu">WebrtcProvider</span>(<span class="st">&#39;barcode-room&#39;</span><span class="op">,</span> ydoc<span class="op">,</span> {</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>  signaling<span class="op">:</span> [<span class="st">&#39;wss://signaling.barcode-app.com&#39;</span>]<span class="op">,</span>  <span class="co">// Fallback</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// For LAN-only, use local signaling or ICE candidates</span></span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<hr />
<h2 id="security-considerations">5. Security Considerations</h2>
<h3 id="p2p-security-model">5.1 P2P Security Model</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│              P2P SECURITY                                    │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  AUTHENTICATION:                                             │
│  • Same JWT token required for P2P                          │
│  • Validate vendor_code matches                             │
│  • Validate batch assignment                                │
│                                                              │
│  AUTHORIZATION:                                              │
│  • Only sync data for shared batches                        │
│  • Cannot access other vendor&#39;s data                        │
│                                                              │
│  ENCRYPTION:                                                 │
│  • TLS for all P2P connections                              │
│  • Certificate pinning between known devices                │
│                                                              │
│  TRUST MODEL:                                                │
│  • Device must be registered with server first              │
│  • P2P only allowed for known device pairs                  │
│  • Server can revoke P2P capability remotely                │
│                                                              │
│  RISK MITIGATION:                                            │
│  • Audit log of all P2P syncs                               │
│  • Anomaly detection (unusual sync volume)                  │
│  • Time-limited P2P sessions (auto-disconnect)              │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="hybrid-sync-flow">6. Hybrid Sync Flow</h2>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│              HYBRID SYNC DECISION TREE                       │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  START                                                       │
│    │                                                         │
│    ▼                                                         │
│  ┌──────────────────┐                                       │
│  │ Internet         │                                       │
│  │ available?       │                                       │
│  └────────┬─────────┘                                       │
│           │                                                  │
│     YES   │   NO                                             │
│     ▼     │   ▼                                              │
│  ┌────────┴───┐  ┌────────────┐                             │
│  │ Sync via   │  │ Peers on   │                             │
│  │ Electric   │  │ same LAN?  │                             │
│  │ (primary)  │  └─────┬──────┘                             │
│  └────────────┘        │                                     │
│                   YES  │   NO                                │
│                   ▼    │   ▼                                 │
│            ┌──────┴────┐  ┌────────────┐                    │
│            │ P2P sync  │  │ Queue all  │                    │
│            │ via LAN   │  │ operations │                    │
│            └───────────┘  │ locally    │                    │
│                           └────────────┘                    │
│                                                              │
│  PRIORITY ORDER:                                             │
│  1. Internet → Electric (authoritative)                     │
│  2. LAN → P2P sync (temporary, merge later)                 │
│  3. Offline → Local queue (sync when possible)              │
│                                                              │
│  MERGE STRATEGY:                                             │
│  When internet returns:                                      │
│  1. P2P changes treated as &quot;local changes&quot;                  │
│  2. All merge to server via Electric                        │
│  3. CRDT handles any conflicts                              │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="uiux-for-p2p">7. UI/UX for P2P</h2>
<h3 id="p2p-status-indicator">7.1 P2P Status Indicator</h3>
<pre><code>┌──────────────────────────────────────────┐
│ ☰  Barcode Scanner                       │
├──────────────────────────────────────────┤
│                                          │
│  Sync Status:                            │
│  ┌────────────────────────────────────┐  │
│  │ 📶 Server: Offline                  │  │
│  │ 🔗 P2P: 2 devices connected         │  │
│  │    • Device-B (Dewi)                │  │
│  │    • Device-C (Budi)                │  │
│  └────────────────────────────────────┘  │
│                                          │
│  [Disconnect P2P] [Show QR to Connect]   │
│                                          │
└──────────────────────────────────────────┘</code></pre>
<h3 id="connection-flow">7.2 Connection Flow</h3>
<pre><code>Step 1: Discover
┌────────────────────────────┐
│ Looking for nearby devices │
│ 🔍 Scanning...             │
│                            │
│ Found:                     │
│ ○ Device-B (Dewi)          │
│ ○ Device-C (Budi)          │
│                            │
│ [Connect All] [Select]     │
└────────────────────────────┘

Step 2: Confirm
┌────────────────────────────┐
│ Connect to Device-B?       │
│                            │
│ Vendor: ABC                │
│ Batch: POC-001             │
│ User: Dewi                 │
│                            │
│ [Cancel] [Connect]         │
└────────────────────────────┘

Step 3: Connected
┌────────────────────────────┐
│ ✓ Connected to Device-B    │
│                            │
│ Syncing 150 items...       │
│ ████████░░░░░░ 60%         │
│                            │
└────────────────────────────┘</code></pre>
<hr />
<h2 id="implementation-phases">8. Implementation Phases</h2>
<table>
<thead>
<tr>
<th>Phase</th>
<th>Scope</th>
<th>Duration</th>
</tr>
</thead>
<tbody>
<tr>
<td>Phase 1</td>
<td>QR-based manual connection</td>
<td>Week 1</td>
</tr>
<tr>
<td>Phase 2</td>
<td>mDNS auto-discovery</td>
<td>Week 2</td>
</tr>
<tr>
<td>Phase 3</td>
<td>Y.js CRDT sync</td>
<td>Week 3</td>
</tr>
<tr>
<td>Phase 4</td>
<td>Hybrid Electric + P2P</td>
<td>Week 4</td>
</tr>
<tr>
<td>Phase 5</td>
<td>Testing &amp; hardening</td>
<td>Week 5</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="pros-cons">9. Pros &amp; Cons</h2>
<h3 id="advantages">Advantages</h3>
<ul>
<li>✅ Works without internet</li>
<li>✅ Lower latency (LAN is faster)</li>
<li>✅ Reduces server load</li>
<li>✅ Better UX for field operations</li>
</ul>
<h3 id="disadvantages">Disadvantages</h3>
<ul>
<li>❌ More complex implementation</li>
<li>❌ Security requires careful design</li>
<li>❌ Debugging harder with multiple sync paths</li>
<li>❌ Merge conflicts possible between P2P and server</li>
</ul>
<hr />
<h2 id="recommendation-1">10. Recommendation</h2>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                    RECOMMENDATION                            │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  PHASE 1 (MVP): Server-only sync (ElectricSQL)              │
│  • Get basic local-first working first                      │
│  • Validate CRDT approach                                   │
│                                                              │
│  PHASE 2 (v1.1): Add P2P as enhancement                     │
│  • After MVP stable, add P2P capability                     │
│  • Start with QR-based manual connection                    │
│  • Use Y.js for proven CRDT implementation                  │
│                                                              │
│  PHASE 3 (v1.2): Auto-discovery                             │
│  • mDNS for seamless device finding                         │
│  • Mesh network for larger teams                            │
│                                                              │
│  This staged approach:                                       │
│  • Reduces initial complexity                               │
│  • Allows learning from production usage                    │
│  • P2P builds on proven foundation                          │
│                                                              │
└─────────────────────────────────────────────────────────────┘</code></pre>
</body>
</html>
