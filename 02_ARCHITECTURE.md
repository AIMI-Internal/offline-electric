# System Architecture
## ElectricSQL Local-First Sync

---

## 1. Architecture Overview

### 1.1 High-Level System Design

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           PRODUCTION ENVIRONMENT                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                         DATA LAYER                                   │    │
│  │  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐            │    │
│  │  │ PostgreSQL  │────►│ Electric    │────►│ Redis       │            │    │
│  │  │ Primary     │ WAL │ Sync Engine │     │ Cache       │            │    │
│  │  │             │     │             │     │             │            │    │
│  │  └──────┬──────┘     └──────┬──────┘     └─────────────┘            │    │
│  │         │                   │                                        │    │
│  │         ▼                   │                                        │    │
│  │  ┌─────────────┐           │                                        │    │
│  │  │ PostgreSQL  │           │                                        │    │
│  │  │ Replica     │           │                                        │    │
│  │  └─────────────┘           │                                        │    │
│  └────────────────────────────┼────────────────────────────────────────┘    │
│                               │                                              │
│  ┌────────────────────────────┼────────────────────────────────────────┐    │
│  │                         API LAYER                                    │    │
│  │                            │                                         │    │
│  │  ┌─────────────┐     ┌─────┴─────┐     ┌─────────────┐              │    │
│  │  │ FastAPI     │     │ Electric  │     │ Auth        │              │    │
│  │  │ Backend     │     │ Proxy     │     │ Service     │              │    │
│  │  │ (REST)      │     │ (WS/HTTP) │     │ (JWT)       │              │    │
│  │  └─────────────┘     └─────┬─────┘     └─────────────┘              │    │
│  └────────────────────────────┼────────────────────────────────────────┘    │
│                               │                                              │
│  ┌────────────────────────────┼────────────────────────────────────────┐    │
│  │                      DELIVERY LAYER                                  │    │
│  │                            │                                         │    │
│  │  ┌─────────────┐     ┌─────┴─────┐     ┌─────────────┐              │    │
│  │  │ CDN         │     │ Load      │     │ API         │              │    │
│  │  │ (Static)    │     │ Balancer  │     │ Gateway     │              │    │
│  │  └─────────────┘     └───────────┘     └─────────────┘              │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ Internet
                                    │
┌─────────────────────────────────────────────────────────────────────────────┐
│                              CLIENT LAYER                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐           │
│  │   MOBILE APP    │   │   DESKTOP APP   │   │    WEB APP      │           │
│  │  (React Native) │   │   (Electron)    │   │   (Vue/React)   │           │
│  │                 │   │                 │   │                 │           │
│  │  ┌───────────┐  │   │  ┌───────────┐  │   │  ┌───────────┐  │           │
│  │  │ Electric  │  │   │  │ Electric  │  │   │  │ Electric  │  │           │
│  │  │ Client    │  │   │  │ Client    │  │   │  │ Client    │  │           │
│  │  └─────┬─────┘  │   │  └─────┬─────┘  │   │  └─────┬─────┘  │           │
│  │        │        │   │        │        │   │        │        │           │
│  │  ┌─────┴─────┐  │   │  ┌─────┴─────┐  │   │  ┌─────┴─────┐  │           │
│  │  │ SQLite    │  │   │  │ SQLite    │  │   │  │ IndexedDB │  │           │
│  │  │ (Local)   │  │   │  │ (Local)   │  │   │  │ (Local)   │  │           │
│  │  └───────────┘  │   │  └───────────┘  │   │  └───────────┘  │           │
│  └─────────────────┘   └─────────────────┘   └─────────────────┘           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Component Details

### 2.1 Electric Sync Engine

```
┌─────────────────────────────────────────────────────────────┐
│                    ELECTRIC SYNC ENGINE                      │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                  WAL CONSUMER                        │    │
│  │  • Reads PostgreSQL Write-Ahead Log                  │    │
│  │  • Captures INSERT, UPDATE, DELETE                   │    │
│  │  • Maintains replication slot                        │    │
│  └──────────────────────┬──────────────────────────────┘    │
│                         │                                    │
│                         ▼                                    │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                  SHAPE MANAGER                       │    │
│  │  • Defines data subsets for sync                     │    │
│  │  • Filters by vendor_code, batch_id                  │    │
│  │  • Manages shape subscriptions                       │    │
│  └──────────────────────┬──────────────────────────────┘    │
│                         │                                    │
│                         ▼                                    │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                  CRDT PROCESSOR                      │    │
│  │  • Converts SQL ops to CRDT operations               │    │
│  │  • Handles conflict detection                        │    │
│  │  • Generates merge operations                        │    │
│  └──────────────────────┬──────────────────────────────┘    │
│                         │                                    │
│                         ▼                                    │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                  SYNC DISPATCHER                     │    │
│  │  • WebSocket connections to clients                  │    │
│  │  • HTTP long-polling fallback                        │    │
│  │  • Batches and compresses payloads                   │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 Client Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    CLIENT APPLICATION                        │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                  UI LAYER                            │    │
│  │  • Barcode Scanner Component                         │    │
│  │  • Batch Management UI                               │    │
│  │  • Sync Status Indicator                             │    │
│  └──────────────────────┬──────────────────────────────┘    │
│                         │                                    │
│                         ▼                                    │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                  SYNC LAYER                          │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │    │
│  │  │ Electric    │  │ Offline     │  │ Conflict    │  │    │
│  │  │ Client SDK  │  │ Queue       │  │ Resolver    │  │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  │    │
│  └──────────────────────┬──────────────────────────────┘    │
│                         │                                    │
│                         ▼                                    │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                  DATA LAYER                          │    │
│  │  ┌─────────────────────────────────────────────┐    │    │
│  │  │              LOCAL DATABASE                  │    │    │
│  │  │  • SQLite (Mobile/Desktop)                   │    │    │
│  │  │  • IndexedDB (Web)                           │    │    │
│  │  │  • Encrypted at rest                         │    │    │
│  │  └─────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. Data Flow Diagrams

### 3.1 Initial Sync Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        INITIAL SYNC FLOW                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  CLIENT                    ELECTRIC                    POSTGRESQL        │
│    │                          │                            │             │
│    │  1. Connect + Auth       │                            │             │
│    │─────────────────────────►│                            │             │
│    │                          │                            │             │
│    │  2. Subscribe Shape      │                            │             │
│    │  (vendor_code=X)         │                            │             │
│    │─────────────────────────►│                            │             │
│    │                          │                            │             │
│    │                          │  3. Query Initial Data     │             │
│    │                          │───────────────────────────►│             │
│    │                          │                            │             │
│    │                          │  4. Return Rows (batched)  │             │
│    │                          │◄───────────────────────────│             │
│    │                          │                            │             │
│    │  5. Stream Data Chunks   │                            │             │
│    │◄─────────────────────────│                            │             │
│    │  (compressed, CRDT ops)  │                            │             │
│    │                          │                            │             │
│    │  6. Insert to Local DB   │                            │             │
│    │─────────┐                │                            │             │
│    │         │                │                            │             │
│    │◄────────┘                │                            │             │
│    │                          │                            │             │
│    │  7. Sync Complete        │                            │             │
│    │◄─────────────────────────│                            │             │
│    │                          │                            │             │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Real-time Sync Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       REAL-TIME SYNC FLOW                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  POSTGRESQL                 ELECTRIC                    CLIENT           │
│    │                          │                            │             │
│    │  1. INSERT/UPDATE row    │                            │             │
│    │─────────────────────────►│                            │             │
│    │  (via FastAPI backend)   │ (WAL capture)              │             │
│    │                          │                            │             │
│    │                          │  2. Check Shape Match      │             │
│    │                          │─────────┐                  │             │
│    │                          │         │                  │             │
│    │                          │◄────────┘                  │             │
│    │                          │                            │             │
│    │                          │  3. Push to Subscribers    │             │
│    │                          │───────────────────────────►│             │
│    │                          │  (WebSocket, CRDT op)      │             │
│    │                          │                            │             │
│    │                          │                            │  4. Apply   │
│    │                          │                            │  to Local   │
│    │                          │                            │─────────┐   │
│    │                          │                            │         │   │
│    │                          │                            │◄────────┘   │
│    │                          │                            │             │
│    │                          │  5. ACK                    │             │
│    │                          │◄───────────────────────────│             │
│    │                          │                            │             │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Offline → Online Sync Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    OFFLINE → ONLINE SYNC FLOW                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ═══════════════════════ OFFLINE PHASE ═══════════════════════          │
│                                                                          │
│  CLIENT (Offline)                                                        │
│    │                                                                     │
│    │  1. User scans barcode                                              │
│    │─────────┐                                                           │
│    │         │                                                           │
│    │  2. Write to local SQLite                                           │
│    │         │  + Add to pending_ops queue                               │
│    │◄────────┘                                                           │
│    │                                                                     │
│    │  3. User continues working offline...                               │
│    │  (All ops queued locally)                                           │
│    │                                                                     │
│                                                                          │
│  ═══════════════════════ COMES ONLINE ═══════════════════════           │
│                                                                          │
│  CLIENT                    ELECTRIC                    POSTGRESQL        │
│    │                          │                            │             │
│    │  4. Reconnect            │                            │             │
│    │─────────────────────────►│                            │             │
│    │                          │                            │             │
│    │  5. Pull server changes  │                            │             │
│    │◄─────────────────────────│                            │             │
│    │  (CRDT ops since last)   │                            │             │
│    │                          │                            │             │
│    │  6. CRDT Merge           │                            │             │
│    │  (local + remote)        │                            │             │
│    │─────────┐                │                            │             │
│    │         │                │                            │             │
│    │◄────────┘                │                            │             │
│    │                          │                            │             │
│    │  7. Push pending ops     │                            │             │
│    │─────────────────────────►│                            │             │
│    │                          │                            │             │
│    │                          │  8. Write to PostgreSQL    │             │
│    │                          │───────────────────────────►│             │
│    │                          │                            │             │
│    │  9. Confirm sync         │                            │             │
│    │◄─────────────────────────│                            │             │
│    │                          │                            │             │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Shape Definitions

### 4.1 Shape Strategy per Multi-Tenant

```
┌─────────────────────────────────────────────────────────────┐
│                    SHAPE DEFINITIONS                         │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  SHAPE 1: Vendor Master Data                                 │
│  ─────────────────────────────                               │
│  Tables: bc_batch, bc_mfg, bc_config                         │
│  Filter: vendor_code = :current_vendor                       │
│  Sync: Always, Full                                          │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  Shape ID: vendor_master_{vendor_code}              │    │
│  │  WHERE: vendor_code = 'VENDOR001'                   │    │
│  │         AND is_deleted = false                      │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  SHAPE 2: Active Batch Data                                  │
│  ──────────────────────────                                  │
│  Tables: bc_parent, bc_barcode, bc_token                     │
│  Filter: vendor_code + batch_id (active only)                │
│  Sync: On-demand per batch assignment                        │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  Shape ID: batch_data_{vendor_code}_{batch_id}      │    │
│  │  WHERE: vendor_code = 'VENDOR001'                   │    │
│  │         AND batch_id = 123                          │    │
│  │         AND is_deleted = false                      │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  SHAPE 3: Recent Pairing Logs                                │
│  ────────────────────────────                                │
│  Tables: bc_pair_brcdxparent, bc_inbound_pairing             │
│  Filter: vendor_code + created_at (last 7 days)              │
│  Sync: Background, incremental                               │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  Shape ID: pairing_logs_{vendor_code}               │    │
│  │  WHERE: vendor_code = 'VENDOR001'                   │    │
│  │         AND created_at > now() - interval '7 days'  │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 Shape Subscription Lifecycle

```
┌─────────────────────────────────────────────────────────────┐
│                SHAPE SUBSCRIPTION LIFECYCLE                  │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────┐     ┌──────────┐     ┌──────────┐             │
│  │  LOGIN   │────►│ SUBSCRIBE│────►│  ACTIVE  │             │
│  │          │     │  SHAPES  │     │          │             │
│  └──────────┘     └──────────┘     └─────┬────┘             │
│                                          │                   │
│                                          ▼                   │
│                              ┌───────────────────┐          │
│                              │                   │          │
│                              ▼                   │          │
│                   ┌──────────────────┐          │           │
│                   │  User switches   │          │           │
│                   │  to new batch    │          │           │
│                   └────────┬─────────┘          │           │
│                            │                     │           │
│                            ▼                     │           │
│                   ┌──────────────────┐          │           │
│                   │  Subscribe new   │          │           │
│                   │  batch shape     │          │           │
│                   └────────┬─────────┘          │           │
│                            │                     │           │
│                            └─────────────────────┘          │
│                                                              │
│  Note: Old shapes stay subscribed for quick switching        │
│        LRU eviction for memory management                    │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. Deployment Architecture

### 5.1 Infrastructure Stack

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       DEPLOYMENT ARCHITECTURE                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                        KUBERNETES CLUSTER                        │    │
│  │                                                                  │    │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │    │
│  │  │ Electric Pod    │  │ Electric Pod    │  │ Electric Pod    │  │    │
│  │  │ (Replica 1)     │  │ (Replica 2)     │  │ (Replica 3)     │  │    │
│  │  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘  │    │
│  │           │                    │                    │           │    │
│  │           └────────────────────┼────────────────────┘           │    │
│  │                                │                                 │    │
│  │                         ┌──────┴──────┐                         │    │
│  │                         │   Service   │                         │    │
│  │                         │ (ClusterIP) │                         │    │
│  │                         └──────┬──────┘                         │    │
│  │                                │                                 │    │
│  └────────────────────────────────┼────────────────────────────────┘    │
│                                   │                                      │
│  ┌────────────────────────────────┼────────────────────────────────┐    │
│  │                         LOAD BALANCER                            │    │
│  │  ┌─────────────────────────────────────────────────────────┐    │    │
│  │  │  • SSL Termination                                       │    │    │
│  │  │  • WebSocket Sticky Sessions                             │    │    │
│  │  │  • Health Checks                                         │    │    │
│  │  └─────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                        DATABASE LAYER                            │    │
│  │                                                                  │    │
│  │  ┌─────────────────┐              ┌─────────────────┐           │    │
│  │  │ PostgreSQL      │──────────────│ PostgreSQL      │           │    │
│  │  │ Primary         │  Streaming   │ Replica         │           │    │
│  │  │ (RDS/CloudSQL)  │  Replication │ (Read-only)     │           │    │
│  │  └─────────────────┘              └─────────────────┘           │    │
│  │                                                                  │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.2 Docker Compose (Development)

```yaml
# docker-compose.electric.yaml

version: '3.8'

services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_DB: barcode
      POSTGRES_USER: electric
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    command: 
      - "postgres"
      - "-c" 
      - "wal_level=logical"  # Required for Electric
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  electric:
    image: electricsql/electric:latest
    environment:
      DATABASE_URL: postgresql://electric:${DB_PASSWORD}@postgres:5432/barcode
      ELECTRIC_WRITE_TO_PG_MODE: direct_writes
      AUTH_MODE: secure
      AUTH_JWT_KEY: ${JWT_SECRET}
    ports:
      - "5133:5133"  # Electric HTTP API
      - "5433:5433"  # Electric Proxy (Postgres wire protocol)
    depends_on:
      - postgres

  fastapi:
    build: ./backend
    environment:
      DATABASE_URL: postgresql://app:${DB_PASSWORD}@postgres:5432/barcode
      ELECTRIC_URL: http://electric:5133
    ports:
      - "8000:8000"
    depends_on:
      - electric

volumes:
  postgres_data:
```

---

## 6. Network Architecture

### 6.1 Network Topology

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         NETWORK TOPOLOGY                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│                           INTERNET                                       │
│                              │                                           │
│                              ▼                                           │
│  ┌───────────────────────────────────────────────────────────────┐      │
│  │                      CDN / WAF                                 │      │
│  │  • CloudFlare / AWS CloudFront                                 │      │
│  │  • DDoS protection                                             │      │
│  │  • SSL/TLS termination                                         │      │
│  └───────────────────────────────────────────────────────────────┘      │
│                              │                                           │
│                              ▼                                           │
│  ┌───────────────────────────────────────────────────────────────┐      │
│  │                    VPC / Private Network                       │      │
│  │                                                                │      │
│  │  Public Subnet                                                 │      │
│  │  ┌─────────────────────────────────────────────────────┐      │      │
│  │  │  Load Balancer (ALB/NLB)                            │      │      │
│  │  │  • /api/* → FastAPI                                 │      │      │
│  │  │  • /v1/shape/* → Electric                           │      │      │
│  │  │  • WebSocket → Electric (sticky session)            │      │      │
│  │  └─────────────────────────────────────────────────────┘      │      │
│  │                              │                                 │      │
│  │  Private Subnet              │                                 │      │
│  │  ┌───────────────────────────┼───────────────────────┐        │      │
│  │  │                           │                       │        │      │
│  │  │  ┌─────────┐       ┌──────┴──────┐      ┌───────┐│        │      │
│  │  │  │ FastAPI │       │  Electric   │      │ Redis ││        │      │
│  │  │  │ Pods    │       │  Pods       │      │       ││        │      │
│  │  │  └─────────┘       └─────────────┘      └───────┘│        │      │
│  │  │                                                   │        │      │
│  │  └───────────────────────────────────────────────────┘        │      │
│  │                              │                                 │      │
│  │  Database Subnet             │                                 │      │
│  │  ┌───────────────────────────┼───────────────────────┐        │      │
│  │  │                           │                       │        │      │
│  │  │  ┌─────────────┐    ┌─────┴─────┐                │        │      │
│  │  │  │ PostgreSQL  │    │ PostgreSQL│                │        │      │
│  │  │  │ Primary     │───►│ Replica   │                │        │      │
│  │  │  └─────────────┘    └───────────┘                │        │      │
│  │  │                                                   │        │      │
│  │  └───────────────────────────────────────────────────┘        │      │
│  │                                                                │      │
│  └────────────────────────────────────────────────────────────────┘      │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 7. Monitoring Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    OBSERVABILITY STACK                       │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                    COLLECTION                        │    │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐             │    │
│  │  │ Metrics │  │ Logs    │  │ Traces  │             │    │
│  │  │ (Prom.) │  │ (Loki)  │  │ (Jaeger)│             │    │
│  │  └────┬────┘  └────┬────┘  └────┬────┘             │    │
│  └───────┼────────────┼────────────┼────────────────────┘    │
│          │            │            │                         │
│          ▼            ▼            ▼                         │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                    STORAGE                           │    │
│  │  ┌─────────────────────────────────────────────┐    │    │
│  │  │              Grafana Stack                   │    │    │
│  │  │  • Mimir (Metrics)                          │    │    │
│  │  │  • Loki (Logs)                              │    │    │
│  │  │  • Tempo (Traces)                           │    │    │
│  │  └─────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────┘    │
│                         │                                    │
│                         ▼                                    │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                  VISUALIZATION                       │    │
│  │  ┌─────────────────────────────────────────────┐    │    │
│  │  │              Grafana Dashboards              │    │    │
│  │  │  • Sync Performance                          │    │    │
│  │  │  • Error Rates                               │    │    │
│  │  │  • Client Connections                        │    │    │
│  │  │  • Database Health                           │    │    │
│  │  └─────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────┘    │
│                         │                                    │
│                         ▼                                    │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                    ALERTING                          │    │
│  │  • PagerDuty / OpsGenie                              │    │
│  │  • Slack / Telegram notifications                    │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

